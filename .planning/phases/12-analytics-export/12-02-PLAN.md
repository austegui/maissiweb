---
phase: 12-analytics-export
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/app/api/admin/analytics/route.ts
  - src/app/api/admin/analytics/export/route.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/admin/analytics?from=YYYY-MM-DD&to=YYYY-MM-DD returns JSON with kpis, volumeByDay, and agentBreakdown"
    - "GET /api/admin/analytics/export?from=YYYY-MM-DD&to=YYYY-MM-DD returns a downloadable CSV file"
    - "Both endpoints return 401 for unauthenticated users and 403 for non-admin users"
    - "Kapso conversations are paginated (loop with cursor) with a safety cap of 20 pages"
    - "CSV includes BOM prefix and quoted string fields for Excel compatibility"
  artifacts:
    - path: "src/app/api/admin/analytics/route.ts"
      provides: "GET handler returning analytics metrics JSON"
      exports: ["GET"]
    - path: "src/app/api/admin/analytics/export/route.ts"
      provides: "GET handler returning CSV download"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/admin/analytics/route.ts"
      to: "supabase.rpc('get_agent_stats')"
      via: "Supabase RPC call"
      pattern: "supabase\\.rpc\\('get_agent_stats'"
    - from: "src/app/api/admin/analytics/route.ts"
      to: "supabase.rpc('get_conversation_volume_by_day')"
      via: "Supabase RPC call"
      pattern: "supabase\\.rpc\\('get_conversation_volume_by_day'"
    - from: "src/app/api/admin/analytics/route.ts"
      to: "whatsappClient.conversations.list"
      via: "Kapso SDK for conversation data with date filters"
      pattern: "conversations\\.list"
    - from: "src/app/api/admin/analytics/export/route.ts"
      to: "whatsappClient.conversations.list"
      via: "Kapso SDK for CSV data source"
      pattern: "conversations\\.list"
---

<objective>
Create two admin-only API route handlers: one returning analytics metrics as JSON, and one generating a CSV export of conversation data.

Purpose: These endpoints serve the analytics dashboard (Plan 12-03) and CSV export feature. They combine Kapso SDK conversation data with Supabase RPC aggregations to compute KPIs, daily volume, and per-agent breakdowns. The export endpoint produces a downloadable CSV file with proper encoding for Spanish characters.

Output: Two Route Handlers under /api/admin/analytics/
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-export/12-RESEARCH.md
@src/lib/whatsapp-client.ts
@src/lib/supabase/server.ts
@src/app/api/conversations/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analytics metrics API route</name>
  <files>src/app/api/admin/analytics/route.ts</files>
  <action>
Create GET /api/admin/analytics that accepts `from` and `to` query params (ISO date strings, e.g., "2026-01-01") and returns JSON with three sections: kpis, volumeByDay, agentBreakdown.

**Auth guard (MUST implement -- layout.tsx guard does NOT cover API routes):**
1. Get user via `supabase.auth.getUser()`
2. If no user, return 401 `{ error: 'Unauthorized' }`
3. Query user_profiles for role. If not 'admin', return 403 `{ error: 'Forbidden' }`

**Data fetching:**

1. **Kapso conversations (paginated):** Loop through `client.conversations.list()` using `lastActiveSince: from`, `lastActiveUntil: to`, `limit: 100`, `after` cursor. Fields: `contact_name`, `messages_count`, `last_inbound_at`, `last_outbound_at`. Safety cap: 20 pages max (2000 conversations). Use `getWhatsAppClientWithPhone()` from `@/lib/whatsapp-client`.

2. **Supabase RPC calls (parallel with Promise.all):**
   - `supabase.rpc('get_conversation_volume_by_day', { from_date: fromISO, to_date: toISO })`
   - `supabase.rpc('get_agent_stats', { from_date: fromISO, to_date: toISO })`
   - Also fetch `user_profiles` (id, display_name) to map agent_id to names

**KPI computation from Kapso data:**
- `totalMessages`: Sum of `kapso.messagesCount` across all fetched conversations
- `totalConversations`: Count of fetched conversations
- `avgReplyTime`: For each conversation with both `kapso.lastInboundAt` and `kapso.lastOutboundAt` where outbound > inbound, compute `lastOutboundAt - lastInboundAt` in milliseconds. Average all valid deltas. Convert to minutes for display. If no valid deltas, return null. Label this "approximate" in the response.
- `resolvedCount`: Count from Supabase agent_stats (sum of resolved_count across agents)

**Response shape:**
```json
{
  "kpis": {
    "totalMessages": 1234,
    "totalConversations": 56,
    "avgReplyTimeMinutes": 12.5,
    "resolvedCount": 30
  },
  "volumeByDay": [
    { "day": "2026-01-15", "count": 23 }
  ],
  "agentBreakdown": [
    { "agentId": "uuid", "agentName": "Ana", "resolvedCount": 10, "totalCount": 20 }
  ]
}
```

Pass `from_date` and `to_date` to Supabase RPC as ISO timestamps: `${from}T00:00:00Z` and `${to}T23:59:59Z`.

Map agent_id to agentName via user_profiles lookup.

Wrap the entire handler in try/catch, returning 500 on unexpected errors.
  </action>
  <verify>
TypeScript compilation: `npx tsc --noEmit src/app/api/admin/analytics/route.ts` (or the project-wide check if that's the pattern). Verify the file exports a GET function. Verify auth guard is present (grep for 'role' and '403').
  </verify>
  <done>
GET /api/admin/analytics returns JSON with kpis, volumeByDay, and agentBreakdown. Unauthenticated requests get 401, non-admin requests get 403. Kapso pagination loops with 20-page safety cap.
  </done>
</task>

<task type="auto">
  <name>Task 2: CSV export API route</name>
  <files>src/app/api/admin/analytics/export/route.ts</files>
  <action>
Create GET /api/admin/analytics/export that accepts `from`, `to`, and optional `status` query params and returns a downloadable CSV file.

**Auth guard:** Same pattern as Task 1 -- check user auth + admin role, return 401/403.

**Data fetching:**
1. Fetch all Kapso conversations in date range with pagination loop (same as Task 1). Fields: `contact_name`, `messages_count`, `last_inbound_at`, `last_outbound_at`. Safety cap: 20 pages.
2. Enrich with Supabase metadata: fetch `conversation_metadata` (conversation_id, status, assigned_agent_id) for all conversation IDs, and `user_profiles` (id, display_name) for agent names. Use Promise.all for parallel fetching.
3. If `status` query param is provided, filter the enriched conversations by that status value (match against conversation_metadata status, defaulting to 'abierto' if no metadata row exists).

**CSV generation:**
- Header row: `Contact Name,Phone Number,Status,Assigned Agent,Message Count,Last Active`
- String fields (contact name, agent name) MUST be wrapped in double quotes. Escape internal double quotes by doubling them (`"` -> `""`). Use a helper: `const esc = (s: string) => '"' + s.replace(/"/g, '""') + '"'`
- Prepend UTF-8 BOM (`\uFEFF`) to the CSV string for Excel compatibility with Spanish characters (accents: Jose, Maria, etc.)
- Filename: `conversaciones-${from}-${to}.csv`

**Response:**
Return a `new Response(csv, { headers })` with:
- `Content-Type: text/csv; charset=utf-8`
- `Content-Disposition: attachment; filename="conversaciones-${from}-${to}.csv"`

Do NOT use NextResponse.json -- return raw Response with CSV body.
  </action>
  <verify>
TypeScript compilation check. Verify the file exports a GET function. Verify auth guard is present. Verify BOM character (`\uFEFF`) is prepended. Verify Content-Disposition header includes "attachment".
  </verify>
  <done>
GET /api/admin/analytics/export returns a CSV file download. File includes BOM for Excel, quoted string fields, and Content-Disposition attachment header. Auth guard rejects non-admins. Optional status filter works.
  </done>
</task>

</tasks>

<verification>
1. Both route files exist and export GET functions
2. Both routes have auth + admin role checks (401/403)
3. Analytics route returns JSON with kpis, volumeByDay, agentBreakdown
4. Export route returns text/csv with Content-Disposition: attachment
5. Both routes use pagination loop with safety cap for Kapso conversations
6. CSV has BOM prefix and quoted string fields
7. TypeScript compiles without errors
</verification>

<success_criteria>
Both API route handlers compile, implement admin-only auth guards, fetch paginated Kapso data joined with Supabase metadata, and return properly structured responses (JSON for analytics, CSV for export).
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-export/12-02-SUMMARY.md`
</output>
