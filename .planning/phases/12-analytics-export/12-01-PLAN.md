---
phase: 12-analytics-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "supabase.rpc('get_agent_stats', ...) returns rows with agent_id, resolved_count, total_count"
    - "supabase.rpc('get_conversation_volume_by_day', ...) returns rows with day, conversation_count"
  artifacts:
    - path: "Supabase SQL functions"
      provides: "get_agent_stats and get_conversation_volume_by_day Postgres functions"
  key_links:
    - from: "get_agent_stats function"
      to: "conversation_metadata table"
      via: "GROUP BY assigned_agent_id"
    - from: "get_conversation_volume_by_day function"
      to: "conversation_metadata table"
      via: "GROUP BY updated_at::date"
---

<objective>
Create two Supabase Postgres functions (get_agent_stats and get_conversation_volume_by_day) that provide GROUP BY aggregations needed by the analytics API routes.

Purpose: The Supabase JS client cannot do GROUP BY natively. These RPC functions compute per-agent stats and daily conversation volume at the database level, avoiding the anti-pattern of fetching all rows to Node.js for aggregation.

Output: Two Postgres functions callable via supabase.rpc()
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-export/12-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Supabase RPC functions for analytics aggregation</name>
  <action>
Run the following SQL in the Supabase Dashboard SQL Editor (https://supabase.com/dashboard â†’ SQL Editor):

```sql
-- Function 1: Per-agent statistics (resolved count and total count)
-- Used by analytics dashboard for agent breakdown section
create or replace function get_agent_stats(
  from_date timestamptz,
  to_date timestamptz
) returns table (
  agent_id uuid,
  resolved_count bigint,
  total_count bigint
) as $$
  select
    assigned_agent_id as agent_id,
    count(*) filter (where status = 'resuelto') as resolved_count,
    count(*) as total_count
  from conversation_metadata
  where updated_at >= from_date and updated_at <= to_date
    and assigned_agent_id is not null
  group by assigned_agent_id
$$ language sql stable security definer;

-- Function 2: Conversation volume by day
-- Used by analytics dashboard for the daily volume chart
create or replace function get_conversation_volume_by_day(
  from_date timestamptz,
  to_date timestamptz
) returns table (
  day date,
  conversation_count bigint
) as $$
  select
    updated_at::date as day,
    count(distinct conversation_id) as conversation_count
  from conversation_metadata
  where updated_at >= from_date and updated_at <= to_date
  group by updated_at::date
  order by day asc
$$ language sql stable security definer;
```

Both functions use `security definer` so they execute with the function owner's permissions (bypassing RLS), which is appropriate since they will only be called from authenticated admin API routes that verify the admin role before calling rpc().
  </action>
  <how-to-verify>
After running the SQL, verify both functions exist by running this query in the SQL Editor:

```sql
select routine_name from information_schema.routines
where routine_schema = 'public'
and routine_name in ('get_agent_stats', 'get_conversation_volume_by_day');
```

Expected result: 2 rows showing both function names.
  </how-to-verify>
  <resume-signal>Type "done" after running the SQL and confirming both functions exist</resume-signal>
</task>

</tasks>

<verification>
- Both functions exist in Supabase public schema
- get_agent_stats returns (agent_id uuid, resolved_count bigint, total_count bigint)
- get_conversation_volume_by_day returns (day date, conversation_count bigint)
</verification>

<success_criteria>
Both Supabase RPC functions are created and callable, ready for use in the analytics API routes.
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-export/12-01-SUMMARY.md`
</output>
