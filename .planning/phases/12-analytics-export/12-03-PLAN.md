---
phase: 12-analytics-export
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - src/app/admin/analytics/page.tsx
  - src/app/admin/analytics/AnalyticsDashboard.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Admin can view a dashboard with KPI cards, volume chart, and agent breakdown"
    - "Changing the date range preset re-fetches all data for the selected period"
    - "Admin can download a CSV export filtered by date range and optional status"
    - "Agent cannot access the analytics page (redirected by admin layout guard)"
    - "Charts render without ResizeObserver errors (fixed pixel heights on ResponsiveContainer)"
  artifacts:
    - path: "src/app/admin/analytics/page.tsx"
      provides: "Server component page with heading, agents list fetch, AnalyticsDashboard render"
      min_lines: 15
    - path: "src/app/admin/analytics/AnalyticsDashboard.tsx"
      provides: "Client component with date presets, KPI cards, Recharts charts, agent table, CSV export button"
      min_lines: 100
  key_links:
    - from: "src/app/admin/analytics/AnalyticsDashboard.tsx"
      to: "/api/admin/analytics"
      via: "fetch on mount and date range change"
      pattern: "fetch.*api/admin/analytics"
    - from: "src/app/admin/analytics/AnalyticsDashboard.tsx"
      to: "/api/admin/analytics/export"
      via: "fetch on export button click, trigger blob download"
      pattern: "api/admin/analytics/export"
    - from: "src/app/admin/analytics/page.tsx"
      to: "src/app/admin/analytics/AnalyticsDashboard.tsx"
      via: "import and render with agents prop"
      pattern: "AnalyticsDashboard"
---

<objective>
Build the analytics dashboard page with Recharts charts, KPI summary cards, per-agent breakdown table, date range preset buttons, and CSV export trigger.

Purpose: This is the user-facing UI for Phase 12. It gives admins operational visibility into message volume, response times, and team performance, plus the ability to export data for record-keeping.

Output: Admin analytics page at /admin/analytics with interactive charts and export functionality
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-export/12-RESEARCH.md
@.planning/phases/12-analytics-export/12-02-SUMMARY.md
@src/app/admin/layout.tsx
@src/app/admin/settings/page.tsx
@src/app/admin/labels/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and build analytics dashboard</name>
  <files>
    src/app/admin/analytics/page.tsx
    src/app/admin/analytics/AnalyticsDashboard.tsx
  </files>
  <action>
**Step 1: Install recharts**
Run `npm install recharts` to add the charting library.

**Step 2: Create the Server Component page**

Create `src/app/admin/analytics/page.tsx` as a Server Component. Admin guard is inherited from `/admin/layout.tsx` -- no additional auth check needed in the page itself.

- Fetch agents list from Supabase `user_profiles` (id, display_name) server-side
- Pass agents array as prop to AnalyticsDashboard
- Page structure: container with max-w-5xl, mx-auto, p-6, heading "Analiticas" (Spanish)

**Step 3: Create the Client Component dashboard**

Create `src/app/admin/analytics/AnalyticsDashboard.tsx` with `'use client'` directive. This is the main interactive component.

**Props:** `{ agents: Array<{ id: string; display_name: string }> }`

**State:**
- `dateRange: { from: string; to: string }` -- ISO date strings, default last 7 days
- `data: { kpis, volumeByDay, agentBreakdown } | null` -- fetched from API
- `loading: boolean` -- show skeleton/spinner during fetches
- `exporting: boolean` -- disable export button during download

**Date range presets (top of page):**
Three buttons: "7 dias", "30 dias", "90 dias". Use `date-fns` `subDays` and `format` (already installed). Clicking a preset updates dateRange state, which triggers re-fetch via useEffect.

**Data fetching:**
- useEffect that fires on dateRange change
- Fetch from `/api/admin/analytics?from=${dateRange.from}&to=${dateRange.to}`
- Set loading=true before fetch, loading=false after
- Parse JSON response and set data state

**KPI Summary Cards (3 cards in a row):**
Use a responsive grid: `grid grid-cols-1 md:grid-cols-3 gap-4 mb-6`. Each card:
- Rounded border, p-4, bg-white shadow-sm
- Label text (text-sm text-gray-500): "Mensajes Totales", "Tiempo de Respuesta Aprox.", "Conversaciones Resueltas"
- Value text (text-2xl font-bold): formatted number. For reply time, show in minutes with 1 decimal (e.g., "12.5 min") or "â€”" if null.
- Use lucide-react icons (already installed): MessageSquare, Clock, CheckCircle

**Message Volume Chart (line chart):**
- Section heading: "Volumen de Mensajes"
- Use Recharts `LineChart` with `ResponsiveContainer` wrapper
- `ResponsiveContainer` MUST use a fixed pixel height={300} (NOT "100%") to avoid ResizeObserver infinite loop
- XAxis dataKey="day", YAxis allowDecimals={false}
- Single Line for "count" with green stroke (#22c55e)
- CartesianGrid with strokeDasharray="3 3"
- Tooltip enabled
- If no data yet (loading), show a gray placeholder div with same height

**Per-Agent Breakdown (horizontal bar chart + table):**
- Section heading: "Rendimiento por Agente"
- Horizontal bar chart using Recharts `BarChart` with `layout="vertical"`
- `ResponsiveContainer` height = agentBreakdown.length * 50 (minimum 100px)
- Two bars: resolvedCount (green #22c55e, label "Resueltas") and totalCount (gray #94a3b8, label "Total")
- YAxis dataKey="agentName", XAxis type="number"
- Below the chart: HTML table with columns: Agente, Resueltas, Total, % Resueltas
  - Sortable by any column (click header to toggle asc/desc). Use simple state: `sortBy` and `sortDir`
  - % Resueltas = (resolvedCount / totalCount * 100).toFixed(0) + "%", handle division by zero

**CSV Export Section (bottom):**
- Section heading: "Exportar Datos"
- Row with optional status filter: `<select>` with options: Todos, Abierto, Pendiente, Resuelto (values: '', 'abierto', 'pendiente', 'resuelto')
- Export button: "Descargar CSV" with Download icon from lucide-react
- On click: fetch `/api/admin/analytics/export?from=${dateRange.from}&to=${dateRange.to}&status=${statusFilter}`
- Convert response to blob, create object URL, trigger download via hidden `<a>` element click, revoke URL
- Disable button and show "Exportando..." text while exporting=true

**Add navigation link:**
Add a link to "Analiticas" in the admin navigation. Check how Settings and Labels pages are linked. If there's a shared admin nav component, add to it. If each page has its own back link, add a consistent link. Check `src/app/admin/settings/page.tsx` and `src/app/admin/labels/page.tsx` for the pattern, and follow the same pattern for the analytics page.

**Styling notes:**
- Follow existing codebase Tailwind patterns (check admin settings and labels pages for reference)
- Use consistent spacing, font sizes, and color palette
- Empty states: Show "Sin datos para este periodo" if volumeByDay is empty
- Loading state: Show a subtle loading indicator (opacity-50 on chart areas or skeleton divs)
  </action>
  <verify>
1. `npm run build` succeeds (verifies TypeScript compilation and Next.js build)
2. Verify recharts is in package.json dependencies
3. Verify both files exist: page.tsx and AnalyticsDashboard.tsx
4. Verify AnalyticsDashboard.tsx has 'use client' directive
5. Verify ResponsiveContainer uses fixed pixel height (grep for `height={` not `height="100%"`)
6. Verify fetch calls to /api/admin/analytics and /api/admin/analytics/export are present
  </verify>
  <done>
Analytics page exists at /admin/analytics with 3 KPI cards, a line chart for daily volume, a horizontal bar chart for agent comparison, a sortable agent table, date range preset buttons, and a CSV export section with status filter.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify analytics dashboard on Vercel</name>
  <what-built>
Complete analytics dashboard with:
- 3 KPI summary cards (Total Messages, Avg Reply Time, Conversations Resolved)
- Message volume line chart (daily)
- Per-agent horizontal bar chart + sortable data table
- Date range preset buttons (7d, 30d, 90d)
- CSV export with status filter and download button
- Admin-only access (inherited from admin layout guard)
  </what-built>
  <how-to-verify>
1. Visit https://maissiweb.vercel.app/admin/analytics (logged in as admin)
2. Verify 3 KPI cards show numbers at the top
3. Click "30 dias" preset -- data should refresh, chart should update
4. Scroll to per-agent breakdown -- horizontal bars visible with agent names
5. Check sortable table -- click "Resueltas" header to sort
6. In export section, select "Abierto" from status dropdown, click "Descargar CSV"
7. Open the downloaded CSV in Excel -- verify Spanish characters display correctly (accents)
8. Log in as agent (non-admin) and visit /admin/analytics -- should redirect to inbox
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. recharts is installed in package.json
2. /admin/analytics page renders with KPI cards, charts, and export section
3. Date range presets trigger data re-fetch
4. CSV download works with proper encoding (BOM for Excel)
5. Agent table is sortable
6. Non-admin users cannot access the page
7. No ResizeObserver errors in console (fixed pixel heights)
8. Build succeeds without TypeScript errors
</verification>

<success_criteria>
Admin can view the analytics dashboard at /admin/analytics showing message volume, response time, and per-agent performance. Admin can export conversation data as CSV filtered by date range and status. Agents cannot access the page.
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-export/12-03-SUMMARY.md`
</output>
