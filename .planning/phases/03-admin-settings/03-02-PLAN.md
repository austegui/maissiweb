---
phase: 03-admin-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/admin/settings/page.tsx
  - src/app/admin/settings/actions.ts
  - src/app/admin/settings/SettingsForm.tsx
autonomous: true

must_haves:
  truths:
    - "Navigating to /admin/settings shows the current credential values from the database"
    - "The API key is displayed as masked (last 4 characters only)"
    - "Submitting the form saves credentials to the app_settings table via Server Action"
    - "Leaving the API key field blank preserves the existing value (does not overwrite with empty string)"
    - "A success or error message appears after form submission"
    - "WHATSAPP_API_URL is optional — blank value is not written to DB"
  artifacts:
    - path: "src/app/admin/settings/page.tsx"
      provides: "Server Component that reads settings from Supabase and renders SettingsForm"
    - path: "src/app/admin/settings/actions.ts"
      provides: "saveSettings Server Action with auth check and upsert"
      exports: ["saveSettings"]
    - path: "src/app/admin/settings/SettingsForm.tsx"
      provides: "Client Component form with useActionState"
      exports: ["SettingsForm"]
  key_links:
    - from: "src/app/admin/settings/page.tsx"
      to: "app_settings table"
      via: "createClient() direct DB query in Server Component"
      pattern: "supabase\\.from\\('app_settings'\\)\\.select"
    - from: "src/app/admin/settings/SettingsForm.tsx"
      to: "src/app/admin/settings/actions.ts"
      via: "useActionState(saveSettings, initialState)"
      pattern: "useActionState\\(saveSettings"
    - from: "src/app/admin/settings/actions.ts"
      to: "app_settings table"
      via: "createClient() upsert in Server Action"
      pattern: "\\.upsert\\(.*onConflict.*'key'"
---

<objective>
Build the /admin/settings page with a Server Component, Client Component form, and Server Action for saving credentials.

Purpose: This is the user-facing settings page where the admin views current credential values and updates them through a form. The Server Component reads directly from Supabase (no internal API fetch). The Client Component uses React 19 useActionState for form submission via a Server Action.

Output: Three new files — page.tsx (Server Component), actions.ts (Server Action), SettingsForm.tsx (Client Component form)
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-settings/03-RESEARCH.md
@src/lib/supabase/server.ts
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action and Server Component page</name>
  <files>src/app/admin/settings/actions.ts, src/app/admin/settings/page.tsx</files>
  <action>
**File 1: src/app/admin/settings/actions.ts**

Create a Server Action file with 'use server' directive:

1. Define type SaveResult = { success: boolean; message: string }

2. Export async function saveSettings(_prevState: SaveResult, formData: FormData): Promise<SaveResult>
   - The first param is _prevState (required by useActionState contract — prefix with underscore)
   - Extract from formData: kapsoApiKey, phoneNumberId, wabaId, whatsappApiUrl (all as string)
   - Server-side validation: if kapsoApiKey is empty AND there is no existing value, return error. But since the form uses placeholder (not defaultValue) for API key, empty means "keep current". So: if kapsoApiKey is non-empty, include it in updates. If empty, skip it.
   - Build updates array of { key, value } objects:
     - Always include: { key: 'PHONE_NUMBER_ID', value: phoneNumberId.trim() }
     - Always include: { key: 'WABA_ID', value: wabaId.trim() }
     - Conditionally include KAPSO_API_KEY: only if kapsoApiKey.trim() is non-empty
     - Conditionally include WHATSAPP_API_URL: only if whatsappApiUrl.trim() is non-empty (research pitfall #6 — blank means "use default fallback", don't write empty string to DB)
   - If updates array is empty, return { success: false, message: 'No changes to save' }
   - Call createClient() from @/lib/supabase/server
   - Auth check: supabase.auth.getUser() — if !user, return { success: false, message: 'Unauthorized' }
   - Upsert: supabase.from('app_settings').upsert(updates, { onConflict: 'key' })
   - If error, return { success: false, message: `Save failed: ${error.message}` }
   - Call revalidatePath('/admin/settings') — from next/cache
   - Return { success: true, message: 'Settings saved successfully' }

**File 2: src/app/admin/settings/page.tsx**

Create a Server Component (NO 'use client' directive):

1. Import createClient from @/lib/supabase/server
2. Import SettingsForm from './SettingsForm' (will be created in Task 2)
3. Export default async function SettingsPage()
4. Call createClient(), query: supabase.from('app_settings').select('key, value')
5. Build a settings lookup map: Record<string, string> from the rows
6. Render a container div with:
   - A header section with "Settings" title and a link back to "/" (the inbox)
   - The SettingsForm component, passing props:
     - kapsoApiKey={settings['KAPSO_API_KEY'] ?? ''}
     - phoneNumberId={settings['PHONE_NUMBER_ID'] ?? ''}
     - wabaId={settings['WABA_ID'] ?? ''}
     - whatsappApiUrl={settings['WHATSAPP_API_URL'] ?? ''}

Style the page with Tailwind classes matching the existing app aesthetic:
- Use a max-w-lg container centered with mx-auto, p-6 padding
- Header: text-lg font-semibold, with a text-sm text-gray-500 back link
- Clean spacing between sections
  </action>
  <verify>
Both files exist. actions.ts has 'use server' directive, exports saveSettings with correct signature (_prevState, formData). page.tsx is an async Server Component (no 'use client'), imports createClient and SettingsForm, queries app_settings directly.
  </verify>
  <done>Server Action handles conditional upsert (skips blank API key and blank WHATSAPP_API_URL). Server Component reads settings directly from Supabase and passes them to the form.</done>
</task>

<task type="auto">
  <name>Task 2: Create SettingsForm Client Component</name>
  <files>src/app/admin/settings/SettingsForm.tsx</files>
  <action>
Create src/app/admin/settings/SettingsForm.tsx with 'use client' directive:

1. Import useActionState from 'react'
2. Import saveSettings from './actions'

3. Define props type: { kapsoApiKey: string; phoneNumberId: string; wabaId: string; whatsappApiUrl: string }

4. Define initialState: { success: false, message: '' }

5. Inside the component:
   - const [state, formAction, pending] = useActionState(saveSettings, initialState)
   - Compute masked API key for display:
     - If kapsoApiKey.length > 4: show bullet characters + last 4 chars
     - maskedApiKey = kapsoApiKey.length > 4 ? '•'.repeat(Math.min(kapsoApiKey.length - 4, 12)) + kapsoApiKey.slice(-4) : kapsoApiKey
     - If kapsoApiKey is empty, maskedApiKey = 'Not set'

6. Render a form with action={formAction}:

   **KAPSO API Key field:**
   - Label: "API Key" with a span showing "(current: {maskedApiKey})" in text-gray-400 text-xs
   - Input: name="kapsoApiKey", type="password", placeholder="Enter new value to update (leave blank to keep current)"
   - CRITICAL: Use placeholder, NOT defaultValue. If defaultValue is used, the masked/real value gets submitted on save and could corrupt the key. Empty submission = keep current.

   **Phone Number ID field:**
   - Label: "Phone Number ID"
   - Input: name="phoneNumberId", type="text", defaultValue={phoneNumberId}

   **WABA ID field:**
   - Label: "WABA ID"
   - Input: name="wabaId", type="text", defaultValue={wabaId}

   **WhatsApp API URL field (optional):**
   - Label: "WhatsApp API URL" with a span "(optional)" in text-gray-400 text-xs
   - Input: name="whatsappApiUrl", type="text", placeholder="Default: https://api.kapso.ai/meta/whatsapp", defaultValue={whatsappApiUrl}
   - This field is optional. If blank, the Server Action skips upserting it.

   **Submit button:**
   - disabled={pending}
   - Text: pending ? 'Saving...' : 'Save Settings'

   **Status message:**
   - Show state.message if truthy
   - Use green text (text-green-600) for success, red text (text-red-600) for error
   - Determine color via state.success boolean

7. Style with Tailwind:
   - Form: space-y-4
   - Labels: block text-sm font-medium text-gray-700 mb-1
   - Inputs: w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
   - Button: bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed
   - Match the minimal aesthetic of the existing inbox UI (see src/app/page.tsx for reference — simple Tailwind, no complex design system)
  </action>
  <verify>
File exists at src/app/admin/settings/SettingsForm.tsx. Has 'use client' directive. Contains: useActionState import from 'react', saveSettings import, form with action={formAction}, input name="kapsoApiKey" with type="password" and placeholder (NOT defaultValue), pending state on button, success/error message display.
  </verify>
  <done>Client Component renders a 4-field form (API key with placeholder-only pattern, Phone Number ID, WABA ID, optional WhatsApp API URL). Uses useActionState for submission state. Masked API key shown as label hint. Success/error feedback displayed.</done>
</task>

</tasks>

<verification>
1. src/app/admin/settings/page.tsx exists as an async Server Component (no 'use client')
2. src/app/admin/settings/actions.ts has 'use server' directive and exports saveSettings
3. src/app/admin/settings/SettingsForm.tsx has 'use client' directive and uses useActionState
4. API key input uses placeholder (not defaultValue) — prevents masked value corruption
5. saveSettings skips KAPSO_API_KEY upsert when blank (preserves existing value)
6. saveSettings skips WHATSAPP_API_URL upsert when blank (preserves env fallback)
7. saveSettings uses upsert with { onConflict: 'key' }
8. saveSettings calls getUser() for auth check (not getSession())
9. saveSettings calls revalidatePath('/admin/settings') after successful save
10. No TypeScript compilation errors
</verification>

<success_criteria>
- /admin/settings page renders with current credential values from the database
- API key is displayed as masked (last 4 characters only, or "Not set")
- Form submission saves to app_settings table via Server Action
- Blank API key field preserves existing value
- Blank WHATSAPP_API_URL field is not written to DB
- Success and error messages display after form submission
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-settings/03-02-SUMMARY.md`
</output>
