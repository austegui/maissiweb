---
phase: 11-notifications-real-time
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/hooks/use-message-alerts.ts
  - src/components/notification-toggle.tsx
  - src/app/api/user/preferences/route.ts
  - src/app/page.tsx
  - src/hooks/use-handoff-alerts.ts
autonomous: true

must_haves:
  truths:
    - "An audio chime plays when a new inbound message arrives for an unassigned or assigned-to-me conversation"
    - "Sound does not play for messages the agent themselves just sent"
    - "A browser notification with contact name and message preview appears when the tab is not focused"
    - "A notification toggle in the header persists the preference to the database and controls both sound and browser notifications"
    - "Rapid inbound messages do not cause repeated chimes (3-second cooldown)"
    - "Handoff visual treatment (amber border + badge) is preserved unchanged"
  artifacts:
    - path: "src/hooks/use-message-alerts.ts"
      provides: "General inbound message alert hook with chime sound, browser notifications, cooldown, scope filtering, and own-message suppression"
      exports: ["useMessageAlerts"]
    - path: "src/components/notification-toggle.tsx"
      provides: "Bell icon toggle for notification preference in header"
      exports: ["NotificationToggle"]
    - path: "src/app/api/user/preferences/route.ts"
      provides: "GET and PATCH endpoints for user notification preference"
      exports: ["GET", "PATCH"]
  key_links:
    - from: "src/app/page.tsx"
      to: "src/hooks/use-message-alerts.ts"
      via: "useMessageAlerts hook call"
      pattern: "useMessageAlerts"
    - from: "src/components/notification-toggle.tsx"
      to: "/api/user/preferences"
      via: "fetch PATCH call"
      pattern: "fetch.*api/user/preferences"
    - from: "src/hooks/use-message-alerts.ts"
      to: "use-handoff-alerts.ts alertingIds"
      via: "handoff visual treatment preserved separately"
      pattern: "alertingIds"
---

<objective>
Build the complete inbound message alert system: a chime sound + browser notification hook that replaces the raw beep in use-handoff-alerts, a notification toggle component for the header, a preferences API endpoint, and integration into page.tsx.

Purpose: Agents never miss a new inbound message. Sound + browser notifications fire for unassigned and assigned-to-me conversations, suppressed for own-sent messages and other agents' conversations.
Output: Working alert system with persistent per-user toggle, integrated into the inbox.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-notifications-real-time/11-RESEARCH.md
@src/hooks/use-handoff-alerts.ts
@src/app/page.tsx
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create message alerts hook, notification toggle, and preferences API</name>
  <files>
    src/hooks/use-message-alerts.ts
    src/components/notification-toggle.tsx
    src/app/api/user/preferences/route.ts
  </files>
  <action>
    **1. Install @radix-ui/react-switch:**
    ```bash
    npm install @radix-ui/react-switch
    ```

    **2. Create `src/hooks/use-message-alerts.ts`:**

    This hook replaces the SOUND and BROWSER NOTIFICATION logic of `use-handoff-alerts.ts` for general inbound messages. It does NOT replace the handoff visual treatment (alertingIds / amber border) — that stays in `use-handoff-alerts.ts`.

    Interface:
    ```typescript
    type UseMessageAlertsOptions = {
      notificationsEnabled: boolean;
      currentUserId?: string;
    };

    type UseMessageAlertsReturn = {
      onConversationsUpdated: (conversations: ConversationData[]) => void;
      markSentMessage: () => void;  // called when agent sends a message
    };
    ```

    Implementation details:
    - **Chime sound**: Use Web Audio API to synthesize a two-note ascending chime (C6 at 1046.50Hz + E6 at 1318.51Hz, sine wave, exponential decay). Create `AudioContext` lazily. Call `audioCtx.resume()` before playing. See Research Pattern 5 for exact note timing.
    - **Alert scope**: Only alert when `conv.lastMessage.direction === 'inbound'` AND (`conv.assignedAgentId` is null/undefined OR `conv.assignedAgentId === currentUserId`). Skip other agents' conversations.
    - **Own-sent suppression (NOTIF-04)**: Track `lastSentAtRef = useRef(0)`. The `markSentMessage()` sets it to `Date.now()`. In `onConversationsUpdated`, skip alert if `Date.now() - lastSentAtRef.current < 5000`.
    - **New message detection**: Track `prevLastActiveMapRef = useRef<Map<string, string>>()` mapping `conversationId -> lastActiveAt`. An alert fires only when a conversation's `lastActiveAt` is NEWER than previously seen AND the `lastMessage.direction` is `'inbound'`.
    - **Cooldown**: Track `lastChimeAtRef = useRef(0)`. Skip chime if `Date.now() - lastChimeAtRef.current < 3000`. Browser notification still fires (no cooldown on those).
    - **Browser notification**: If `document.hidden` is true and `Notification.permission === 'granted'`, show a browser notification with title `"${contactName || phoneNumber}: ${lastMessage.content.slice(0, 60)}"`, icon `/favicon.ico`, tag `message-${conv.id}`. On click: `window.focus()` + `notification.close()`.
    - **Permission request**: On mount, attach one-time `click`/`keydown` event listeners to request `Notification.requestPermission()` if permission is `'default'`. Same pattern as existing `use-handoff-alerts.ts`.
    - **Enabled gate**: If `notificationsEnabled` is false, skip both chime and browser notification entirely. Still track `prevLastActiveMapRef` so toggling ON later doesn't trigger alerts for all existing conversations.
    - Do NOT remove or modify the handoff detection logic. The `useHandoffAlerts` hook stays as-is for the amber border + badge visual.

    **3. Create `src/app/api/user/preferences/route.ts`:**

    Two handlers:
    - `GET`: Read current user via `supabase.auth.getUser()`, query `user_profiles` for `notifications_enabled`, return `{ notifications_enabled: boolean }`. If no row found, return `{ notifications_enabled: true }` (default).
    - `PATCH`: Read body `{ notifications_enabled: boolean }`, validate it's a boolean, update `user_profiles` row for current user, return updated value. Use server-side Supabase client (`createClient` from `@/lib/supabase/server`).

    Both handlers: return 401 if no user session. Use the same pattern as existing API routes (e.g., `src/app/api/contacts/[phone]/route.ts`).

    **4. Create `src/components/notification-toggle.tsx`:**

    A small bell icon button for the header. Two visual states:
    - Enabled: Filled bell icon (lucide `Bell`), text-green-500
    - Disabled: Outlined bell icon (lucide `BellOff`), text-gray-400

    On click:
    - Optimistically toggle local state
    - Call `PATCH /api/user/preferences` with the new value
    - On error, revert to previous state

    Props: `{ enabled: boolean; onToggle: (value: boolean) => void }`.

    Note: Use lucide icons (Bell, BellOff) instead of @radix-ui/react-switch since a header icon toggle is more compact. The Radix Switch install can be skipped if not needed elsewhere — use a simple button with icon swap. Actually, skip the @radix-ui/react-switch install entirely. A bell icon toggle is the right UX for the header.
  </action>
  <verify>
    - `src/hooks/use-message-alerts.ts` exports `useMessageAlerts`
    - `src/components/notification-toggle.tsx` exports `NotificationToggle`
    - `src/app/api/user/preferences/route.ts` exports `GET` and `PATCH`
    - No TypeScript errors: `npx tsc --noEmit` passes (or at least these 3 files have no errors)
    - `npm run build` succeeds
  </verify>
  <done>Three new files created: the alert hook with chime + browser notifications + scope filtering + cooldown + own-sent suppression, the notification toggle component, and the preferences API endpoint.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate alerts and toggle into page.tsx</name>
  <files>
    src/app/page.tsx
    src/hooks/use-handoff-alerts.ts
  </files>
  <action>
    **1. Update `src/app/page.tsx`:**

    - Import `useMessageAlerts` from `@/hooks/use-message-alerts`
    - Import `NotificationToggle` from `@/components/notification-toggle`
    - Add state: `const [notificationsEnabled, setNotificationsEnabled] = useState(true);`
    - Fetch preference on mount: `useEffect` that calls `GET /api/user/preferences` and sets `notificationsEnabled` from response.
    - Initialize `useMessageAlerts`: `const { onConversationsUpdated: onMessageAlert, markSentMessage } = useMessageAlerts({ notificationsEnabled, currentUserId });`
    - In `handleConversationsLoaded`, call BOTH `onConversationsUpdated(convs)` (handoff alerts) AND `onMessageAlert(convs)` (message alerts).
    - Pass `markSentMessage` to `MessageView` as a new prop `onMessageSent`. In MessageView, call `onMessageSent?.()` right after the message send API call succeeds (this is for own-message suppression).
    - Handle toggle: create `handleNotificationToggle` that calls `PATCH /api/user/preferences` and updates `notificationsEnabled` state.
    - Add `NotificationToggle` to the header, between the admin links and the Sign out button:
      ```tsx
      <NotificationToggle enabled={notificationsEnabled} onToggle={handleNotificationToggle} />
      ```

    **2. Update `src/hooks/use-handoff-alerts.ts`:**

    Remove the SOUND and BROWSER NOTIFICATION code from this hook since `use-message-alerts.ts` now handles all audio + browser alerts for ALL inbound messages (which subsumes handoff alerts). Specifically:
    - Remove `createBeepSound()`, `audioBufferToWav()`, `writeString()`, `requestNotificationPermission()`, `showBrowserNotification()` functions.
    - Remove `audioRef` from the hook.
    - Remove the `audioRef.current.play()` and `showBrowserNotification(brandNew)` calls from `onConversationsUpdated`.
    - Keep: `isHandoffConversation`, `allHandoffIds`, `alertingIds`, `acknowledge`, `onConversationsUpdated` (but only for tracking handoff IDs, no sound/notification). The hook's purpose is now ONLY visual handoff detection (amber border + badge).
    - The hook return type stays the same: `{ alertingIds, allHandoffIds, acknowledge, onConversationsUpdated }`.

    **3. Update `src/components/message-view.tsx`:**

    - Add `onMessageSent?: () => void` to the component's Props type.
    - After successful message send (the `fetch('/api/conversations/${conversationId}/messages', ...)` call that returns ok), call `onMessageSent?.()`.
  </action>
  <verify>
    - `npm run build` succeeds
    - page.tsx imports both `useHandoffAlerts` (visual only) and `useMessageAlerts` (sound + notification)
    - `NotificationToggle` renders in the header
    - `use-handoff-alerts.ts` no longer contains `AudioContext`, `createBeepSound`, or `showBrowserNotification`
    - `message-view.tsx` calls `onMessageSent` after successful send
  </verify>
  <done>The inbox plays a chime and shows browser notifications for new inbound messages, the toggle persists preferences, handoff visual treatment is preserved, and own-sent messages are suppressed.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. The header shows a bell icon toggle between admin links and Sign out
3. `use-handoff-alerts.ts` only contains handoff ID tracking logic (no audio, no browser notifications)
4. `use-message-alerts.ts` contains chime synthesis, browser notification, scope filtering, cooldown, own-sent suppression
5. `api/user/preferences/route.ts` has GET and PATCH handlers
6. `page.tsx` calls both `onConversationsUpdated` (handoff) and `onMessageAlert` (alerts) in `handleConversationsLoaded`
7. `message-view.tsx` calls `onMessageSent` after successful message send
</verification>

<success_criteria>
- NOTIF-01: Audio alert plays for new inbound messages (not just handoffs)
- NOTIF-02: User can toggle notifications on/off via bell icon in header, preference persisted to database
- NOTIF-03: Browser notification shown with contact name + preview when tab not focused
- NOTIF-04: Sound does not play for messages the agent themselves just sent (markSentMessage + 5s window)
- Handoff visual (amber border + badge) preserved unchanged via use-handoff-alerts.ts
</success_criteria>

<output>
After completion, create `.planning/phases/11-notifications-real-time/11-02-SUMMARY.md`
</output>
