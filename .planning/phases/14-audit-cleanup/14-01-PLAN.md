---
phase: 14-audit-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/contacts/[phone]/route.ts
  - src/components/contact-panel.tsx
  - src/components/message-view.tsx
  - src/app/api/user/preferences/route.ts
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "After editing a contact field (name, email, notes) and blurring, the saved value persists in the field (no blanking)"
    - "Non-admin users do not see admin nav links (analytics, labels, canned responses, settings, users)"
    - "Admin users see all admin nav links including a Usuarios link to /admin/users"
    - "If a message send fails (non-2xx), the notification suppression window does not activate"
  artifacts:
    - path: "src/app/api/contacts/[phone]/route.ts"
      provides: "PATCH returns { data: updatedContact } after re-SELECT"
      contains: "select.*phone_number.*display_name"
    - path: "src/components/contact-panel.tsx"
      provides: "Correct field key for display name"
      contains: "handleSaveField('displayName'"
    - path: "src/components/message-view.tsx"
      provides: "response.ok guard on onMessageSent"
      contains: "if.*response\\.ok.*onMessageSent"
    - path: "src/app/api/user/preferences/route.ts"
      provides: "Role field in GET response"
      contains: "role.*data.*role"
    - path: "src/app/page.tsx"
      provides: "Conditional admin nav rendering"
      contains: "userRole.*===.*admin"
  key_links:
    - from: "src/components/contact-panel.tsx"
      to: "/api/contacts/[phone] PATCH"
      via: "handleSaveField sends { displayName: value }, PATCH returns { data: contact }, setContact(data.data)"
      pattern: "handleSaveField.*displayName"
    - from: "src/app/page.tsx"
      to: "/api/user/preferences GET"
      via: "useEffect fetch on mount reads role from response, stores in userRole state"
      pattern: "setUserRole.*data\\.role"
    - from: "src/components/message-view.tsx"
      to: "onMessageSent prop"
      via: "response.ok check gates the callback that activates notification suppression"
      pattern: "response\\.ok.*onMessageSent"
---

<objective>
Fix all 5 tech debt items from the v2.0 milestone audit: (1) contact panel blanks after save, (2) display_name field key mismatch, (3) notification suppression on failed send, (4) admin nav links visible to agents, (5) Usuarios link missing from nav.

Purpose: Close all audit items so the v2.0 milestone is clean — no regressions, no confusing UX for agents.
Output: 5 bug/UX fixes across 5 existing files; no new files, no new packages, no schema changes.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-audit-cleanup/14-RESEARCH.md

Source files:
@src/app/api/contacts/[phone]/route.ts
@src/components/contact-panel.tsx
@src/components/message-view.tsx
@src/app/api/user/preferences/route.ts
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix contact PATCH response and message send guard</name>
  <files>
    src/app/api/contacts/[phone]/route.ts
    src/components/contact-panel.tsx
    src/components/message-view.tsx
  </files>
  <action>
    **Bug 1a — PATCH response shape (route.ts):**
    In `src/app/api/contacts/[phone]/route.ts`, in the PATCH handler, after the existing `.update(updates).eq('phone_number', phone)` block succeeds, add a re-SELECT query to fetch the updated contact row. Return `{ data: updatedContact }` instead of `{ success: true }`. This makes the PATCH response shape consistent with the GET response.

    After the existing error check (line ~82), add:
    ```typescript
    const { data: updatedContact, error: fetchError } = await supabase
      .from('contacts')
      .select('phone_number, display_name, email, notes, whatsapp_name, created_at')
      .eq('phone_number', phone)
      .single();

    if (fetchError) {
      return NextResponse.json({ error: fetchError.message }, { status: 500 });
    }

    return NextResponse.json({ data: updatedContact });
    ```
    Remove the old `return NextResponse.json({ success: true });` line.

    **Bug 1b — Field name mismatch (contact-panel.tsx):**
    In `src/components/contact-panel.tsx`, line 191, change:
    ```
    onSave={(v) => handleSaveField('display_name', v)}
    ```
    to:
    ```
    onSave={(v) => handleSaveField('displayName', v)}
    ```
    The API route destructures `displayName` (camelCase), not `display_name`. The `email` and `notes` fields are already correct.

    **Bug 2 — onMessageSent guard (message-view.tsx):**
    In `src/components/message-view.tsx`, in `handleSendMessage`, change:
    ```typescript
    await fetch('/api/messages/send', {
      method: 'POST',
      body: formData
    });

    onMessageSent?.();
    ```
    to:
    ```typescript
    const response = await fetch('/api/messages/send', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      onMessageSent?.();
    }
    ```
    Only gate `onMessageSent?.()` — leave `setMessageInput('')`, `handleRemoveFile()`, and `fetchMessages()` unconditional. The goal is to prevent the 5-second notification suppression window from activating on failed sends.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes (no type errors)
    2. In route.ts PATCH handler: the response is `{ data: { phone_number, display_name, ... } }` not `{ success: true }`
    3. In contact-panel.tsx: the name field calls `handleSaveField('displayName', v)` not `'display_name'`
    4. In message-view.tsx: `onMessageSent?.()` is inside an `if (response.ok)` block
  </verify>
  <done>
    - PATCH /api/contacts/[phone] returns `{ data: updatedContact }` with the full contact row
    - ContactPanel sends `displayName` as the JSON key for the name field
    - `onMessageSent?.()` only fires when the send API returns 2xx
  </done>
</task>

<task type="auto">
  <name>Task 2: Add role-aware nav links with Usuarios link</name>
  <files>
    src/app/api/user/preferences/route.ts
    src/app/page.tsx
  </files>
  <action>
    **Step 1 — Extend preferences API (route.ts):**
    In `src/app/api/user/preferences/route.ts`, in the GET handler:

    Change the select from:
    ```typescript
    .select('notifications_enabled')
    ```
    to:
    ```typescript
    .select('notifications_enabled, role')
    ```

    Change the return from:
    ```typescript
    return NextResponse.json({ notifications_enabled: notificationsEnabled });
    ```
    to:
    ```typescript
    return NextResponse.json({
      notifications_enabled: notificationsEnabled,
      role: data?.role ?? 'agent',
    });
    ```

    **Step 2 — Consume role in page.tsx:**
    In `src/app/page.tsx`:

    Add a new state variable after the existing `notificationsEnabled` state (line 35):
    ```typescript
    const [userRole, setUserRole] = useState<'admin' | 'agent'>('agent');
    ```
    Default to `'agent'` (least privilege — links hidden while loading).

    In the existing `useEffect` that fetches `/api/user/preferences` (lines 51-59), add role parsing after the notifications check:
    ```typescript
    if (data.role === 'admin' || data.role === 'agent') {
      setUserRole(data.role);
    }
    ```

    **Step 3 — Conditional nav rendering:**
    Wrap the 4 existing admin `<a>` links (Analiticas, Etiquetas, Canned Responses, Settings — lines 139-150) in a `{userRole === 'admin' && ( ... )}` block. Add a new "Usuarios" `<a href="/admin/users">` link inside the same block.

    The final admin links block should look like:
    ```tsx
    {userRole === 'admin' && (
      <>
        <a href="/admin/analytics" className="text-xs text-gray-500 hover:text-gray-700">
          Analiticas
        </a>
        <a href="/admin/labels" className="text-xs text-gray-500 hover:text-gray-700">
          Etiquetas
        </a>
        <a href="/admin/canned-responses" className="text-xs text-gray-500 hover:text-gray-700">
          Canned Responses
        </a>
        <a href="/admin/settings" className="text-xs text-gray-500 hover:text-gray-700">
          Settings
        </a>
        <a href="/admin/users" className="text-xs text-gray-500 hover:text-gray-700">
          Usuarios
        </a>
      </>
    )}
    ```

    Use plain `<a href>` tags (not Next.js `<Link>`) — consistent with the established pattern in this file.

    **Important:** Keep the realtime indicator, notification toggle, and sign out button OUTSIDE the admin block — those are visible to all roles.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. `GET /api/user/preferences` response includes `role` field
    3. In page.tsx: `userRole` state defaults to `'agent'`
    4. In page.tsx: admin nav links (including Usuarios) are wrapped in `userRole === 'admin'` conditional
    5. Realtime indicator, notification toggle, and sign out remain unconditional
  </verify>
  <done>
    - Preferences API returns `{ notifications_enabled, role }` with role defaulting to 'agent'
    - Agent users see no admin nav links in the top bar
    - Admin users see Analiticas, Etiquetas, Canned Responses, Settings, and Usuarios links
    - The Usuarios link goes to /admin/users
  </done>
</task>

</tasks>

<verification>
After both tasks:

1. **TypeScript compilation:** `npx tsc --noEmit` passes with zero errors
2. **Contact PATCH shape:** The PATCH handler in `route.ts` ends with `return NextResponse.json({ data: updatedContact })` after a re-SELECT
3. **Field key:** `contact-panel.tsx` uses `handleSaveField('displayName', v)` for the name field
4. **Send guard:** `message-view.tsx` has `if (response.ok) { onMessageSent?.(); }` pattern
5. **Preferences API:** `route.ts` GET response includes `role` field
6. **Nav visibility:** `page.tsx` admin links are wrapped in `userRole === 'admin'` conditional
7. **Usuarios link:** An `<a href="/admin/users">Usuarios</a>` link exists inside the admin-only block
</verification>

<success_criteria>
All 5 audit items resolved:
- Item 1: Contact panel retains saved values after edit+blur (PATCH returns data, field key matches)
- Item 2: Notification suppression only activates on successful send (response.ok guard)
- Items 3+4: Admin nav links hidden from agents (role-aware conditional rendering)
- Item 5: Usuarios link in top nav for admins (new link in admin block)
</success_criteria>

<output>
After completion, create `.planning/phases/14-audit-cleanup/14-01-SUMMARY.md`
</output>
