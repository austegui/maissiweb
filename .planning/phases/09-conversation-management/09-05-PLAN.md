---
phase: 09-conversation-management
plan: 05
type: execute
wave: 4
depends_on: ["09-04", "09-03"]
files_modified:
  - src/components/conversation-list.tsx
  - src/components/message-view.tsx
  - src/app/page.tsx
  - src/components/label-picker.tsx
  - src/app/api/conversations/route.ts
autonomous: true

must_haves:
  truths:
    - "Message view header has an assignment dropdown listing all team members from user_profiles"
    - "An agent can assign a conversation to any team member or unassign it"
    - "Assigned agent name appears as initials badge in the conversation list item"
    - "Conversation list can be filtered by assignment: Todos / Mis conversaciones / Sin asignar"
    - "Agent can attach/detach labels to a contact from the message view header via a label picker"
    - "Labels appear as colored pills in the conversation list items"
    - "Conversation list can be filtered by label"
    - "All UI text is in Spanish"
    - "Assignment filter defaults to 'Todos', showing all conversations (assigned and unassigned) to all agents on first load"
  artifacts:
    - path: "src/components/message-view.tsx"
      provides: "Assignment dropdown and label picker button in header"
      contains: "assignedAgentId"
    - path: "src/components/conversation-list.tsx"
      provides: "Initials badge, label pills, assignment filter, label filter"
      contains: "assignedAgentName"
    - path: "src/app/page.tsx"
      provides: "Assignment filter state, agents list, labels list"
      contains: "assignmentFilter"
    - path: "src/components/label-picker.tsx"
      provides: "Absolutely-positioned checkbox panel for label attachment"
      min_lines: 50
  key_links:
    - from: "src/components/message-view.tsx"
      to: "PATCH /api/conversations/[id]/assign"
      via: "fetch call on assignment change"
      pattern: "api/conversations.*assign"
    - from: "src/components/label-picker.tsx"
      to: "POST/DELETE /api/labels/contacts/[phone]"
      via: "fetch calls for label toggle"
      pattern: "api/labels/contacts"
    - from: "src/app/page.tsx"
      to: "GET /api/labels"
      via: "fetch on mount for label list"
      pattern: "api/labels"
---

<objective>
Add assignment and label UI: assignment dropdown in message header, initials badge in conversation list, label picker for agents, label pills in conversation list, and assignment + label filters. This completes all ASSIGN and LABEL requirements.

Purpose: ASSIGN-01 through ASSIGN-04 and LABEL-02 through LABEL-04 -- team assignment workflow and contact categorization.
Output: Modified conversation-list.tsx, message-view.tsx, page.tsx, and new label-picker.tsx component.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-conversation-management/09-RESEARCH.md
@.planning/phases/09-conversation-management/09-04-SUMMARY.md
@src/components/conversation-list.tsx
@src/components/message-view.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add assignment dropdown to message view and create label picker</name>
  <files>
    src/components/message-view.tsx
    src/components/label-picker.tsx
  </files>
  <action>
**1a. Add assignment dropdown to message view header:**

Add new props to MessageView:
- `agents?: { id: string; displayName: string }[]` (list of all team members for dropdown)
- `assignedAgentId?: string | null` (current assignment from parent)
- `onAssignmentChange?: (conversationId: string, agentId: string | null, agentName: string | null) => void`
- `allLabels?: { id: string; name: string; color: string }[]` (all available labels)
- `contactLabels?: { id: string; name: string; color: string }[]` (labels currently on this contact)
- `onLabelsChange?: (conversationId: string, labels: { id: string; name: string; color: string }[]) => void`

In the message view header, AFTER the status dropdown (added in Plan 09-04), add the assignment dropdown using `@radix-ui/react-select`:

```tsx
<AssignmentSelect
  agents={agents ?? []}
  value={localAssignedAgentId}
  onChange={handleAssignmentChange}
/>
```

Create `AssignmentSelect` inline or as a function:
- `Select.Root` with value and onValueChange
- `Select.Trigger`: compact, shows assigned agent initials or "Sin asignar" text. Style: `className="flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs border border-[#d1d7db] bg-white hover:bg-[#f0f2f5] transition-colors outline-none"`
- Options: "Sin asignar" (value = "__unassigned__"), then each agent with their display_name
- `Select.Portal` > `Select.Content` with `z-50`, `position="popper"`, `sideOffset={4}`

Handle assignment change:
```typescript
const [localAssignedAgentId, setLocalAssignedAgentId] = useState<string | null>(assignedAgentId ?? null);

useEffect(() => {
  setLocalAssignedAgentId(assignedAgentId ?? null);
}, [assignedAgentId]);

const handleAssignmentChange = async (value: string) => {
  const agentId = value === '__unassigned__' ? null : value;
  const agentName = agentId ? agents?.find(a => a.id === agentId)?.displayName ?? null : null;
  setLocalAssignedAgentId(agentId);  // optimistic
  try {
    await fetch(`/api/conversations/${conversationId}/assign`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentId })
    });
    onAssignmentChange?.(conversationId!, agentId, agentName);
  } catch (error) {
    console.error('Error updating assignment:', error);
    setLocalAssignedAgentId(assignedAgentId ?? null);  // revert
  }
};
```

**1b. Add label picker button to message view header:**

After the assignment dropdown, add a "Etiquetas" button that toggles a label picker panel:

```tsx
const [showLabelPicker, setShowLabelPicker] = useState(false);

// In header:
<div className="relative">
  <button
    onClick={() => setShowLabelPicker(!showLabelPicker)}
    className="flex items-center gap-1 px-2 py-1 rounded-md text-xs border border-[#d1d7db] bg-white hover:bg-[#f0f2f5] transition-colors"
  >
    <Tag className="h-3 w-3" />
    Etiquetas
    {localLabels.length > 0 && (
      <span className="bg-[#00a884] text-white text-[9px] rounded-full h-4 w-4 flex items-center justify-center">
        {localLabels.length}
      </span>
    )}
  </button>
  {showLabelPicker && (
    <LabelPicker
      allLabels={allLabels ?? []}
      selectedLabels={localLabels}
      onToggle={handleLabelToggle}
      onClose={() => setShowLabelPicker(false)}
    />
  )}
</div>
```

Import `Tag` from lucide-react. Close the label picker when the conversation changes (useEffect on conversationId).

Manage local label state:
```typescript
const [localLabels, setLocalLabels] = useState<{ id: string; name: string; color: string }[]>(contactLabels ?? []);

useEffect(() => {
  setLocalLabels(contactLabels ?? []);
}, [contactLabels]);
```

Handle label toggle:
```typescript
const handleLabelToggle = async (label: { id: string; name: string; color: string }, selected: boolean) => {
  // Optimistic update
  const newLabels = selected
    ? [...localLabels, label]
    : localLabels.filter(l => l.id !== label.id);
  setLocalLabels(newLabels);

  try {
    if (selected) {
      await fetch(`/api/labels/contacts/${phoneNumber}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ labelId: label.id })
      });
    } else {
      await fetch(`/api/labels/contacts/${phoneNumber}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ labelId: label.id })
      });
    }
    onLabelsChange?.(conversationId!, newLabels);
  } catch (error) {
    console.error('Error toggling label:', error);
    setLocalLabels(contactLabels ?? []);  // revert
  }
};
```

**1c. Create `src/components/label-picker.tsx`:**

An absolutely-positioned checkbox panel (same pattern as canned-responses-picker -- NOT Radix Popover, to avoid focus-theft):

```tsx
'use client';

type Label = { id: string; name: string; color: string };

type Props = {
  allLabels: Label[];
  selectedLabels: Label[];
  onToggle: (label: Label, selected: boolean) => void;
  onClose: () => void;
};

export function LabelPicker({ allLabels, selectedLabels, onToggle, onClose }: Props) {
  const selectedIds = new Set(selectedLabels.map(l => l.id));

  return (
    <div className="absolute right-0 top-full mt-1 w-56 bg-white border border-[#d1d7db] rounded-lg shadow-lg z-50 overflow-hidden">
      <div className="px-3 py-2 border-b border-[#e9edef] flex items-center justify-between">
        <span className="text-xs font-medium text-[#111b21]">Etiquetas</span>
        <button onClick={onClose} className="text-[#667781] hover:text-[#111b21]">
          <X className="h-3.5 w-3.5" />
        </button>
      </div>
      <div className="max-h-48 overflow-y-auto py-1">
        {allLabels.length === 0 ? (
          <p className="text-xs text-[#667781] px-3 py-2">No hay etiquetas disponibles</p>
        ) : (
          allLabels.map(label => {
            const isSelected = selectedIds.has(label.id);
            return (
              <button
                key={label.id}
                onClick={() => onToggle(label, !isSelected)}
                className="w-full flex items-center gap-2 px-3 py-1.5 hover:bg-[#f0f2f5] transition-colors"
              >
                <input
                  type="checkbox"
                  checked={isSelected}
                  readOnly
                  className="h-3.5 w-3.5 rounded border-gray-300 text-[#00a884] focus:ring-[#00a884]"
                />
                <span
                  className="h-3 w-3 rounded-full flex-shrink-0"
                  style={{ backgroundColor: label.color }}
                />
                <span className="text-sm text-[#111b21] truncate">{label.name}</span>
              </button>
            );
          })
        )}
      </div>
    </div>
  );
}
```

Import `X` from lucide-react.

Click-outside to close: use a useEffect with a document click listener that closes the picker when clicking outside. Or rely on the toggle button behavior + the close button.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify label-picker.tsx exists. Verify message-view.tsx has AssignmentSelect and label picker button.</verify>
  <done>
- Assignment dropdown shows in message header with all agents
- Label picker button shows with count badge
- LabelPicker component renders absolutely-positioned checkbox panel
- Both use optimistic updates with error rollback
  </done>
</task>

<task type="auto">
  <name>Task 2: Add assignment badge, label pills, and filters to conversation list</name>
  <files>
    src/components/conversation-list.tsx
    src/app/page.tsx
  </files>
  <action>
**2a. Add initials badge for assigned agent (conversation-list.tsx):**

Create a helper function:
```typescript
function getInitials(name: string): string {
  const words = name.trim().split(/\s+/);
  if (words.length >= 2) return (words[0][0] + words[1][0]).toUpperCase();
  return name.slice(0, 2).toUpperCase();
}
```

In each conversation item, after the timestamp (top-right area), add the assigned agent initials badge if assigned:
```tsx
{conversation.assignedAgentName && (
  <span
    className="h-5 w-5 rounded-full bg-[#d1d7db] text-[#111b21] text-[9px] font-medium flex items-center justify-center flex-shrink-0"
    title={conversation.assignedAgentName}
  >
    {getInitials(conversation.assignedAgentName)}
  </span>
)}
```

Place this BETWEEN the timestamp and the right edge, in the top-right area of each conversation item.

**2b. Add label pills to each conversation item:**

Below the last message preview line, add a row of label pills (only if labels exist):
```tsx
{conversation.labels && conversation.labels.length > 0 && (
  <div className="flex items-center gap-1 mt-1 overflow-hidden">
    {conversation.labels.slice(0, 3).map(label => (
      <span
        key={label.id}
        style={{ backgroundColor: label.color, color: getContrastColor(label.color) }}
        className="text-[9px] px-1.5 py-0.5 rounded-full font-medium flex-shrink-0 max-w-[60px] truncate"
      >
        {label.name}
      </span>
    ))}
    {conversation.labels.length > 3 && (
      <span className="text-[9px] text-[#667781]">+{conversation.labels.length - 3}</span>
    )}
  </div>
)}
```

Add the `getContrastColor` utility:
```typescript
function getContrastColor(hex: string): string {
  const c = hex.replace('#', '');
  const r = parseInt(c.slice(0, 2), 16);
  const g = parseInt(c.slice(2, 4), 16);
  const b = parseInt(c.slice(4, 6), 16);
  return (0.299 * r + 0.587 * g + 0.114 * b) > 128 ? '#111827' : '#ffffff';
}
```

**2c. Add assignment filter and label filter to conversation list:**

Add new props:
- `assignmentFilter: string` ('todos' | 'mios' | 'sin_asignar')
- `onAssignmentFilterChange: (value: string) => void`
- `labelFilter: string | null` (label ID or null for no filter)
- `onLabelFilterChange: (value: string | null) => void`
- `currentUserId?: string` (to filter by "mios")
- `allLabels?: { id: string; name: string; color: string }[]` (for label filter dropdown)

Place the filters in a compact row BETWEEN the search bar and the status tabs:
```tsx
<div className="flex items-center gap-2 mt-2">
  <select
    value={assignmentFilter}
    onChange={(e) => onAssignmentFilterChange(e.target.value)}
    className="text-xs border border-[#d1d7db] rounded px-2 py-1 bg-white text-[#111b21] outline-none focus:ring-1 focus:ring-[#00a884]"
  >
    <option value="todos">Todos</option>
    <option value="mios">Mis conversaciones</option>
    <option value="sin_asignar">Sin asignar</option>
  </select>
  <select
    value={labelFilter ?? ''}
    onChange={(e) => onLabelFilterChange(e.target.value || null)}
    className="text-xs border border-[#d1d7db] rounded px-2 py-1 bg-white text-[#111b21] outline-none focus:ring-1 focus:ring-[#00a884] max-w-[120px] truncate"
  >
    <option value="">Etiqueta</option>
    {(allLabels ?? []).map(label => (
      <option key={label.id} value={label.id}>{label.name}</option>
    ))}
  </select>
</div>
```

Use native `<select>` elements for these secondary filters (not Radix Select) -- they are simple, compact, and don't need custom styling.

**2d. Update filteredConversations to include assignment and label filters:**

```typescript
const filteredConversations = conversations.filter((conv) => {
  const query = debouncedQuery.toLowerCase();
  const matchesSearch =
    conv.phoneNumber.toLowerCase().includes(query) ||
    conv.contactName?.toLowerCase().includes(query);

  const convStatus = conv.convStatus ?? 'abierto';
  const matchesStatus = statusFilter === 'todos' || convStatus === statusFilter;

  // Assignment filter
  let matchesAssignment = true;
  if (assignmentFilter === 'mios') {
    matchesAssignment = conv.assignedAgentId === currentUserId;
  } else if (assignmentFilter === 'sin_asignar') {
    matchesAssignment = !conv.assignedAgentId;
  }

  // Label filter
  const matchesLabel = !labelFilter || (conv.labels ?? []).some(l => l.id === labelFilter);

  return matchesSearch && matchesStatus && matchesAssignment && matchesLabel;
});
```

**2e. Update page.tsx with new state and data fetching:**

Add state:
```typescript
const [assignmentFilter, setAssignmentFilter] = useState('todos');
const [labelFilter, setLabelFilter] = useState<string | null>(null);
const [agents, setAgents] = useState<{ id: string; displayName: string }[]>([]);
const [allLabels, setAllLabels] = useState<{ id: string; name: string; color: string }[]>([]);
const [currentUserId, setCurrentUserId] = useState<string | undefined>();
```

**Data fetching approach:** Modify `/api/conversations/route.ts` to include `agents` and `currentUserId` in its response (both are already fetched there for name resolution â€” `agentsResult` from the `Promise.all` and `user` from auth check). This avoids extra API endpoints and extra client-side fetches.

Also fetch all labels on mount for the label filter dropdown.

In `src/app/api/conversations/route.ts`, update the response:
```typescript
const { data: { user } } = await supabase.auth.getUser();
return NextResponse.json({
  data: enriched,
  paging: response.paging,
  agents: (agentsResult.data ?? []).map(a => ({ id: a.id, displayName: a.display_name })),
  currentUserId: user?.id ?? null,
});
```

In page.tsx, add the agents/user state and a callback:
```typescript
const [agents, setAgents] = useState<{id:string;displayName:string}[]>([]);
const [currentUserId, setCurrentUserId] = useState<string>();

const handleConversationsLoaded = (convs: Conversation[], meta?: { agents: {id:string;displayName:string}[]; currentUserId: string }) => {
  onConversationsUpdated(convs);
  if (meta?.agents) setAgents(meta.agents);
  if (meta?.currentUserId) setCurrentUserId(meta.currentUserId);
};
```

Pass agents, allLabels, currentUserId down to both ConversationList and MessageView.

For MessageView, pass:
- `agents={agents}`
- `assignedAgentId={selectedConversation?.assignedAgentId}`
- `onAssignmentChange={handleAssignmentChange}`
- `allLabels={allLabels}`
- `contactLabels={selectedConversation?.labels}`
- `onLabelsChange={handleLabelsChange}`

Add handlers:
```typescript
const handleAssignmentChange = (convId: string, agentId: string | null, agentName: string | null) => {
  if (selectedConversation?.id === convId) {
    setSelectedConversation(prev => prev ? { ...prev, assignedAgentId: agentId, assignedAgentName: agentName } : prev);
  }
};

const handleLabelsChange = (convId: string, labels: { id: string; name: string; color: string }[]) => {
  if (selectedConversation?.id === convId) {
    setSelectedConversation(prev => prev ? { ...prev, labels } : prev);
  }
};
```

Fetch all labels once on mount for the label filter dropdown:
```typescript
useEffect(() => {
  fetch('/api/labels').then(r => r.json()).then(data => setAllLabels(data.data ?? [])).catch(console.error);
}, []);
```

Pass `allLabels` to both ConversationList (for filter dropdown options) and MessageView (for label picker).
  </action>
  <verify>Run `npx tsc --noEmit`. Verify conversation-list.tsx shows initials badges and label pills. Verify page.tsx manages agents, labels, currentUserId state. Verify message-view.tsx has assignment dropdown and label picker.</verify>
  <done>
- Assignment dropdown in message header lists all team members
- Initials badge appears in conversation list for assigned conversations
- Label pills appear in conversation list items
- Assignment filter (Todos/Mis conversaciones/Sin asignar) works
- Label filter dropdown works
- Label picker in message view allows attaching/detaching labels
- All text in Spanish
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Assignment and label features all functional in the UI
- Optimistic updates with error rollback on all mutations
- Compact layout: status dot + initials badge + label pills don't overflow conversation items
- Secondary filters (assignment + label) use native select elements for compactness
- Label picker uses absolute positioning (not Radix Popover)
</verification>

<success_criteria>
ASSIGN-01 through ASSIGN-04 and LABEL-02 through LABEL-04 are all implemented: agents can assign conversations, see assignments in the list, filter by assignment, attach labels to contacts, see labels in the list, and filter by label.
</success_criteria>

<output>
After completion, create `.planning/phases/09-conversation-management/09-05-SUMMARY.md`
</output>
