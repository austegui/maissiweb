---
phase: 09-conversation-management
plan: 04
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - src/components/conversation-list.tsx
  - src/components/message-view.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Conversation list shows status tabs: Abierto | Pendiente | Resuelto | Todos"
    - "Default active tab is Abierto -- only open conversations shown on first load"
    - "Each conversation item shows a colored status dot (green=Abierto, amber=Pendiente, gray=Resuelto)"
    - "Message view header contains a status dropdown showing the current status with colored dot"
    - "Changing the status dropdown calls PATCH /api/conversations/[id]/status and updates the UI"
    - "When a customer sends a new message to a Resuelto conversation, it auto-reopens to Abierto"
    - "All UI text is in Spanish (tab labels, status names, empty states)"
  artifacts:
    - path: "src/components/conversation-list.tsx"
      provides: "Radix Tabs for status filtering, status dots on each conversation item"
      contains: "Tabs.Root"
    - path: "src/components/message-view.tsx"
      provides: "Radix Select for status change, auto-reopen logic"
      contains: "Select.Root"
    - path: "src/app/page.tsx"
      provides: "State management for status tab and conversation status"
      contains: "convStatus"
  key_links:
    - from: "src/components/conversation-list.tsx"
      to: "Radix Tabs"
      via: "@radix-ui/react-tabs import"
      pattern: "react-tabs"
    - from: "src/components/message-view.tsx"
      to: "PATCH /api/conversations/[id]/status"
      via: "fetch call on status change"
      pattern: "api/conversations.*status"
    - from: "src/components/message-view.tsx"
      to: "auto-reopen logic"
      via: "check last message direction when convStatus is resuelto"
      pattern: "resuelto.*inbound"
---

<objective>
Add conversation status lifecycle UI: Radix Tabs for filtering the conversation list by status, a Radix Select dropdown in the message view header for changing status, and auto-reopen logic when a customer messages a resolved conversation.

Purpose: STATUS-01 through STATUS-05 -- the core ticket lifecycle system.
Output: Modified conversation-list.tsx (tabs + status dots), message-view.tsx (status dropdown + auto-reopen), and page.tsx (status state management).
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-conversation-management/09-RESEARCH.md
@src/components/conversation-list.tsx
@src/components/message-view.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status tabs and status dots to conversation list</name>
  <files>
    src/components/conversation-list.tsx
    src/app/page.tsx
  </files>
  <action>
**1a. Update the Conversation type in conversation-list.tsx:**

Add to the existing Conversation type:
```typescript
convStatus?: string;      // 'abierto' | 'pendiente' | 'resuelto'
assignedAgentId?: string | null;
assignedAgentName?: string | null;
labels?: { id: string; name: string; color: string }[];
```

These fields come from the enriched /api/conversations response (Plan 09-02). Add them now so conversation-list.tsx is ready for all subsequent plans.

**1b. Add Radix Tabs for status filtering:**

Import `* as Tabs from '@radix-ui/react-tabs'`.

Add new props to the component:
- `statusFilter: string` (the active tab value -- 'abierto' | 'pendiente' | 'resuelto' | 'todos')
- `onStatusFilterChange: (value: string) => void`

Place the Tabs.Root BELOW the search bar, inside the header area (after the `<div className="relative">` search container, still inside the `border-b` header div). Use `Tabs.Root` with `value={statusFilter}` and `onValueChange={onStatusFilterChange}`.

Tab strip styling:
```
<Tabs.List className="flex border-t border-[#e9edef] mt-3 -mb-[1px]">
```

Four triggers: Abierto, Pendiente, Resuelto, Todos. Each styled with:
```
className="flex-1 px-2 py-2 text-xs font-medium text-[#667781] data-[state=active]:text-[#00a884] data-[state=active]:border-b-2 data-[state=active]:border-[#00a884] transition-colors"
```

No `Tabs.Content` elements needed -- the tab value drives filter state only.

**1c. Filter conversations by status tab:**

Update the `filteredConversations` logic to ALSO filter by status tab:
```typescript
const filteredConversations = conversations.filter((conv) => {
  // Text search filter
  const query = debouncedQuery.toLowerCase();
  const matchesSearch =
    conv.phoneNumber.toLowerCase().includes(query) ||
    conv.contactName?.toLowerCase().includes(query);

  // Status tab filter
  const convStatus = conv.convStatus ?? 'abierto';
  const matchesStatus = statusFilter === 'todos' || convStatus === statusFilter;

  return matchesSearch && matchesStatus;
});
```

**1d. Add status dot to each conversation item:**

Create a small StatusDot helper component (or inline):
```typescript
const STATUS_DOT_CLASS: Record<string, string> = {
  abierto: 'bg-green-500',
  pendiente: 'bg-amber-500',
  resuelto: 'bg-gray-400',
};
```

Place the dot inside each conversation button, next to the contact name. Add it as a `<span>` with `className={`h-2 w-2 rounded-full flex-shrink-0 ${STATUS_DOT_CLASS[conv.convStatus ?? 'abierto'] ?? 'bg-gray-400'}`}` inside the name row (before the contact name text).

**1e. Update empty state text to Spanish:**

When no conversations match the filter:
- If `statusFilter === 'abierto'`: "No hay conversaciones abiertas"
- If `statusFilter === 'pendiente'`: "No hay conversaciones pendientes"
- If `statusFilter === 'resuelto'`: "No hay conversaciones resueltas"
- If `statusFilter === 'todos'` and searchQuery: "No se encontraron conversaciones"
- If `statusFilter === 'todos'` and no searchQuery: "No hay conversaciones aun"

**1f. Update page.tsx to manage status tab state:**

In `src/app/page.tsx`:
- Add `const [statusFilter, setStatusFilter] = useState('abierto')` -- default to 'abierto' tab
- Pass `statusFilter` and `onStatusFilterChange={setStatusFilter}` to `<ConversationList>`
- Update the Conversation type in page.tsx to include `convStatus?: string` (so the selected conversation carries its status)

Also update the Conversation type in page.tsx to include all the new fields from the enriched response:
```typescript
type Conversation = {
  id: string;
  phoneNumber: string;
  contactName?: string;
  convStatus?: string;
  assignedAgentId?: string | null;
  assignedAgentName?: string | null;
  labels?: { id: string; name: string; color: string }[];
};
```

Pass `convStatus={selectedConversation?.convStatus}` to `<MessageView>` (for auto-reopen detection).
  </action>
  <verify>Run `npx tsc --noEmit`. Verify that Tabs.Root is imported from @radix-ui/react-tabs. Verify statusFilter state exists in page.tsx.</verify>
  <done>
- Status tabs render above conversation list (Abierto | Pendiente | Resuelto | Todos)
- Default tab is Abierto
- Status dots appear next to each conversation name
- Conversations filter by selected tab
- Empty states show Spanish text
  </done>
</task>

<task type="auto">
  <name>Task 2: Add status dropdown and auto-reopen to message view</name>
  <files>src/components/message-view.tsx</files>
  <action>
**2a. Add status dropdown to message view header:**

Import `* as Select from '@radix-ui/react-select'` and `{ ChevronDown, Check }` from lucide-react (ChevronDown for Select.Icon, Check for Select.ItemIndicator).

Add new props to MessageView:
- `convStatus?: string` (current status from parent)
- `onStatusChange?: (conversationId: string, newStatus: string) => void` (callback to update parent state)

In the header div (the `p-3 border-b` area), after the contact name section and before the refresh button, add the status dropdown:

```tsx
{conversationId && (
  <StatusSelect
    value={localStatus}
    onChange={handleStatusChange}
  />
)}
```

Create `StatusSelect` as an inline component or function within message-view.tsx:
- `Select.Root` with `value` and `onValueChange`
- `Select.Trigger`: compact styling, shows current status name + colored dot. Use `className="flex items-center gap-1.5 px-2.5 py-1 rounded-md text-sm border border-[#d1d7db] bg-white hover:bg-[#f0f2f5] transition-colors outline-none data-[state=open]:ring-2 data-[state=open]:ring-[#00a884]"`
- `Select.Portal` > `Select.Content` with `className="bg-white border border-[#d1d7db] rounded-lg shadow-lg z-50 overflow-hidden"` and `position="popper"` and `sideOffset={4}`
- Three `Select.Item` values: 'abierto', 'pendiente', 'resuelto'. Each shows a colored dot + Spanish name. Use `Select.ItemIndicator` with a `<Check className="h-3 w-3" />`.
- Status labels map: `{ abierto: 'Abierto', pendiente: 'Pendiente', resuelto: 'Resuelto' }`
- Status color map: `{ abierto: 'bg-green-500', pendiente: 'bg-amber-500', resuelto: 'bg-gray-400' }`

**2b. Implement status change handler:**

```typescript
const [localStatus, setLocalStatus] = useState(convStatus ?? 'abierto');

// Sync localStatus when convStatus prop changes (e.g., switching conversations)
useEffect(() => {
  setLocalStatus(convStatus ?? 'abierto');
}, [convStatus]);

const handleStatusChange = async (newStatus: string) => {
  setLocalStatus(newStatus);  // optimistic update
  try {
    await fetch(`/api/conversations/${conversationId}/status`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    onStatusChange?.(conversationId!, newStatus);
  } catch (error) {
    console.error('Error updating status:', error);
    setLocalStatus(convStatus ?? 'abierto');  // revert on error
  }
};
```

**2c. Implement auto-reopen for STATUS-04:**

Inside `fetchMessages` callback, AFTER sorting messages, add auto-reopen detection:

```typescript
// Auto-reopen: if conversation is 'resuelto' and last message is inbound, reopen to 'abierto'
const lastMsg = sortedMessages[sortedMessages.length - 1];
if (localStatus === 'resuelto' && lastMsg?.direction === 'inbound') {
  // Auto-reopen
  fetch(`/api/conversations/${conversationId}/status`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: 'abierto' })
  }).catch(err => console.error('Auto-reopen failed:', err));
  setLocalStatus('abierto');
  onStatusChange?.(conversationId!, 'abierto');
}
```

Use a ref to track whether auto-reopen has already fired for the current conversation to avoid repeated PATCH calls on every poll cycle:
```typescript
const autoReopenedRef = useRef<string | null>(null);
```
Only fire if `autoReopenedRef.current !== conversationId`. Set `autoReopenedRef.current = conversationId` after firing. Reset it when `conversationId` changes or when status is manually set to 'resuelto'.

**2d. Update page.tsx to wire status change callback:**

In `src/app/page.tsx`, add a handler:
```typescript
const handleStatusChange = (convId: string, newStatus: string) => {
  if (selectedConversation?.id === convId) {
    setSelectedConversation(prev => prev ? { ...prev, convStatus: newStatus } : prev);
  }
};
```

Pass `convStatus={selectedConversation?.convStatus}` and `onStatusChange={handleStatusChange}` to MessageView.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify Select.Root is imported from @radix-ui/react-select in message-view.tsx. Verify auto-reopen logic exists in fetchMessages. Verify onStatusChange is passed from page.tsx.</verify>
  <done>
- Message view header shows a status dropdown with current status and colored dot
- Changing the dropdown fires PATCH /api/conversations/[id]/status
- Status updates optimistically in the UI
- When a Resuelto conversation receives a new inbound message, it auto-reopens to Abierto
- Parent page.tsx receives status change callbacks and updates local state
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Radix Tabs imported and rendered in conversation-list.tsx
- Radix Select imported and rendered in message-view.tsx
- Auto-reopen logic guards against repeated PATCH calls with ref
- All status names in Spanish: Abierto, Pendiente, Resuelto
- Default tab is 'abierto'
</verification>

<success_criteria>
STATUS-01 through STATUS-05 are all implemented: conversations have statuses, agents can change them, the list filters by status tabs, status indicators are visually distinct (colored dots), and resolved conversations auto-reopen when customers message.
</success_criteria>

<output>
After completion, create `.planning/phases/09-conversation-management/09-04-SUMMARY.md`
</output>
