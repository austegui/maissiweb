---
phase: 09-conversation-management
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/admin/labels/page.tsx
  - src/app/admin/labels/LabelsManager.tsx
  - src/app/admin/labels/actions.ts
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin/labels and see a list of existing labels"
    - "Admin can create a new label with a name and color (using native color picker)"
    - "Admin can edit an existing label's name and color"
    - "Admin can delete a label"
    - "Non-admin users are blocked from accessing /admin/labels by the existing admin layout guard"
    - "All UI text is in Spanish"
  artifacts:
    - path: "src/app/admin/labels/page.tsx"
      provides: "Server Component that reads labels from Supabase"
      min_lines: 15
    - path: "src/app/admin/labels/LabelsManager.tsx"
      provides: "Client Component with create/edit/delete UI and color picker"
      min_lines: 100
    - path: "src/app/admin/labels/actions.ts"
      provides: "Server Actions for createLabel, updateLabel, deleteLabel"
      exports: ["createLabel", "updateLabel", "deleteLabel"]
  key_links:
    - from: "src/app/admin/labels/page.tsx"
      to: "contact_labels table"
      via: "supabase.from('contact_labels').select()"
      pattern: "contact_labels"
    - from: "src/app/admin/labels/actions.ts"
      to: "contact_labels table"
      via: "supabase insert/update/delete"
      pattern: "contact_labels"
---

<objective>
Build the admin label management page where admins can create, edit, and delete colored labels. This mirrors the existing CannedResponsesManager pattern from Phase 8.

Purpose: LABEL-01 requires admin-only label management. Agents will later use these labels to categorize contacts.
Output: Three files under src/app/admin/labels/ implementing full CRUD for labels.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-conversation-management/09-RESEARCH.md
@src/app/admin/canned-responses/page.tsx
@src/app/admin/canned-responses/CannedResponsesManager.tsx
@src/app/admin/canned-responses/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Actions for label CRUD</name>
  <files>src/app/admin/labels/actions.ts</files>
  <action>
Create `src/app/admin/labels/actions.ts` following the exact same pattern as `src/app/admin/canned-responses/actions.ts`:

1. `'use server'` directive
2. Import `revalidatePath` from `next/cache` and `createClient` from `@/lib/supabase/server`
3. Export `type ActionResult = { success: boolean; message: string }`

**createLabel(prevState, formData):**
- Extract `name` (string) and `color` (string) from formData
- Validate both are non-empty strings
- Auth check: getUser(), then check `user_profiles.role === 'admin'` (belt-and-suspenders; RLS also enforces)
- Insert into `contact_labels` with `{ name: name.trim(), color: color.trim() }`
- Handle unique constraint error: "Ya existe una etiqueta con este nombre"
- On success: `revalidatePath('/admin/labels')`, return `{ success: true, message: 'Etiqueta creada' }`

**updateLabel(id, prevState, formData):**
- Same validation and admin check
- Update `contact_labels` where `id = id` with `{ name, color, updated_at }`
- Handle unique constraint error
- revalidatePath, return success message "Etiqueta actualizada"

**deleteLabel(id):**
- Auth check (admin)
- Delete from `contact_labels` where `id = id`
- revalidatePath, return success
- Note: CASCADE on `conversation_contact_labels` handles cleanup automatically
  </action>
  <verify>Run `npx tsc --noEmit` to verify the file compiles correctly.</verify>
  <done>Three Server Actions exist: createLabel, updateLabel, deleteLabel -- all with admin checks and Spanish error messages.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin labels page and manager component</name>
  <files>
    src/app/admin/labels/page.tsx
    src/app/admin/labels/LabelsManager.tsx
  </files>
  <action>
**2a. Create `src/app/admin/labels/page.tsx`** (Server Component)

Mirror the canned-responses page.tsx pattern:
- Import Link from 'next/link', createClient, and LabelsManager
- Query `contact_labels` table: `.select('id, name, color').order('name')`
- Render a container div with:
  - Title: "Etiquetas" (h1)
  - Back link: `‚Üê Volver al inbox` pointing to `/`
  - `<LabelsManager initialLabels={rows ?? []} />`

**2b. Create `src/app/admin/labels/LabelsManager.tsx`** (Client Component)

Mirror `CannedResponsesManager.tsx` but with these differences:
- Props: `initialLabels: { id: string; name: string; color: string }[]`
- Mode state machine: `'list' | 'create' | 'edit'`
- useActionState for createLabel and updateLabel (same pattern as CannedResponsesManager)
- useTransition for deleteLabel

**Create form has 2 fields:**
- "Nombre" (name): text input, required
- "Color": `<input type="color" name="color" defaultValue="#6B7280" />` -- native OS color picker, no library needed
- Show a preview pill next to the color picker: a small rounded badge with the selected color as background and computed text color (use luminance formula: if `(0.299*R + 0.587*G + 0.114*B) > 128` use dark text, else white text). Show "Vista previa" as the pill text.
- Submit button: "Crear" / "Creando..."
- Cancel button: "Cancelar"

**Edit form** is the same but with defaultValue from editingItem and "Guardar" / "Guardando..." button.

**List view:**
- Count text: `${count} etiqueta(s)` or "No hay etiquetas aun." for empty state
- "Agregar nueva" button to switch to create mode
- Each label row: colored pill preview (using the label's color as background), label name, edit (Pencil icon) and delete (Trash2 icon) buttons
- Confirm delete with `window.confirm('Eliminar esta etiqueta?')`
- Empty state: "Crea tu primera etiqueta para comenzar."

**Color preview utility** (inline in the component or a small helper):
```typescript
function getContrastColor(hex: string): string {
  const c = hex.replace('#', '')
  const r = parseInt(c.slice(0, 2), 16)
  const g = parseInt(c.slice(2, 4), 16)
  const b = parseInt(c.slice(4, 6), 16)
  return (0.299 * r + 0.587 * g + 0.114 * b) > 128 ? '#111827' : '#ffffff'
}
```

**Add navigation link in `src/app/page.tsx`:** Add a "Etiquetas" link next to the existing "Canned Responses" and "Settings" links in the header nav. Point it to `/admin/labels`.

All UI text in Spanish.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify all three files exist under src/app/admin/labels/. Verify the link is added to page.tsx header.</verify>
  <done>
- /admin/labels page renders with label list, create form with color picker, edit form, and delete functionality
- Admin guard from /admin/layout.tsx blocks non-admin users
- Navigation link "Etiquetas" added to inbox header
- All text in Spanish
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- src/app/admin/labels/page.tsx, LabelsManager.tsx, actions.ts all exist
- LabelsManager uses mode state machine pattern (list/create/edit)
- Color picker uses native `<input type="color">`
- Labels display with computed contrast text color
- All UI text is in Spanish
</verification>

<success_criteria>
Admin can create, view, edit, and delete colored labels from /admin/labels. The page is protected by the existing admin layout guard. A navigation link exists in the inbox header.
</success_criteria>

<output>
After completion, create `.planning/phases/09-conversation-management/09-03-SUMMARY.md`
</output>
