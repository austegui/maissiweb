---
phase: 09-conversation-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "conversation_metadata table exists with conversation_id PK, status TEXT CHECK, assigned_agent_id UUID FK"
    - "contact_labels table exists with id UUID PK, name TEXT UNIQUE, color TEXT"
    - "conversation_contact_labels table exists with phone_number TEXT, label_id UUID FK, UNIQUE constraint"
    - "RLS policies allow all authenticated users to read/write conversation_metadata"
    - "RLS policies allow all authenticated users to read contact_labels but only admins to CUD"
    - "RLS policies allow all authenticated users to read/manage conversation_contact_labels"
  artifacts: []
  key_links:
    - from: "contact_labels RLS"
      to: "get_my_role() function"
      via: "RLS policy WITH CHECK"
      pattern: "get_my_role.*admin"
---

<objective>
Create the three Supabase tables and RLS policies required for conversation management: conversation_metadata (status + assignment), contact_labels (admin-defined label catalog), and conversation_contact_labels (labels attached to contacts by phone number).

Purpose: All Phase 9 features depend on these tables existing. This is the foundation layer.
Output: Three tables with RLS policies ready in Supabase.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-conversation-management/09-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Supabase tables and RLS policies</name>
  <action>
Run the following SQL in the Supabase Dashboard SQL Editor (https://supabase.com/dashboard → project → SQL Editor → New query):

```sql
-- conversation_metadata: stores status and assignment per Kapso conversation
CREATE TABLE public.conversation_metadata (
  conversation_id  TEXT PRIMARY KEY,
  status           TEXT NOT NULL DEFAULT 'abierto'
                     CHECK (status IN ('abierto', 'pendiente', 'resuelto')),
  assigned_agent_id UUID REFERENCES public.user_profiles(id) ON DELETE SET NULL,
  updated_at       TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE public.conversation_metadata ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Agents can read conversation metadata"
  ON public.conversation_metadata FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Agents can insert conversation metadata"
  ON public.conversation_metadata FOR INSERT
  TO authenticated
  WITH CHECK (true);

CREATE POLICY "Agents can update conversation metadata"
  ON public.conversation_metadata FOR UPDATE
  TO authenticated
  USING (true);

-- contact_labels: admin-defined label catalog
CREATE TABLE public.contact_labels (
  id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name       TEXT NOT NULL UNIQUE,
  color      TEXT NOT NULL DEFAULT '#6B7280',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE public.contact_labels ENABLE ROW LEVEL SECURITY;

CREATE POLICY "All agents can read labels"
  ON public.contact_labels FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Only admins can insert labels"
  ON public.contact_labels FOR INSERT
  TO authenticated
  WITH CHECK ((SELECT public.get_my_role()) = 'admin');

CREATE POLICY "Only admins can update labels"
  ON public.contact_labels FOR UPDATE
  TO authenticated
  USING ((SELECT public.get_my_role()) = 'admin');

CREATE POLICY "Only admins can delete labels"
  ON public.contact_labels FOR DELETE
  TO authenticated
  USING ((SELECT public.get_my_role()) = 'admin');

-- conversation_contact_labels: join table — labels on contacts (keyed by phone number)
CREATE TABLE public.conversation_contact_labels (
  id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone_number TEXT NOT NULL,
  label_id   UUID NOT NULL REFERENCES public.contact_labels(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE (phone_number, label_id)
);

ALTER TABLE public.conversation_contact_labels ENABLE ROW LEVEL SECURITY;

CREATE POLICY "All agents can read contact labels"
  ON public.conversation_contact_labels FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "All agents can manage contact labels"
  ON public.conversation_contact_labels FOR INSERT
  TO authenticated
  WITH CHECK (true);

CREATE POLICY "All agents can remove contact labels"
  ON public.conversation_contact_labels FOR DELETE
  TO authenticated
  USING (true);
```

Click "Run" and verify all statements succeed (no errors).
  </action>
  <how-to-verify>
    1. Go to Supabase Dashboard → Table Editor
    2. Confirm `conversation_metadata` table exists with columns: conversation_id (text), status (text), assigned_agent_id (uuid), updated_at (timestamptz)
    3. Confirm `contact_labels` table exists with columns: id (uuid), name (text), color (text), created_at, updated_at
    4. Confirm `conversation_contact_labels` table exists with columns: id (uuid), phone_number (text), label_id (uuid), created_at
    5. Go to Authentication → Policies and verify RLS is enabled on all three tables
  </how-to-verify>
  <resume-signal>Type "tables created" to continue</resume-signal>
</task>

</tasks>

<verification>
- All three tables visible in Supabase Table Editor
- RLS enabled on all three tables
- get_my_role() function (from Phase 7) correctly referenced in contact_labels policies
</verification>

<success_criteria>
Tables and RLS policies exist in Supabase, ready for API routes and UI to use.
</success_criteria>

<output>
After completion, create `.planning/phases/09-conversation-management/09-01-SUMMARY.md`
</output>
