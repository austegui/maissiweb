---
phase: 09-conversation-management
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/api/conversations/route.ts
  - src/app/api/conversations/[id]/status/route.ts
  - src/app/api/conversations/[id]/assign/route.ts
  - src/app/api/labels/route.ts
  - src/app/api/labels/contacts/[phone]/route.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/conversations returns each conversation with convStatus, assignedAgentId, assignedAgentName, and labels array"
    - "PATCH /api/conversations/[id]/status upserts status and returns success"
    - "PATCH /api/conversations/[id]/assign upserts assigned_agent_id and returns success"
    - "GET /api/labels returns all contact_labels rows"
    - "GET /api/labels/contacts/[phone] returns labels attached to a phone number"
    - "POST /api/labels/contacts/[phone] attaches a label to a phone number"
    - "DELETE /api/labels/contacts/[phone] removes a label from a phone number"
    - "Conversations with no metadata row default to convStatus 'abierto' and null assignment"
  artifacts:
    - path: "src/app/api/conversations/route.ts"
      provides: "Enriched conversation list with metadata + labels"
      contains: "convStatus"
    - path: "src/app/api/conversations/[id]/status/route.ts"
      provides: "Status PATCH endpoint"
      exports: ["PATCH"]
    - path: "src/app/api/conversations/[id]/assign/route.ts"
      provides: "Assignment PATCH endpoint"
      exports: ["PATCH"]
    - path: "src/app/api/labels/route.ts"
      provides: "All labels GET endpoint"
      exports: ["GET"]
    - path: "src/app/api/labels/contacts/[phone]/route.ts"
      provides: "Contact label attachment CRUD"
      exports: ["GET", "POST", "DELETE"]
  key_links:
    - from: "src/app/api/conversations/route.ts"
      to: "conversation_metadata table"
      via: "supabase .in() query"
      pattern: "conversation_metadata"
    - from: "src/app/api/conversations/route.ts"
      to: "user_profiles table"
      via: "supabase .select() for agent names"
      pattern: "user_profiles"
    - from: "src/app/api/conversations/[id]/status/route.ts"
      to: "conversation_metadata table"
      via: "supabase .upsert()"
      pattern: "upsert.*onConflict.*conversation_id"
---

<objective>
Install Radix UI packages and create all backend API routes for Phase 9: enrich the conversations GET endpoint with metadata + labels, add PATCH endpoints for status and assignment, and add label CRUD endpoints.

Purpose: The frontend plans (09-04, 09-05) need these API routes to function. This plan creates the entire backend layer.
Output: 5 route files (2 new PATCH, 1 new labels GET, 1 new contact labels CRUD, 1 modified conversations GET) and 2 new npm packages installed.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-conversation-management/09-RESEARCH.md
@src/app/api/conversations/route.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Radix UI packages</name>
  <files>package.json</files>
  <action>
Run `npm install @radix-ui/react-select @radix-ui/react-tabs` to install the two Radix UI primitives needed for Phase 9 UI (status dropdown and filter tabs). These are installed now so all subsequent plans can use them without needing to install.
  </action>
  <verify>Run `npm ls @radix-ui/react-select @radix-ui/react-tabs` and confirm both packages are installed (versions 2.x and 1.x respectively).</verify>
  <done>Both @radix-ui/react-select and @radix-ui/react-tabs appear in package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Create API routes and enrich conversations endpoint</name>
  <files>
    src/app/api/conversations/route.ts
    src/app/api/conversations/[id]/status/route.ts
    src/app/api/conversations/[id]/assign/route.ts
    src/app/api/labels/route.ts
    src/app/api/labels/contacts/[phone]/route.ts
  </files>
  <action>
**2a. Enrich GET /api/conversations (modify existing file)**

After building `transformedData` from Kapso, add Supabase enrichment:

1. Import `createClient` from `@/lib/supabase/server`
2. Extract all `conversationIds` and all `phoneNumbers` from transformedData
3. Run three parallel Supabase queries via `Promise.all`:
   - `conversation_metadata` `.select('conversation_id, status, assigned_agent_id').in('conversation_id', conversationIds)`
   - `user_profiles` `.select('id, display_name')` (all agents for name resolution)
   - `conversation_contact_labels` `.select('phone_number, label_id, contact_labels(id, name, color)').in('phone_number', phoneNumbers)` -- join with contact_labels to get label details
4. Build lookup maps: `metaMap` (conversation_id -> metadata), `agentMap` (agent id -> display_name), `labelsMap` (phone_number -> label array)
5. Merge into each conversation object:
   - `convStatus`: `metaMap.get(c.id)?.status ?? 'abierto'` (default to 'abierto' for conversations with no row)
   - `assignedAgentId`: `metaMap.get(c.id)?.assigned_agent_id ?? null`
   - `assignedAgentName`: resolve via agentMap, or null
   - `labels`: `labelsMap.get(c.phoneNumber) ?? []` -- array of `{id, name, color}` objects

IMPORTANT: Wrap the Supabase enrichment in a try/catch so that if Supabase queries fail, the conversations still return (just without metadata). Log the error but don't fail the entire response.

**2b. Create PATCH /api/conversations/[id]/status/route.ts**

- Export async function PATCH with `{ params }: { params: Promise<{ id: string }> }` (Next.js 15 -- params is a Promise, MUST await it)
- `const { id } = await params`
- Auth check: `supabase.auth.getUser()`, return 401 if no user
- Parse `{ status }` from request body
- Validate status is one of `['abierto', 'pendiente', 'resuelto']`, return 400 if invalid
- Upsert into `conversation_metadata`: `supabase.from('conversation_metadata').upsert({ conversation_id: id, status, updated_at: new Date().toISOString() }, { onConflict: 'conversation_id' })`
- Return `{ success: true }` on success, `{ error: message }` with 500 on failure

**2c. Create PATCH /api/conversations/[id]/assign/route.ts**

- Same params pattern as status route (await params)
- Auth check
- Parse `{ agentId }` from request body (can be a UUID string or `null` to unassign)
- Upsert into `conversation_metadata`: `supabase.from('conversation_metadata').upsert({ conversation_id: id, assigned_agent_id: agentId, updated_at: new Date().toISOString() }, { onConflict: 'conversation_id' })`
- Return `{ success: true }` on success

**2d. Create GET /api/labels/route.ts**

- Auth check
- `supabase.from('contact_labels').select('id, name, color').order('name')`
- Return `{ data: rows }`

**2e. Create GET/POST/DELETE /api/labels/contacts/[phone]/route.ts**

- All three methods: `{ params }: { params: Promise<{ phone: string }> }`, await params
- Auth check on all methods
- **GET**: `supabase.from('conversation_contact_labels').select('label_id, contact_labels(id, name, color)').eq('phone_number', phone)` -- return `{ data }`
- **POST**: Parse `{ labelId }` from body. Insert `{ phone_number: phone, label_id: labelId }`. If unique constraint error, return success (idempotent). Return `{ success: true }`
- **DELETE**: Parse `{ labelId }` from body. Delete where `phone_number = phone AND label_id = labelId`. Return `{ success: true }`
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation succeeds. Check that all 5 route files exist and export the correct HTTP methods.
  </verify>
  <done>
- GET /api/conversations returns enriched data with convStatus, assignedAgentId, assignedAgentName, and labels
- PATCH /api/conversations/[id]/status accepts {status} and upserts
- PATCH /api/conversations/[id]/assign accepts {agentId} and upserts
- GET /api/labels returns all labels
- GET/POST/DELETE /api/labels/contacts/[phone] manages contact label attachments
- All routes use Next.js 15 async params pattern
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- All 5 route files exist at correct paths
- conversations/route.ts imports createClient and performs Supabase enrichment
- Status and assign routes use upsert with onConflict
- All dynamic route handlers await params before using them
</verification>

<success_criteria>
The complete backend API layer for conversation management is deployed and functional. Frontend plans can call these endpoints.
</success_criteria>

<output>
After completion, create `.planning/phases/09-conversation-management/09-02-SUMMARY.md`
</output>
