---
phase: 07-foundation
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - src/app/admin/layout.tsx
autonomous: false

must_haves:
  truths:
    - "An admin user can access /admin/settings and see the settings page"
    - "An agent user navigating to /admin/settings is redirected to /"
    - "An unauthenticated user navigating to /admin/settings is redirected to /login"
  artifacts:
    - path: "src/app/admin/layout.tsx"
      provides: "Server-side role guard for all /admin/* routes"
      min_lines: 15
      contains: "redirect"
  key_links:
    - from: "src/app/admin/layout.tsx"
      to: "public.user_profiles"
      via: "supabase.from('user_profiles').select('role')"
      pattern: "user_profiles.*role"
    - from: "src/app/admin/layout.tsx"
      to: "next/navigation redirect"
      via: "redirect('/') for non-admin"
      pattern: "redirect\\('/'\\)"
---

<objective>
Create the admin route guard and verify RBAC works end-to-end on Vercel.

Purpose: Enforces role-based access at the route level -- only admin users can reach /admin/* pages (settings, and future user management). This is the application-level complement to the database-level RLS policies created in Plan 02.

Output: `src/app/admin/layout.tsx` deployed to Vercel, verified with both admin and agent accounts.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-foundation/07-RESEARCH.md
@.planning/phases/07-foundation/07-02-SUMMARY.md

@src/app/admin/settings/page.tsx
@src/middleware.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin layout with role guard and push to GitHub</name>
  <files>src/app/admin/layout.tsx</files>
  <action>
  Create `src/app/admin/layout.tsx` as a Server Component that:

  1. Imports `redirect` from `next/navigation` and `createClient` from `@/lib/supabase/server`
  2. Gets the authenticated user via `supabase.auth.getUser()`
  3. If no user, redirects to `/login` (belt-and-suspenders with middleware)
  4. Queries `user_profiles` table for the user's role: `.from('user_profiles').select('role').eq('id', user.id).single()`
  5. If `profile?.role !== 'admin'`, redirects to `/` (inbox page)
  6. Otherwise renders `{children}`

  This layout wraps ALL pages under `src/app/admin/**`, including the existing settings page.

  See Pattern 3 in 07-RESEARCH.md for exact code.

  After creating the file:
  1. Run `npx tsc --noEmit` to verify no type errors
  2. Run `npm run build` to verify the build succeeds
  3. Commit and push to GitHub (origin) to trigger Vercel deployment

  IMPORTANT: Do NOT use middleware for role checks -- the research confirmed middleware cannot reliably query Supabase tables. The middleware should remain auth-only (session refresh + CORS).
  </action>
  <verify>
  1. `npx tsc --noEmit` passes
  2. `npm run build` succeeds
  3. `git push origin master` completes
  </verify>
  <done>
  - `src/app/admin/layout.tsx` exists with role guard logic
  - Code pushed to GitHub, Vercel deployment triggered
  - Build passes with no errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Admin route guard that restricts /admin/* pages to admin-role users only. The guard queries user_profiles.role on each request and redirects non-admins to the inbox.</what-built>
  <how-to-verify>
  Wait for Vercel deployment to complete at https://maissiweb.vercel.app, then test:

  **Test 1 -- Admin access (should work):**
  1. Log in with your admin account (Gustavo)
  2. Navigate to https://maissiweb.vercel.app/admin/settings
  3. EXPECTED: Settings page loads normally, you can see and edit credentials

  **Test 2 -- Agent access (should be blocked):**
  1. Open an incognito/private browser window
  2. Log in with an agent (non-admin) team member account
  3. Navigate to https://maissiweb.vercel.app/admin/settings
  4. EXPECTED: You are redirected to the inbox (https://maissiweb.vercel.app/) -- the settings page should NOT load

  **Test 3 -- Unauthenticated access:**
  1. Open a new incognito window (not logged in)
  2. Navigate to https://maissiweb.vercel.app/admin/settings
  3. EXPECTED: You are redirected to the login page

  **Test 4 -- Inbox still works for agents:**
  1. Using the agent account from Test 2, verify the inbox loads and you can view conversations
  2. EXPECTED: Inbox works normally, conversations visible, messages readable
  </how-to-verify>
  <resume-signal>Type "approved" if all 4 tests pass. If any test fails, describe what happened (which test, what you saw instead of the expected behavior).</resume-signal>
</task>

</tasks>

<verification>
1. `src/app/admin/layout.tsx` exists and contains role guard logic
2. Admin can access /admin/settings on Vercel
3. Agent is redirected away from /admin/settings on Vercel
4. Inbox functionality unaffected for all users
</verification>

<success_criteria>
- Admin user can access settings page (RBAC-03)
- Agent user is blocked from settings page (RBAC-03, RBAC-04)
- Agent user can still use the inbox (view conversations, send messages) (RBAC-04)
- No user can self-promote their role (RBAC-02, enforced by RLS in Plan 02)
- Route guard deployed and verified on Vercel
</success_criteria>

<output>
After completion, create `.planning/phases/07-foundation/07-03-SUMMARY.md`
</output>
