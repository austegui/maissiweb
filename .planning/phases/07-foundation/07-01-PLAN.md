---
phase: 07-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/get-config.ts
  - src/lib/whatsapp-client.ts
  - src/app/api/conversations/route.ts
  - src/app/api/messages/[conversationId]/route.ts
  - src/app/api/messages/send/route.ts
  - src/app/api/messages/interactive/route.ts
  - src/app/api/media/[mediaId]/route.ts
  - src/app/api/templates/route.ts
  - src/app/api/templates/send/route.ts
autonomous: true

must_haves:
  truths:
    - "API routes that previously made 3-4 individual config queries now make a single batch query"
    - "Existing getConfig() callers still work (backward compatible)"
    - "All WhatsApp API features (conversations, messages, media, templates) still function correctly after refactor"
  artifacts:
    - path: "src/lib/get-config.ts"
      provides: "getConfigs() batch function + backward-compatible getConfig()"
      exports: ["getConfig", "getConfigs", "ConfigKey"]
      contains: ".in("
    - path: "src/lib/whatsapp-client.ts"
      provides: "getWhatsAppClientWithPhone() factory returning client + phoneNumberId"
      exports: ["getWhatsAppClient", "getWhatsAppClientWithPhone"]
      contains: "getWhatsAppClientWithPhone"
  key_links:
    - from: "src/lib/get-config.ts"
      to: "supabase.from('app_settings')"
      via: ".in('key', keys) batch query"
      pattern: "\\.in\\('key'"
    - from: "src/lib/whatsapp-client.ts"
      to: "src/lib/get-config.ts"
      via: "import getConfigs"
      pattern: "import.*getConfigs.*from.*get-config"
    - from: "src/app/api/conversations/route.ts"
      to: "src/lib/whatsapp-client.ts"
      via: "getWhatsAppClientWithPhone()"
      pattern: "getWhatsAppClientWithPhone"
---

<objective>
Refactor getConfig() to support batch queries and update all API route consumers.

Purpose: Eliminates 3-4 sequential DB queries per API request, replacing them with a single `.in()` query. This is the performance foundation for v2.0 where additional routes and features will multiply query load.

Output: Updated `get-config.ts` with `getConfigs()`, updated `whatsapp-client.ts` with `getWhatsAppClientWithPhone()`, and all 7 consumer API routes migrated to batch pattern.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-foundation/07-RESEARCH.md

@src/lib/get-config.ts
@src/lib/whatsapp-client.ts
@src/app/api/conversations/route.ts
@src/app/api/messages/[conversationId]/route.ts
@src/app/api/messages/send/route.ts
@src/app/api/messages/interactive/route.ts
@src/app/api/media/[mediaId]/route.ts
@src/app/api/templates/route.ts
@src/app/api/templates/send/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getConfigs() batch function and getWhatsAppClientWithPhone() factory</name>
  <files>src/lib/get-config.ts, src/lib/whatsapp-client.ts</files>
  <action>
  In `src/lib/get-config.ts`:
  1. Keep the existing `getConfig()` function signature and export, but refactor its body to delegate to `getConfigs()` internally: `const configs = await getConfigs(key); return configs[key];`
  2. Add a new exported `getConfigs()` function with signature: `export async function getConfigs<K extends ConfigKey>(...keys: K[]): Promise<Record<K, string>>`
  3. `getConfigs()` must:
     - Create a Supabase client via `createClient()`
     - Query `app_settings` with `.select('key, value').in('key', keys)` -- single DB round-trip
     - Build a result map from DB rows
     - Apply `ENV_FALLBACKS` for any keys missing from DB
     - Throw `Error` if a key is missing from both DB and env
  4. Keep the existing `ConfigKey` type and `ENV_FALLBACKS` unchanged

  In `src/lib/whatsapp-client.ts`:
  1. Change import from `getConfig` to `getConfigs` (from `@/lib/get-config`)
  2. Update `getWhatsAppClient()` to use `getConfigs('KAPSO_API_KEY', 'WHATSAPP_API_URL')` and destructure the result
  3. Add new exported function `getWhatsAppClientWithPhone()` that:
     - Calls `getConfigs('KAPSO_API_KEY', 'WHATSAPP_API_URL', 'PHONE_NUMBER_ID')` -- single DB query for all 3
     - Returns `{ client: WhatsAppClient, phoneNumberId: string }`

  See Pattern 4 in 07-RESEARCH.md for exact code.
  </action>
  <verify>Run `npx tsc --noEmit` from project root -- no type errors in modified files.</verify>
  <done>
  - `getConfigs()` exported from `get-config.ts` with `.in()` batch query
  - `getConfig()` still works (delegates to `getConfigs()`)
  - `getWhatsAppClientWithPhone()` exported from `whatsapp-client.ts`
  - `getWhatsAppClient()` still works (uses `getConfigs()` internally)
  - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all API routes to batch config pattern</name>
  <files>
    src/app/api/conversations/route.ts,
    src/app/api/messages/[conversationId]/route.ts,
    src/app/api/messages/send/route.ts,
    src/app/api/messages/interactive/route.ts,
    src/app/api/media/[mediaId]/route.ts,
    src/app/api/templates/send/route.ts,
    src/app/api/templates/route.ts
  </files>
  <action>
  For each of the 6 routes that call `getWhatsAppClient()` + `getConfig('PHONE_NUMBER_ID')`:
  - `conversations/route.ts`
  - `messages/[conversationId]/route.ts`
  - `messages/send/route.ts`
  - `messages/interactive/route.ts`
  - `media/[mediaId]/route.ts`
  - `templates/send/route.ts`

  Apply this transformation:
  1. Change import from `import { getWhatsAppClient } from '@/lib/whatsapp-client'` to `import { getWhatsAppClientWithPhone } from '@/lib/whatsapp-client'`
  2. Remove `import { getConfig } from '@/lib/get-config'` (no longer needed)
  3. Replace these two lines:
     ```
     const whatsappClient = await getWhatsAppClient();
     const phoneNumberId = await getConfig('PHONE_NUMBER_ID');
     ```
     With this single line:
     ```
     const { client: whatsappClient, phoneNumberId } = await getWhatsAppClientWithPhone();
     ```
  4. The rest of the route logic is unchanged -- `whatsappClient` and `phoneNumberId` variables are used the same way

  For `templates/route.ts` (special case -- uses WABA_ID, not PHONE_NUMBER_ID):
  1. Change import to `import { getWhatsAppClient } from '@/lib/whatsapp-client'` (keep existing)
  2. Change `import { getConfig } from '@/lib/get-config'` to `import { getConfigs } from '@/lib/get-config'`
  3. Replace:
     ```
     const whatsappClient = await getWhatsAppClient();
     const wabaId = await getConfig('WABA_ID');
     ```
     With:
     ```
     const { KAPSO_API_KEY, WHATSAPP_API_URL, WABA_ID: wabaId } = await getConfigs('KAPSO_API_KEY', 'WHATSAPP_API_URL', 'WABA_ID');
     const whatsappClient = new WhatsAppClient({ baseUrl: WHATSAPP_API_URL, kapsoApiKey: KAPSO_API_KEY, graphVersion: 'v24.0' });
     ```
     This reduces 3 queries to 1. Import `WhatsAppClient` from `@kapso/whatsapp-cloud-api` (already imported in some routes, add if missing).

  Do NOT modify `settings/route.ts` -- it does not use getWhatsAppClient and its config reads are different (reads all settings, not specific keys).
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors across all modified route files.</verify>
  <done>
  - All 6 PHONE_NUMBER_ID routes use `getWhatsAppClientWithPhone()` with a single DB query
  - `templates/route.ts` uses `getConfigs()` with a single DB query for all 3 keys
  - No route imports `getConfig` individually (except `settings/route.ts` which is unchanged)
  - No TypeScript errors
  - All routes produce the same API responses as before (only internal query count changed)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds (catches any import/export issues)
3. Grep for orphaned `getConfig(` calls: should only appear in `get-config.ts` (the backward-compat wrapper) and `settings/route.ts` (unchanged). No other files should import `getConfig` directly.
</verification>

<success_criteria>
- Every API route that previously made 2-3 sequential getConfig() calls now makes exactly 1 batch query
- getConfig() backward compatibility preserved (delegates to getConfigs internally)
- TypeScript compilation passes
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-foundation/07-01-SUMMARY.md`
</output>
