---
phase: 04-config-migration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: []
autonomous: false

user_setup:
  - service: vercel
    why: "Remove env vars from Vercel dashboard to prove DB is sole credential source"
    dashboard_config:
      - task: "Remove PHONE_NUMBER_ID, KAPSO_API_KEY, and WABA_ID from Environment Variables"
        location: "Vercel Dashboard -> Project Settings -> Environment Variables"

must_haves:
  truths:
    - "A user can send a WhatsApp message from the inbox and the recipient receives it"
    - "An incoming WhatsApp message appears in the inbox via polling"
    - "Template messages can be sent from the inbox"
    - "Media attachments (image, video, audio, document) can be sent"
    - "Removing PHONE_NUMBER_ID, KAPSO_API_KEY, and WABA_ID from Vercel env vars does not break messaging"
  artifacts: []
  key_links:
    - from: "Vercel deployment"
      to: "Supabase app_settings table"
      via: "getConfig() reads credentials from DB at runtime"
      pattern: "getConfig"
---

<objective>
Deploy the config migration to Vercel, remove env vars, and verify all WhatsApp messaging features work with DB-only credentials.

Purpose: This is the proof that the migration works. The code changes from Plan 04-01 are meaningless until we confirm messaging features survive the removal of env vars. This plan is the acceptance test for the entire phase.

Output: Verified production deployment where all messaging features work with credentials sourced exclusively from the database.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-config-migration/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push code to GitHub for Vercel deployment</name>
  <files></files>
  <action>
Commit all changes from Plan 04-01 (if not already committed) and push to GitHub. Vercel will auto-deploy from the push.

Steps:
1. `git add src/lib/whatsapp-client.ts src/app/api/conversations/route.ts src/app/api/media/[mediaId]/route.ts src/app/api/messages/[conversationId]/route.ts src/app/api/messages/interactive/route.ts src/app/api/messages/send/route.ts src/app/api/templates/route.ts src/app/api/templates/send/route.ts`
2. `git commit -m "feat(04): migrate all Kapso routes from process.env to getConfig()"`
3. `git push origin master`
4. Wait for Vercel deployment to complete (check via `vercel` CLI or GitHub status).

Before proceeding to the checkpoint, verify the deployment succeeded by checking `git log --oneline -1` shows the commit was pushed and Vercel build logs show success.
  </action>
  <verify>
`git log --oneline -1` shows the config migration commit. `git status` shows working tree clean (no uncommitted changes in the modified route files).
  </verify>
  <done>
Code is pushed to GitHub. Vercel deployment is triggered.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
All Kapso API routes now read credentials from the Supabase database (via getConfig()) instead of process.env. The code is deployed to Vercel. The env vars are still present — they need to be removed to prove DB is the sole source.
  </what-built>
  <how-to-verify>
**Pre-flight (before removing env vars):**
1. Open the Vercel deployment URL in your browser
2. Log in to the inbox
3. Verify conversations load (this confirms the migration works WITH env vars still present as fallback)
4. Send a test message — verify it arrives

**Remove env vars:**
5. Go to Vercel Dashboard -> Project Settings -> Environment Variables
6. Remove these 3 env vars: `PHONE_NUMBER_ID`, `KAPSO_API_KEY`, `WABA_ID`
7. Do NOT remove `WHATSAPP_API_URL` (not required by success criteria)
8. Do NOT remove `NEXT_PUBLIC_SUPABASE_URL` or `NEXT_PUBLIC_SUPABASE_ANON_KEY` (these are for Supabase auth, not WhatsApp credentials)
9. Trigger a new deployment (Vercel requires redeployment to pick up env var changes — go to Deployments tab and click "Redeploy" on the latest deployment)

**Verify after env var removal:**
10. Wait for the redeployment to complete
11. Open the Vercel deployment URL — log in
12. Verify conversations load (proves PHONE_NUMBER_ID comes from DB)
13. Send a text message to a test number — verify the recipient receives it (proves KAPSO_API_KEY comes from DB)
14. Open a conversation and verify messages display (proves message fetching works)
15. If you have templates configured: open the template dialog and verify templates load (proves WABA_ID comes from DB)
16. If possible: send a media attachment (image or document) and verify it sends

**Expected behavior:** Everything works exactly as before. The inbox loads, messages send and receive, templates list, media works. The only difference is credentials now come from the app_settings table in Supabase.

**If something breaks:** Note the exact error (check browser console and Vercel function logs). The most likely issue is that credentials are not in the app_settings table — verify via the Admin Settings page that all values are saved.
  </how-to-verify>
  <resume-signal>Type "approved" if all messaging features work after env var removal, or describe what failed</resume-signal>
</task>

</tasks>

<verification>
Phase 4 is complete when:
1. Code is deployed to Vercel with all process.env reads replaced by getConfig()
2. PHONE_NUMBER_ID, KAPSO_API_KEY, and WABA_ID are removed from Vercel env vars
3. After redeployment, all messaging features work: send, receive, templates, media
4. The database is the sole credential source for WhatsApp API operations
</verification>

<success_criteria>
- Conversations load in the inbox after env var removal
- Text messages send and are received by the recipient
- Incoming messages appear via polling
- Template messages can be sent (if templates are configured)
- Media attachments can be sent
- No errors in Vercel function logs related to missing credentials
</success_criteria>

<output>
After completion, create `.planning/phases/04-config-migration/04-02-SUMMARY.md`
</output>
