---
phase: 04-config-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/whatsapp-client.ts
  - src/app/api/conversations/route.ts
  - src/app/api/media/[mediaId]/route.ts
  - src/app/api/messages/[conversationId]/route.ts
  - src/app/api/messages/interactive/route.ts
  - src/app/api/messages/send/route.ts
  - src/app/api/templates/route.ts
  - src/app/api/templates/send/route.ts
autonomous: true

must_haves:
  truths:
    - "No file in the codebase imports PHONE_NUMBER_ID from whatsapp-client.ts"
    - "No file in the codebase imports whatsappClient (the Proxy) from whatsapp-client.ts"
    - "No Kapso route reads credentials directly from process.env"
    - "All Kapso routes resolve credentials via getConfig() and getWhatsAppClient()"
    - "The project compiles with zero TypeScript errors"
  artifacts:
    - path: "src/lib/whatsapp-client.ts"
      provides: "Async getWhatsAppClient() that uses getConfig()"
      exports: ["getWhatsAppClient"]
      contains: "async function getWhatsAppClient"
    - path: "src/app/api/conversations/route.ts"
      provides: "Conversations list endpoint using DB credentials"
      contains: "getConfig"
    - path: "src/app/api/messages/send/route.ts"
      provides: "Message send endpoint using DB credentials"
      contains: "getConfig"
    - path: "src/app/api/templates/route.ts"
      provides: "Template list endpoint using DB credentials"
      contains: "getConfig"
  key_links:
    - from: "src/lib/whatsapp-client.ts"
      to: "src/lib/get-config.ts"
      via: "import and await getConfig()"
      pattern: "await getConfig\\('KAPSO_API_KEY'\\)"
    - from: "src/app/api/conversations/route.ts"
      to: "src/lib/get-config.ts"
      via: "import and await getConfig('PHONE_NUMBER_ID')"
      pattern: "await getConfig\\('PHONE_NUMBER_ID'\\)"
    - from: "src/app/api/templates/route.ts"
      to: "src/lib/get-config.ts"
      via: "import and await getConfig('WABA_ID')"
      pattern: "await getConfig\\('WABA_ID'\\)"
    - from: "src/app/api/messages/send/route.ts"
      to: "src/lib/whatsapp-client.ts"
      via: "import and await getWhatsAppClient()"
      pattern: "await getWhatsAppClient\\(\\)"
---

<objective>
Replace all process.env credential reads in Kapso API routes with async getConfig() calls, and refactor whatsapp-client.ts to use async DB-backed credential resolution.

Purpose: This is the core migration that makes WhatsApp API credentials configurable via the admin settings UI (Phase 3) instead of requiring redeployment to change env vars. After this plan, credentials flow from Supabase DB through getConfig() into every API route.

Output: 8 modified files — whatsapp-client.ts rewritten to export async getWhatsAppClient(), all 7 consumer routes updated to use await getWhatsAppClient() and await getConfig().
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-config-migration/04-RESEARCH.md
@src/lib/whatsapp-client.ts
@src/lib/get-config.ts
@src/app/api/conversations/route.ts
@src/app/api/media/[mediaId]/route.ts
@src/app/api/messages/[conversationId]/route.ts
@src/app/api/messages/interactive/route.ts
@src/app/api/messages/send/route.ts
@src/app/api/templates/route.ts
@src/app/api/templates/send/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor whatsapp-client.ts to async DB-backed credentials</name>
  <files>src/lib/whatsapp-client.ts</files>
  <action>
Rewrite src/lib/whatsapp-client.ts to remove all synchronous process.env reads and the Proxy pattern. The final file should contain ONLY:

1. Import `WhatsAppClient` from `@kapso/whatsapp-cloud-api`
2. Import `getConfig` from `@/lib/get-config`
3. A single exported async function `getWhatsAppClient()` that returns `Promise<WhatsAppClient>`

Inside getWhatsAppClient():
- `const kapsoApiKey = await getConfig('KAPSO_API_KEY')`
- `const baseUrl = await getConfig('WHATSAPP_API_URL')`
- Return `new WhatsAppClient({ baseUrl, kapsoApiKey, graphVersion: 'v24.0' })`

REMOVE entirely (do NOT keep any of these):
- The module-level `let _whatsappClient: WhatsAppClient | null = null` singleton variable
- The synchronous `if (!_whatsappClient)` singleton guard
- `export const whatsappClient = new Proxy(...)` — the entire Proxy export
- `export const PHONE_NUMBER_ID = process.env.PHONE_NUMBER_ID || ''` — the constant export
- All direct `process.env.KAPSO_API_KEY`, `process.env.WHATSAPP_API_URL` reads

WHY no singleton: Vercel serverless functions don't reliably share module state across invocations, so the singleton was already illusory in production. Creating a new instance per request has no behavioral difference.

WHY no Proxy: Proxy get traps are synchronous. Once getWhatsAppClient() is async, the Proxy cannot await it. The Proxy must be removed entirely.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` — expect errors ONLY from consumer routes that still reference the old exports (whatsappClient, PHONE_NUMBER_ID). The whatsapp-client.ts file itself should have zero errors.

Also verify: `grep -n "process.env" src/lib/whatsapp-client.ts` returns no output (all process.env reads removed).
  </verify>
  <done>
whatsapp-client.ts exports only `getWhatsAppClient` (async). No process.env reads. No Proxy. No PHONE_NUMBER_ID constant. File compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all 7 consumer routes to use async getWhatsAppClient() and getConfig()</name>
  <files>
src/app/api/conversations/route.ts
src/app/api/media/[mediaId]/route.ts
src/app/api/messages/[conversationId]/route.ts
src/app/api/messages/interactive/route.ts
src/app/api/messages/send/route.ts
src/app/api/templates/route.ts
src/app/api/templates/send/route.ts
  </files>
  <action>
For each of the 7 route files, apply this mechanical transformation:

**Import changes (all 7 files):**
- REMOVE: `import { whatsappClient, PHONE_NUMBER_ID } from '@/lib/whatsapp-client'` (or `import { whatsappClient } from ...` for templates/route.ts)
- ADD: `import { getWhatsAppClient } from '@/lib/whatsapp-client'`
- ADD: `import { getConfig } from '@/lib/get-config'`

**Handler body changes (all 7 files):**
- ADD at the top of the try block (before any whatsappClient or PHONE_NUMBER_ID usage):
  `const whatsappClient = await getWhatsAppClient()`
- For all files EXCEPT templates/route.ts, also ADD:
  `const phoneNumberId = await getConfig('PHONE_NUMBER_ID')`
- Replace every usage of the old `PHONE_NUMBER_ID` constant with the local `phoneNumberId` variable

**File-specific details:**

1. **conversations/route.ts** — 2 PHONE_NUMBER_ID usages:
   - Line 34: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId`
   - Line 59: `conversation.phoneNumberId ?? PHONE_NUMBER_ID` -> `conversation.phoneNumberId ?? phoneNumberId`

2. **media/[mediaId]/route.ts** — 2 PHONE_NUMBER_ID usages:
   - Line 13: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId`
   - Line 18: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId`

3. **messages/[conversationId]/route.ts** — 1 PHONE_NUMBER_ID usage:
   - Line 88: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId`

4. **messages/interactive/route.ts** — 1 PHONE_NUMBER_ID usage:
   - Line 32: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId`

5. **messages/send/route.ts** — 6 PHONE_NUMBER_ID usages (all must be updated):
   - Line 27: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId` (media upload)
   - Line 36: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId` (sendImage)
   - Line 42: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId` (sendVideo)
   - Line 48: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId` (sendAudio)
   - Line 54: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId` (sendDocument)
   - Line 62: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId` (sendText)

6. **templates/route.ts** — SPECIAL: Also replace inline process.env.WABA_ID:
   - REMOVE: `const wabaId = process.env.WABA_ID;` and the `if (!wabaId)` guard block
   - ADD: `const wabaId = await getConfig('WABA_ID')` (getConfig throws if WABA_ID absent — equivalent behavior to the old guard)

7. **templates/send/route.ts** — 1 PHONE_NUMBER_ID usage:
   - Line 113: `phoneNumberId: PHONE_NUMBER_ID` -> `phoneNumberId`
   - NOTE: This file has type aliases on lines 7-8 that reference `typeof whatsappClient.messages` — these must be updated to work without the Proxy. Since the type alias `TemplateMessageInput` depends on `typeof whatsappClient.messages`, and `whatsappClient` no longer exists as a module-level export, you need to change the approach. Use `WhatsAppClient` type directly: `type TemplateMessageInput = Parameters<WhatsAppClient['messages']['sendTemplate']>[0]`. Import `WhatsAppClient` from `@kapso/whatsapp-cloud-api` if not already imported.

**CRITICAL CHECK for templates/send/route.ts:**
The existing type aliases on lines 7-8 reference `whatsappClient.messages` (the Proxy). After removing the Proxy import, these lines will break. The fix is to use the `WhatsAppClient` class type directly. Import it and reference its instance methods:
```typescript
import { WhatsAppClient } from '@kapso/whatsapp-cloud-api';
// ...
type TemplateMessageInput = Parameters<WhatsAppClient['messages']['sendTemplate']>[0];
```
If `WhatsAppClient['messages']` doesn't work as a type (it might need an instance), create a temporary type: inspect what type `sendTemplate` expects and use that. If the `WhatsAppClient` class exposes the type correctly, the above pattern works. If not, you may need to instantiate in a type-only way or use `InstanceType<typeof WhatsAppClient>['messages']['sendTemplate']`.

Alternatively, since `getWhatsAppClient()` returns `Promise<WhatsAppClient>`, you can use `Awaited<ReturnType<typeof getWhatsAppClient>>` to get the instance type for the type aliases.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — must complete with zero errors.
2. Run `grep -rn "process\.env\.\(KAPSO_API_KEY\|WHATSAPP_API_URL\|PHONE_NUMBER_ID\|WABA_ID\)" src/app/api/ src/lib/whatsapp-client.ts` — must return ONLY hits in `src/lib/get-config.ts` (the ENV_FALLBACKS object). No hits in any route file or whatsapp-client.ts.
3. Run `grep -rn "PHONE_NUMBER_ID" src/app/api/` — must show only local variable declarations (`const phoneNumberId`) and usages, never the old import.
4. Run `npm run build` — must succeed (Next.js production build).
  </verify>
  <done>
All 7 consumer routes use `await getWhatsAppClient()` and `await getConfig()` for credentials. Zero process.env reads in any API route or whatsapp-client.ts. TypeScript compiles clean. Next.js build succeeds.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. `grep -rn "process\.env" src/lib/whatsapp-client.ts` returns nothing
4. `grep -rn "process\.env\.\(KAPSO_API_KEY\|PHONE_NUMBER_ID\|WABA_ID\)" src/app/api/` returns nothing
5. `grep -rn "from '@/lib/whatsapp-client'" src/app/api/` shows only `getWhatsAppClient` imports (no `whatsappClient` or `PHONE_NUMBER_ID`)
</verification>

<success_criteria>
- whatsapp-client.ts exports only async getWhatsAppClient() — no Proxy, no PHONE_NUMBER_ID constant
- All 7 route files import getWhatsAppClient + getConfig instead of whatsappClient + PHONE_NUMBER_ID
- templates/route.ts uses await getConfig('WABA_ID') instead of process.env.WABA_ID
- Zero process.env credential reads outside of get-config.ts ENV_FALLBACKS
- TypeScript compiles, Next.js builds
</success_criteria>

<output>
After completion, create `.planning/phases/04-config-migration/04-01-SUMMARY.md`
</output>
