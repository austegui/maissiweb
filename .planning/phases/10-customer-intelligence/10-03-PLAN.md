---
phase: 10-customer-intelligence
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - src/components/contact-panel.tsx
  - src/components/message-view.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Agent can open a contact profile panel from the message view header via a toggle button"
    - "Panel shows editable contact fields (display name, email, notes) that save on blur"
    - "Panel shows a collapsible notes section with newest-first notes, each showing author and timestamp"
    - "Agent can add a new note via textarea + button in the notes section"
    - "Panel shows conversation history for the same phone number"
    - "Panel is hidden on mobile (below md breakpoint)"
    - "Panel refreshes data when switching conversations"
    - "Internal notes are never sent to the customer"
  artifacts:
    - path: "src/components/contact-panel.tsx"
      provides: "Right side panel with contact info, conversation history, and notes"
      min_lines: 150
    - path: "src/components/message-view.tsx"
      provides: "Panel toggle button in header"
      contains: "onTogglePanel"
    - path: "src/app/page.tsx"
      provides: "Panel state management and ContactPanel rendering"
      contains: "showContactPanel"
  key_links:
    - from: "src/components/contact-panel.tsx"
      to: "/api/contacts/[phone]"
      via: "fetch on mount/phoneNumber change"
      pattern: "fetch.*api/contacts"
    - from: "src/components/contact-panel.tsx"
      to: "/api/conversations/[id]/notes"
      via: "fetch on mount/conversationId change + POST on note submit"
      pattern: "fetch.*api/conversations.*notes"
    - from: "src/app/page.tsx"
      to: "src/components/contact-panel.tsx"
      via: "conditional render as flex sibling"
      pattern: "showContactPanel.*ContactPanel"
    - from: "src/components/message-view.tsx"
      to: "src/app/page.tsx"
      via: "onTogglePanel callback prop"
      pattern: "onTogglePanel"
---

<objective>
Build the contact panel UI component and integrate it into the message view layout.

Purpose: This plan delivers the user-facing features: agents can view/edit contact profiles, see conversation history, and add internal notes -- all from a right-side panel alongside the active conversation.
Output: One new component (contact-panel.tsx) and modifications to message-view.tsx (toggle button) and page.tsx (panel state + rendering).
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-customer-intelligence/10-RESEARCH.md
@.planning/phases/10-customer-intelligence/10-02-SUMMARY.md
@src/app/page.tsx
@src/components/message-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @radix-ui/react-collapsible and create ContactPanel component</name>
  <files>src/components/contact-panel.tsx</files>
  <action>
**Step 1: Install dependency**

Run: `npm install @radix-ui/react-collapsible`

**Step 2: Create `src/components/contact-panel.tsx`**

This is a 'use client' component with these sections:

**Props:**
```typescript
type ContactPanelProps = {
  conversationId: string;
  phoneNumber: string;
  contactName?: string;
  onClose: () => void;
  conversationHistory: { id: string; contactName?: string; convStatus?: string; lastActiveAt?: string }[];
};
```

**Internal types:**
```typescript
type Contact = {
  phone_number: string;
  display_name: string | null;
  email: string | null;
  notes: string | null;
  whatsapp_name: string | null;
};
type Note = {
  id: string;
  content: string;
  createdAt: string;
  authorName: string;
};
```

**State:**
- `contact: Contact | null` (fetched from API)
- `notes: Note[]` (fetched from API)
- `loading: boolean` (initial load)
- `noteInput: string` (textarea value)
- `submittingNote: boolean`
- `notesOpen: boolean` (Collapsible state, default true)

**Data fetching (useEffect on phoneNumber change):**
- Fetch `GET /api/contacts/${encodeURIComponent(phoneNumber)}?name=${encodeURIComponent(contactName)}` -- auto-creates contact via upsert
- Set `contact` state from `data.data`

**Data fetching (useEffect on conversationId change):**
- Fetch `GET /api/conversations/${conversationId}/notes`
- Set `notes` state from `data.data`

**EditableField sub-component (inline):**
- Props: `label, value, placeholder, onSave, type?`
- Local state: `localValue`, `saving`
- useEffect to sync `localValue` when `value` prop changes (conversation switch)
- onBlur handler: if trimmed value differs from original, call `onSave(trimmed)` via PATCH to `/api/contacts/${encodeURIComponent(phoneNumber)}`
- Render: `<label>` with text-[10px] uppercase + `<input>` with border-bottom-only styling (transparent border, shows on hover/focus)

**Field save handlers:**
- `handleSaveField(field, value)`: PATCH to `/api/contacts/${encodeURIComponent(phoneNumber)}` with `{ [field]: value }`. Update `contact` state locally on success.

**Note submission handler (handleAddNote):**
- POST to `/api/conversations/${conversationId}/notes` with `{ content: noteInput.trim() }`
- On success: clear noteInput, re-fetch notes from GET endpoint (simplest approach, no optimistic update needed for notes)

**Layout (outer div):**
```
<div className="hidden md:flex flex-col w-80 flex-shrink-0 border-l border-[#d1d7db] bg-white overflow-y-auto">
```

**Panel header:**
- Display name (or whatsapp_name, or phone_number as fallback) in bold
- Phone number in small text below
- X close button calling onClose

**Contact info section:**
- EditableField for display_name (label: "Nombre", placeholder: "Agregar nombre...")
- EditableField for email (label: "Email", placeholder: "Agregar email...", type: "email")
- EditableField for notes (label: "Notas de contacto", placeholder: "Agregar notas...") -- this is the contact-level notes field, not per-conversation notes

**Conversation history section:**
- Section header: "Historial ({history.length})" in text-[10px] uppercase
- List each conversation with formatted date and status dot (reuse STATUS_DOT colors: green-500 abierto, amber-500 pendiente, gray-400 resuelto)
- Use `format(new Date(lastActiveAt), 'dd MMM yyyy')` from date-fns for dates

**Notes section (Radix Collapsible):**
- `Collapsible.Root` with open={notesOpen} onOpenChange={setNotesOpen}
- Header row: "Notas internas" label + Collapsible.Trigger with ChevronDown icon (rotate-180 when open)
- `Collapsible.Content` with overflow-hidden:
  - Textarea (rows={3}, bg-[#fffde7] yellow tint for internal notes) + "Guardar nota" button
  - Notes list: each note in a bg-[#fffde7] card with content, author name, and formatted timestamp using `format(new Date(createdAt), 'dd MMM, HH:mm')` from date-fns

**Imports:**
- `useState, useEffect` from react
- `format` from date-fns
- `X, ChevronDown` from lucide-react
- `* as Collapsible` from @radix-ui/react-collapsible
- `cn` from @/lib/utils

**Important styling notes:**
- Yellow tint (#fffde7) for notes to visually distinguish internal notes from customer messages
- Use the project's WhatsApp-style color palette (#111b21, #667781, #00a884, #d1d7db, #f0f2f5)
- Panel is `hidden md:flex` -- invisible on mobile
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify the file exists and imports Collapsible from the installed package.
  </verify>
  <done>
ContactPanel component renders contact info (editable), conversation history, and collapsible internal notes section. Fetches data from /api/contacts and /api/conversations/[id]/notes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add panel toggle to message-view.tsx and integrate panel in page.tsx</name>
  <files>src/components/message-view.tsx, src/app/page.tsx</files>
  <action>
**Part A: Modify message-view.tsx**

1. Add two new optional props to the Props type:
   - `onTogglePanel?: () => void`
   - `isPanelOpen?: boolean`

2. Add these props to the destructured parameters in the component function signature.

3. In the header's right-side button group (the `<div className="flex items-center gap-2 flex-shrink-0">` section), add a panel toggle button BEFORE the RefreshCw button:

```tsx
{conversationId && (
  <Button
    onClick={() => onTogglePanel?.()}
    variant="ghost"
    size="icon"
    className={cn(
      "text-[#667781] hover:bg-[#f0f2f5]",
      isPanelOpen && "bg-[#e9f5f2] text-[#00a884]"
    )}
    title="Panel de contacto"
  >
    <UserRound className="h-4 w-4" />
  </Button>
)}
```

Note: `UserRound` is already imported in message-view.tsx (used in the handoff banner). No new import needed.

**Part B: Modify page.tsx**

1. Add import at top: `import { ContactPanel } from '@/components/contact-panel';`

2. Add state in Home component: `const [showContactPanel, setShowContactPanel] = useState(false);`

3. Add `useState` is already imported. No change needed for imports from react.

4. Pass new props to MessageView:
   - `onTogglePanel={() => setShowContactPanel(p => !p)}`
   - `isPanelOpen={showContactPanel}`

5. After the `<MessageView ... />` closing tag but still inside the `<div className="flex flex-1 overflow-hidden">`, add:

```tsx
{showContactPanel && selectedConversation && (
  <ContactPanel
    key={selectedConversation.id}
    conversationId={selectedConversation.id}
    phoneNumber={selectedConversation.phoneNumber}
    contactName={selectedConversation.contactName}
    onClose={() => setShowContactPanel(false)}
    conversationHistory={conversations?.filter(c => c.phoneNumber === selectedConversation.phoneNumber) ?? []}
  />
)}
```

Note: The `key={selectedConversation.id}` forces a remount on conversation switch, ensuring fresh data fetch. This avoids stale data from the previous conversation.

6. **Conversations list access:** The `conversations` array is NOT currently stored in page.tsx state -- it's fetched inside ConversationList. To pass conversation history to ContactPanel, add a new state:

```typescript
const [conversations, setConversations] = useState<Conversation[]>([]);
```

Update `handleConversationsLoaded` to also store conversations:

```typescript
const handleConversationsLoaded = (convs: Conversation[], meta?: { agents: { id: string; displayName: string }[]; currentUserId: string | null }) => {
  onConversationsUpdated(convs);
  setConversations(convs);
  if (meta?.agents) setAgents(meta.agents);
  if (meta?.currentUserId) setCurrentUserId(meta.currentUserId);
};
```

7. Extend the Conversation type at the top of page.tsx to include `lastActiveAt` if not already present. Check the ConversationList component -- if it passes objects with a `lastActiveAt` or similar timestamp field, include it. If not available, the conversation history section will gracefully handle undefined dates.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify message-view.tsx has the UserRound toggle button. Verify page.tsx renders ContactPanel conditionally inside the flex container.
  </verify>
  <done>
Message view header has a UserRound toggle button for the contact panel. page.tsx manages panel open/close state and renders ContactPanel as a flex sibling of MessageView. Panel re-mounts on conversation switch.
  </done>
</task>

</tasks>

<verification>
- ContactPanel renders alongside MessageView in the flex layout
- Panel toggle button in message-view header uses UserRound icon with active state styling
- Panel auto-creates contact on open (via GET with upsert)
- Contact fields save on blur via PATCH
- Notes are submitted via POST to /api/conversations/[id]/notes (never to /api/messages/send)
- Notes section uses Radix Collapsible
- Panel uses `key={conversationId}` to force remount on conversation switch
- Panel is `hidden md:flex` (invisible on mobile)
- No TypeScript errors across all modified files
</verification>

<success_criteria>
Agent can open the contact panel from the message view, view/edit contact info, see conversation history, and add internal notes. Notes are visually distinct (yellow tint) and never sent to the customer. Panel works correctly when switching between conversations.
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-intelligence/10-03-SUMMARY.md`
</output>
