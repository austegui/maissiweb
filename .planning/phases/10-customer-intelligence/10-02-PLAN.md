---
phase: 10-customer-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/app/api/contacts/[phone]/route.ts
  - src/app/api/conversations/[id]/notes/route.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/contacts/[phone] returns the contact profile, creating it via upsert if absent"
    - "PATCH /api/contacts/[phone] updates display_name, email, and/or notes fields"
    - "GET /api/conversations/[id]/notes returns notes newest-first with author display name"
    - "POST /api/conversations/[id]/notes inserts a new note with the authenticated user as author"
    - "Notes API is completely separate from the message-sending code path"
  artifacts:
    - path: "src/app/api/contacts/[phone]/route.ts"
      provides: "Contact profile CRUD (GET with upsert + PATCH)"
      exports: ["GET", "PATCH"]
    - path: "src/app/api/conversations/[id]/notes/route.ts"
      provides: "Internal notes CRUD (GET + POST)"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/api/contacts/[phone]/route.ts"
      to: "Supabase contacts table"
      via: "upsert with ignoreDuplicates then select"
      pattern: "supabase.*from.*contacts.*upsert"
    - from: "src/app/api/conversations/[id]/notes/route.ts"
      to: "Supabase conversation_notes table"
      via: "insert with author_id from authenticated user"
      pattern: "supabase.*from.*conversation_notes.*insert"
    - from: "src/app/api/conversations/[id]/notes/route.ts"
      to: "Supabase user_profiles table"
      via: "FK join for author display name"
      pattern: "user_profiles.*display_name"
---

<objective>
Create backend API routes for contact profiles and internal conversation notes.

Purpose: These routes provide the data layer for the contact panel UI. Contact profiles are auto-created on first access via upsert. Notes are append-only with author attribution. Both are completely separate from the WhatsApp message-sending code path.
Output: Two new route handler files providing GET+PATCH for contacts and GET+POST for notes.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-customer-intelligence/10-RESEARCH.md
@src/app/api/conversations/[id]/status/route.ts (reference for route handler pattern, params-as-Promise, auth check)
@src/lib/supabase/server.ts (createClient import)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contact profile API route (GET + PATCH)</name>
  <files>src/app/api/contacts/[phone]/route.ts</files>
  <action>
Create `src/app/api/contacts/[phone]/route.ts` with two handlers:

**GET handler:**
1. Extract `phone` from `await params` (Next.js 15 async params)
2. Auth check via `supabase.auth.getUser()` -- return 401 if no user
3. Read optional `name` query param from URL (WhatsApp profile name from caller)
4. Upsert into contacts: `supabase.from('contacts').upsert({ phone_number: phone, whatsapp_name: name }, { onConflict: 'phone_number', ignoreDuplicates: true })` -- this creates the row if absent but never overwrites existing data
5. After upsert, read the contact: `supabase.from('contacts').select('phone_number, display_name, email, notes, whatsapp_name, created_at').eq('phone_number', phone).single()`
6. Return `{ data: contact }` as JSON

**PATCH handler:**
1. Extract `phone` from `await params`
2. Auth check
3. Parse JSON body with try/catch for malformed JSON (return 400)
4. Accept optional fields: `displayName`, `email`, `notes` (camelCase from client, snake_case in DB)
5. Build updates object: only include fields that are `!== undefined`. Always set `updated_at: new Date().toISOString()`
6. `supabase.from('contacts').update(updates).eq('phone_number', phone)`
7. Return `{ success: true }`

**Important:**
- Use `import { createClient } from '@/lib/supabase/server'` (existing pattern)
- Type params as `{ params: Promise<{ phone: string }> }`
- Use `NextResponse.json()` for responses
- Error messages in Spanish: 'No autorizado' (401), 'Cuerpo invalido' (400)
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors in the new file. Verify the file exists at the correct path.
  </verify>
  <done>
GET /api/contacts/[phone] auto-creates and returns a contact profile. PATCH /api/contacts/[phone] updates editable fields. Both require authentication.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create conversation notes API route (GET + POST)</name>
  <files>src/app/api/conversations/[id]/notes/route.ts</files>
  <action>
Create `src/app/api/conversations/[id]/notes/route.ts` with two handlers:

**GET handler:**
1. Extract `id` from `await params` (conversation ID)
2. Auth check via `supabase.auth.getUser()` -- return 401 if no user
3. Query notes with author join:
   ```
   supabase.from('conversation_notes')
     .select('id, content, created_at, user_profiles ( display_name )')
     .eq('conversation_id', id)
     .order('created_at', { ascending: false })
   ```
4. Flatten the join result: map each note to `{ id, content, createdAt: n.created_at, authorName: n.user_profiles?.display_name ?? 'Agente' }`
5. Return `{ data: notes }`

**POST handler:**
1. Extract `id` from `await params`
2. Auth check -- return 401 if no user
3. Parse JSON body, extract `content` field
4. Validate: if `!content?.trim()` return 400 with error 'El contenido es requerido'
5. Insert note: `supabase.from('conversation_notes').insert({ conversation_id: id, author_id: user.id, content: content.trim() })`
6. Return `{ success: true }`

**Critical safety rule:** This route ONLY writes to `conversation_notes` table in Supabase. It NEVER calls `/api/messages/send`, `getWhatsAppClient`, or any WhatsApp-related function. Notes are physically separate from the message-sending code path.

**Important:**
- `author_id` is `user.id` from `supabase.auth.getUser()` -- this is the auth.users UUID that matches user_profiles.id
- Type the `user_profiles` join result correctly: cast as `{ display_name: string } | null`
- Use `NextResponse.json()` for responses
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify the file exists at `src/app/api/conversations/[id]/notes/route.ts`. Grep the file to confirm it does NOT import from whatsapp-client or reference /api/messages/send.
  </verify>
  <done>
GET /api/conversations/[id]/notes returns notes newest-first with author name. POST inserts a new note attributed to the authenticated user. Notes never touch the WhatsApp message path.
  </done>
</task>

</tasks>

<verification>
- Both route files exist and compile without TypeScript errors
- Contact route uses upsert-then-read pattern (two Supabase calls, not chained .select() on upsert)
- Notes route joins user_profiles for author name
- Notes route has zero imports from whatsapp-client.ts or message-sending modules
- All params are awaited (Next.js 15 pattern)
- All routes check authentication
</verification>

<success_criteria>
Four API endpoints work correctly: GET/PATCH contacts, GET/POST notes. Contact auto-creation via upsert is idempotent. Notes are append-only and physically separate from messaging.
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-intelligence/10-02-SUMMARY.md`
</output>
