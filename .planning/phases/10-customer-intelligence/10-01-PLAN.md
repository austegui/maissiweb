---
phase: 10-customer-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "contacts table exists in Supabase with phone_number PK and editable fields (display_name, email, notes, whatsapp_name)"
    - "conversation_notes table exists with author_id FK to user_profiles and append-only RLS (no UPDATE/DELETE)"
    - "Existing phone numbers from conversation_contact_labels are backfilled into contacts"
  artifacts:
    - path: "Supabase: public.contacts"
      provides: "Contact profile storage keyed by phone number"
      contains: "phone_number TEXT PRIMARY KEY"
    - path: "Supabase: public.conversation_notes"
      provides: "Internal notes per conversation"
      contains: "conversation_id TEXT NOT NULL, author_id UUID"
  key_links:
    - from: "conversation_notes.author_id"
      to: "user_profiles.id"
      via: "FK reference with ON DELETE SET NULL"
      pattern: "REFERENCES public.user_profiles"
---

<objective>
Create the contacts and conversation_notes tables in Supabase with RLS policies.

Purpose: These tables are the data foundation for contact profiles and internal notes. All subsequent plans depend on these tables existing.
Output: Two new Supabase tables with RLS policies and a one-time backfill of existing phone numbers.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-customer-intelligence/10-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create contacts and conversation_notes tables in Supabase</name>
  <action>
Run the following SQL in Supabase Dashboard > SQL Editor. Execute each block separately to isolate errors.

**Block 1: contacts table**

```sql
CREATE TABLE public.contacts (
  phone_number      TEXT PRIMARY KEY,
  display_name      TEXT,
  email             TEXT,
  notes             TEXT,
  whatsapp_name     TEXT,
  created_at        TIMESTAMPTZ DEFAULT now(),
  updated_at        TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE public.contacts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Agents can read contacts"
  ON public.contacts FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Agents can insert contacts"
  ON public.contacts FOR INSERT
  TO authenticated
  WITH CHECK (true);

CREATE POLICY "Agents can update contacts"
  ON public.contacts FOR UPDATE
  TO authenticated
  USING (true);
```

**Block 2: conversation_notes table**

```sql
CREATE TABLE public.conversation_notes (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id  TEXT NOT NULL,
  author_id        UUID REFERENCES public.user_profiles(id) ON DELETE SET NULL,
  content          TEXT NOT NULL,
  created_at       TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE public.conversation_notes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Agents can read notes"
  ON public.conversation_notes FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Agents can insert notes"
  ON public.conversation_notes FOR INSERT
  TO authenticated
  WITH CHECK (true);
```

Note: author_id is nullable (ON DELETE SET NULL) so notes survive if a user account is deleted. No UPDATE or DELETE policies -- notes are append-only.

**Block 3: Backfill existing phone numbers into contacts**

```sql
INSERT INTO public.contacts (phone_number)
SELECT DISTINCT phone_number
FROM public.conversation_contact_labels
ON CONFLICT (phone_number) DO NOTHING;
```

This only covers phone numbers that have labels. All other phone numbers are auto-created lazily when the contact panel is opened.
  </action>
  <how-to-verify>
    1. In Supabase Table Editor, confirm "contacts" table exists with columns: phone_number, display_name, email, notes, whatsapp_name, created_at, updated_at
    2. Confirm "conversation_notes" table exists with columns: id, conversation_id, author_id, content, created_at
    3. Check RLS is enabled on both tables (lock icon visible)
    4. Verify backfilled rows in contacts table (should have rows from conversation_contact_labels)
  </how-to-verify>
  <resume-signal>Type "done" when all three SQL blocks have been executed successfully</resume-signal>
</task>

</tasks>

<verification>
- contacts table has phone_number TEXT PK, display_name, email, notes, whatsapp_name columns
- conversation_notes table has UUID PK, conversation_id TEXT, author_id UUID (nullable FK), content TEXT
- RLS enabled on both tables with SELECT+INSERT on both, UPDATE only on contacts, no UPDATE/DELETE on notes
- Backfill ran without errors
</verification>

<success_criteria>
Both tables exist in Supabase with correct schema and RLS policies. Existing phone numbers are backfilled into contacts.
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-intelligence/10-01-SUMMARY.md`
</output>
