---
phase: 13-error-tracking-user-management
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/app/admin/users/actions.ts
  - src/app/admin/users/page.tsx
  - src/app/admin/users/UsersManager.tsx
  - src/app/admin/settings/page.tsx
autonomous: true

user_setup:
  - service: supabase
    why: "Admin client needs service role key for user management"
    env_vars:
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (under 'Project API keys')"
    dashboard_config: []

must_haves:
  truths:
    - "An admin can create a new team member by entering email, password, and display name"
    - "After creation, a dialog shows the credentials with a copy button for sharing"
    - "The user management page shows all members with display name, email, role, status, and last login"
    - "An admin can change a member's role via an inline dropdown (immediate, no confirmation)"
    - "An admin can deactivate a member via a confirmation dialog, and reactivate later"
    - "An admin cannot modify their own role or deactivate themselves"
    - "A link from the settings page navigates to user management"
  artifacts:
    - path: "src/app/admin/users/actions.ts"
      provides: "Server Actions for create, update role, deactivate, reactivate"
      exports: ["createMember", "updateMemberRole", "deactivateMember", "reactivateMember"]
    - path: "src/app/admin/users/page.tsx"
      provides: "Server Component that fetches users from auth + profiles"
    - path: "src/app/admin/users/UsersManager.tsx"
      provides: "Client Component with user table, create form, role dropdown, deactivation"
    - path: "src/app/admin/settings/page.tsx"
      provides: "Updated settings page with link to /admin/users"
  key_links:
    - from: "src/app/admin/users/actions.ts"
      to: "src/lib/supabase/admin.ts"
      via: "import createAdminClient"
      pattern: "import.*createAdminClient.*from.*admin"
    - from: "src/app/admin/users/page.tsx"
      to: "src/app/admin/users/UsersManager.tsx"
      via: "component import"
      pattern: "import.*UsersManager"
    - from: "src/app/admin/users/page.tsx"
      to: "src/lib/supabase/admin.ts"
      via: "import createAdminClient for listUsers"
      pattern: "import.*createAdminClient.*from.*admin"
    - from: "src/app/admin/users/UsersManager.tsx"
      to: "src/app/admin/users/actions.ts"
      via: "Server Action calls"
      pattern: "import.*from.*actions"
    - from: "src/app/admin/settings/page.tsx"
      to: "/admin/users"
      via: "Link href"
      pattern: 'href="/admin/users"'
---

<objective>
Build the complete user management feature: server actions for CRUD operations, a page listing all team members, and interactive controls for creating, updating roles, deactivating, and reactivating members.

Purpose: Admins can manage team members directly from the app without touching the Supabase dashboard.
Output: Full user management UI at `/admin/users` with all CRUD operations, plus a navigation link from the settings page.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-error-tracking-user-management/13-CONTEXT.md
@.planning/phases/13-error-tracking-user-management/13-RESEARCH.md
@.planning/phases/13-error-tracking-user-management/13-01-SUMMARY.md

@src/lib/supabase/admin.ts (admin client from Plan 01)
@src/lib/supabase/server.ts (anon server client pattern)
@src/app/admin/layout.tsx (admin guard -- already protects /admin/*)
@src/app/admin/labels/actions.ts (Server Actions pattern with requireAdmin)
@src/app/admin/settings/page.tsx (settings page to add nav link)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for user management</name>
  <files>src/app/admin/users/actions.ts</files>
  <action>
Create `src/app/admin/users/actions.ts` with `'use server'` directive.

Export a `ActionResult` type: `{ success: boolean; message: string }`.

Create a private `requireAdmin()` helper (same pattern as labels/actions.ts):
- Create anon client via `createClient()` from `@/lib/supabase/server`
- Get current user via `supabase.auth.getUser()`
- Check `user_profiles.role === 'admin'`
- Return `{ user, supabase }` or throw

Export 4 Server Actions:

**`createMember(email: string, password: string, displayName: string, role: 'admin' | 'agent')`**
Returns `ActionResult & { credentials?: { email: string; password: string } }`.
- Call `requireAdmin()`
- Create admin client via `createAdminClient()` from `@/lib/supabase/admin`
- Validate: email must be non-empty, password >= 6 chars, displayName non-empty
- Call `adminClient.auth.admin.createUser({ email, password, email_confirm: true, user_metadata: { full_name: displayName } })`
- Handle "already been registered" error with Spanish message
- After creation, upsert `user_profiles` with `{ id: data.user.id, display_name: displayName, role }` using admin client (handles trigger race condition -- see Research pitfall 5)
- `revalidatePath('/admin/users')`
- Return success with credentials object

**`updateMemberRole(targetUserId: string, newRole: 'admin' | 'agent')`**
Returns `ActionResult`.
- Call `requireAdmin()`
- Self-modification guard: if `adminUser.id === targetUserId`, return error "No puedes cambiar tu propio rol"
- Use admin client to update `user_profiles.role`
- `revalidatePath('/admin/users')`

**`deactivateMember(targetUserId: string)`**
Returns `ActionResult`.
- Call `requireAdmin()`
- Self-deactivation guard: if `adminUser.id === targetUserId`, return error "No puedes desactivarte a ti mismo"
- Use admin client: `auth.admin.updateUserById(targetUserId, { ban_duration: '876000h' })`
- `revalidatePath('/admin/users')`

**`reactivateMember(targetUserId: string)`**
Returns `ActionResult`.
- Call `requireAdmin()`
- Use admin client: `auth.admin.updateUserById(targetUserId, { ban_duration: 'none' })`
- `revalidatePath('/admin/users')`

All actions wrapped in try/catch returning ActionResult on error.
  </action>
  <verify>File exports `createMember`, `updateMemberRole`, `deactivateMember`, `reactivateMember`. Each action calls `requireAdmin()` first. Self-modification checks exist in updateMemberRole and deactivateMember. Uses `createAdminClient` for all admin operations.</verify>
  <done>All four user management operations are available as Server Actions with proper auth guards and self-modification prevention.</done>
</task>

<task type="auto">
  <name>Task 2: Create user management page and client component, add settings nav link</name>
  <files>src/app/admin/users/page.tsx, src/app/admin/users/UsersManager.tsx, src/app/admin/settings/page.tsx</files>
  <action>
**File 1: `src/app/admin/users/page.tsx` (Server Component)**

- Import `createAdminClient` from `@/lib/supabase/admin` and `createClient` from `@/lib/supabase/server`
- Import `UsersManager` from `./UsersManager`
- Fetch auth users and profiles in parallel using `Promise.all`:
  - `adminClient.auth.admin.listUsers({ page: 1, perPage: 1000 })`
  - `supabase.from('user_profiles').select('id, display_name, role')`
- Get current user via `supabase.auth.getUser()`
- Join auth data with profiles in memory using a Map keyed by user id
- Build users array with: `id`, `email`, `displayName`, `role` ('admin' | 'agent'), `isActive` (check `banned_until`), `lastSignInAt`
- `isActive` logic: `!authUser.banned_until || new Date(authUser.banned_until) < new Date()`
- Render `<UsersManager users={users} currentUserId={currentUser.id} />`

**File 2: `src/app/admin/users/UsersManager.tsx` (Client Component)**

`'use client'` directive. Receives `users` array and `currentUserId` string as props.

Define a `User` type: `{ id: string; email: string; displayName: string; role: 'admin' | 'agent'; isActive: boolean; lastSignInAt: string | null }`.

UI sections:

**Header area:**
- Title: "Gestion de miembros" (h1)
- Back link to `/admin/settings` (same pattern as settings page)
- "Crear miembro" button that shows/hides a creation form

**Create form (toggleable, shown below header when active):**
- Three fields: email (type email), password (type text, min 6 chars), display name (text)
- Role selector: native `<select>` with "Agente" (default) and "Admin"
- "Crear" submit button (green `#00a884`)
- On submit: call `createMember()` server action
- On success: show a dialog/modal with credentials (email + password) and a "Copiar credenciales" button that copies `Email: {email}\nPassword: {password}` to clipboard via `navigator.clipboard.writeText()`
- Dialog has a "Cerrar" button that dismisses it and resets the form
- On error: show error message inline below the form
- Use `useState` for form visibility, loading state, result, and dialog visibility

**User list (table):**
- Columns: Nombre (display name), Email, Rol (badge), Estado (active/inactive), Ultimo acceso (last login formatted)
- Role column: For non-current-user rows, render a native `<select>` with Admin/Agente options that calls `updateMemberRole()` on change. For the current user's row, render a static badge (no dropdown).
- Status column: green dot + "Activo" or red dot + "Inactivo"
- For inactive users: show a "Reactivar" button that calls `reactivateMember()`
- For active non-self users: show a "Desactivar" button
- Deactivation: clicking "Desactivar" shows a confirmation prompt (use `window.confirm("Desactivar a {email}?")` for simplicity, or a simple inline confirm state). Call `deactivateMember()` on confirm.
- Current user's row: disable role dropdown and deactivate button (or hide them entirely)
- Last login: format as locale date string, show "--" if null
- Style with Tailwind: clean table with borders, hover states, role badges with colors (admin = purple/indigo, agent = green/teal)

**File 3: `src/app/admin/settings/page.tsx` (modify existing)**

Add a navigation link to `/admin/users` below the existing "Back to inbox" link or as a section link:
- Text: "Gestion de miembros" with a right arrow
- Use `Link` component (already imported in this file)
- Style: `text-sm text-[#00a884] hover:underline`
- Place it as a second link in the header area, below the back link
  </action>
  <verify>
1. `/admin/users` page renders a user list (Server Component fetches data, Client Component renders it)
2. Create form appears on button click, calls `createMember` action, shows credentials dialog on success
3. Role dropdown calls `updateMemberRole` on change (disabled for current user)
4. Deactivate button calls `deactivateMember` with confirmation (hidden for current user)
5. Reactivate button visible for inactive users
6. Settings page has link to `/admin/users`
  </verify>
  <done>User management page at /admin/users is fully functional with create, list, role change, deactivate/reactivate. Settings page links to it.</done>
</task>

</tasks>

<verification>
1. Navigate to `/admin/users` -- page loads showing all team members with name, email, role, status, last login
2. Click "Crear miembro" -- form appears with email, password, display name, role fields
3. Submit form -- credentials dialog shows with copy button
4. Change a member's role via dropdown -- applies immediately
5. Click "Desactivar" on a member -- confirmation appears, member marked inactive after confirm
6. Click "Reactivar" on an inactive member -- member reactivated
7. Current admin's row has no role dropdown and no deactivate button
8. Settings page at `/admin/settings` has a link to `/admin/users`
9. Page is protected by existing `/admin/layout.tsx` guard (agents redirected)
</verification>

<success_criteria>
- All four CRUD operations work (create, update role, deactivate, reactivate)
- Self-modification is prevented in both UI and server actions
- Credentials dialog with clipboard copy appears after member creation
- User list shows accurate data from auth + profiles join
- Navigation from settings to user management works
</success_criteria>

<output>
After completion, create `.planning/phases/13-error-tracking-user-management/13-02-SUMMARY.md`
</output>
