---
phase: 13-error-tracking-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/global-error.tsx
  - src/lib/supabase/admin.ts
autonomous: true

must_haves:
  truths:
    - "When an unrecoverable error occurs, the user sees a branded Maissi error page with retry and home buttons instead of a blank screen"
    - "A server-only Supabase admin client exists that can perform auth.admin operations"
  artifacts:
    - path: "src/app/global-error.tsx"
      provides: "Root-level error boundary with branded Maissi page"
      contains: "'use client'"
    - path: "src/lib/supabase/admin.ts"
      provides: "Service role Supabase client factory"
      exports: ["createAdminClient"]
  key_links:
    - from: "src/app/global-error.tsx"
      to: "/maissi-logo.svg"
      via: "img src"
      pattern: 'src="/maissi-logo.svg"'
    - from: "src/lib/supabase/admin.ts"
      to: "SUPABASE_SERVICE_ROLE_KEY"
      via: "process.env"
      pattern: "process\\.env\\.SUPABASE_SERVICE_ROLE_KEY"
---

<objective>
Create the global error page and Supabase admin client utility that Plan 02 depends on.

Purpose: The error page gives users a branded recovery experience instead of a blank screen on crashes. The admin client enables all user management operations in Plan 02.
Output: `src/app/global-error.tsx` (branded error boundary) and `src/lib/supabase/admin.ts` (service role client factory).
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-error-tracking-user-management/13-CONTEXT.md
@.planning/phases/13-error-tracking-user-management/13-RESEARCH.md

@src/lib/supabase/server.ts (existing Supabase server client pattern)
@public/maissi-logo.svg (logo used in error page)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create branded global error page</name>
  <files>src/app/global-error.tsx</files>
  <action>
Create `src/app/global-error.tsx` as a Client Component (`'use client'`).

This file REPLACES the root layout when triggered, so it MUST include its own `<html lang="es">` and `<body>` tags.

Use INLINE STYLES only (not Tailwind classes) because CSS variables from globals.css are not available when the root layout is replaced. Brand colors: primary `#00a884`, text `#111b21`, secondary text `#667781`, background `#f0f2f5`, border `#e9edef`.

The component receives `{ error, reset }` props (Next.js convention).

Content (all Spanish):
- `<head>` with `<title>Algo salio mal -- Maissi</title>` and viewport meta
- Logo: `<img src="/maissi-logo.svg" alt="Maissi" />` (height ~2.5rem)
- Heading: "Algo salio mal"
- Body text: "Estamos trabajando en ello. Por favor intenta de nuevo."
- Two buttons side by side:
  - "Intentar de nuevo" (primary, green `#00a884`, calls `reset()`)
  - "Volver al inicio" (secondary, border style, `<a href="/">`)
- Centered vertically and horizontally with flex column, min-height 100vh

Do NOT use accent characters (tildes) in the inline text to avoid encoding issues -- use plain ASCII.
  </action>
  <verify>File exists at `src/app/global-error.tsx`, contains `'use client'`, contains `<html` and `<body`, contains `reset()`, contains `maissi-logo.svg`.</verify>
  <done>A branded Maissi error page renders with retry and home buttons when an unrecoverable error occurs.</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase admin client utility</name>
  <files>src/lib/supabase/admin.ts</files>
  <action>
Create `src/lib/supabase/admin.ts` exporting a `createAdminClient()` function.

This client uses `createClient` from `@supabase/supabase-js` (NOT `@supabase/ssr`) because it uses a static service role key, not cookie-based sessions.

Implementation:
- Import `createClient` from `@supabase/supabase-js`
- Read `process.env.NEXT_PUBLIC_SUPABASE_URL` and `process.env.SUPABASE_SERVICE_ROLE_KEY`
- Throw descriptive error if either is missing
- Create client with auth options: `persistSession: false`, `autoRefreshToken: false`, `detectSessionInUrl: false`
- Return the client

This file is server-only -- it must never be imported from Client Components. The environment variable `SUPABASE_SERVICE_ROLE_KEY` has no `NEXT_PUBLIC_` prefix, so it is only available on the server.
  </action>
  <verify>File exists at `src/lib/supabase/admin.ts`, exports `createAdminClient`, imports from `@supabase/supabase-js`, references `SUPABASE_SERVICE_ROLE_KEY`.</verify>
  <done>A service role Supabase client factory is available for server-side admin operations.</done>
</task>

</tasks>

<verification>
1. `src/app/global-error.tsx` exists and is a Client Component with html/body tags
2. `src/lib/supabase/admin.ts` exists and exports `createAdminClient()`
3. No new npm packages added (both use existing deps)
4. `SUPABASE_SERVICE_ROLE_KEY` is NOT prefixed with `NEXT_PUBLIC_`
</verification>

<success_criteria>
- global-error.tsx is a valid Next.js error boundary with branded Maissi styling
- admin.ts creates a Supabase client with service role key and correct auth options
- Both files follow established codebase patterns (TypeScript, consistent with server.ts)
</success_criteria>

<output>
After completion, create `.planning/phases/13-error-tracking-user-management/13-01-SUMMARY.md`
</output>
