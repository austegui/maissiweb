---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/middleware.ts
autonomous: false

user_setup:
  - service: supabase
    why: "Authentication backend and app_settings storage"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key (may show as NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY for newer projects)"
    dashboard_config:
      - task: "Create new Supabase project"
        location: "supabase.com -> New project"
      - task: "Run app_settings table SQL in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"
      - task: "Add env vars to Vercel"
        location: "Vercel Dashboard -> Project Settings -> Environment Variables"

must_haves:
  truths:
    - "@supabase/supabase-js and @supabase/ssr are installed as project dependencies"
    - "Browser Supabase client can be created from src/lib/supabase/client.ts"
    - "Server Supabase client can be created from src/lib/supabase/server.ts with async cookies()"
    - "Middleware session updater exists at src/lib/supabase/middleware.ts"
    - "Supabase project exists with email/password auth enabled"
    - "NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are set in Vercel env vars"
    - "app_settings table exists in Supabase with RLS policies for authenticated users"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser-side Supabase client factory"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server-side Supabase client factory with async cookies"
      exports: ["createClient"]
    - path: "src/lib/supabase/middleware.ts"
      provides: "updateSession function for middleware auth flow"
      exports: ["updateSession"]
  key_links:
    - from: "src/lib/supabase/client.ts"
      to: "process.env.NEXT_PUBLIC_SUPABASE_URL"
      via: "createBrowserClient reads env vars"
      pattern: "NEXT_PUBLIC_SUPABASE_URL"
    - from: "src/lib/supabase/server.ts"
      to: "next/headers cookies()"
      via: "await cookies() for server-side cookie access"
      pattern: "await cookies\\(\\)"
    - from: "src/lib/supabase/middleware.ts"
      to: "supabase.auth.getUser()"
      via: "Token validation with Supabase Auth servers"
      pattern: "getUser\\(\\)"
---

<objective>
Install Supabase packages and create the three Supabase client utility files that all subsequent auth code depends on. Then checkpoint for the user to create their Supabase project and configure environment variables.

Purpose: These utility files are the foundation layer for all authentication. Login page, server actions, and middleware all import from these files. The Supabase project must exist before any auth code can function.
Output: Three Supabase utility files in src/lib/supabase/, packages installed, user has configured Supabase project + Vercel env vars.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/01-fork-setup/AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase packages and create client utility files</name>
  <files>package.json, package-lock.json, src/lib/supabase/client.ts, src/lib/supabase/server.ts, src/lib/supabase/middleware.ts</files>
  <action>
1. Install the two required Supabase packages:
   ```bash
   npm install @supabase/supabase-js @supabase/ssr
   ```

2. Create directory `src/lib/supabase/`.

3. Create `src/lib/supabase/client.ts` — browser client factory:
   ```typescript
   import { createBrowserClient } from '@supabase/ssr'

   export function createClient() {
     return createBrowserClient(
       process.env.NEXT_PUBLIC_SUPABASE_URL!,
       process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
     )
   }
   ```
   Note: This is for Client Components only. It reads NEXT_PUBLIC_ env vars which are inlined at build time.

4. Create `src/lib/supabase/server.ts` — server client factory:
   ```typescript
   import { createServerClient } from '@supabase/ssr'
   import { cookies } from 'next/headers'

   export async function createClient() {
     const cookieStore = await cookies()

     return createServerClient(
       process.env.NEXT_PUBLIC_SUPABASE_URL!,
       process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
       {
         cookies: {
           getAll() {
             return cookieStore.getAll()
           },
           setAll(cookiesToSet) {
             try {
               cookiesToSet.forEach(({ name, value, options }) =>
                 cookieStore.set(name, value, options)
               )
             } catch {
               // Called from a Server Component — middleware handles refresh.
               // This error is expected and safe to ignore.
             }
           },
         },
       }
     )
   }
   ```
   CRITICAL: `await cookies()` — Next.js 15 requires async cookies(). Do NOT use synchronous cookies().

5. Create `src/lib/supabase/middleware.ts` — session updater with route protection:
   ```typescript
   import { createServerClient } from '@supabase/ssr'
   import { NextResponse, type NextRequest } from 'next/server'

   export async function updateSession(request: NextRequest) {
     let supabaseResponse = NextResponse.next({ request })

     const supabase = createServerClient(
       process.env.NEXT_PUBLIC_SUPABASE_URL!,
       process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
       {
         cookies: {
           getAll() {
             return request.cookies.getAll()
           },
           setAll(cookiesToSet) {
             cookiesToSet.forEach(({ name, value }) =>
               request.cookies.set(name, value)
             )
             supabaseResponse = NextResponse.next({ request })
             cookiesToSet.forEach(({ name, value, options }) =>
               supabaseResponse.cookies.set(name, value, options)
             )
           },
         },
       }
     )

     // IMPORTANT: always use getUser() not getSession() for server-side validation.
     // getUser() contacts Supabase Auth servers to verify the token.
     // getSession() only reads the local cookie without revalidation.
     const { data: { user } } = await supabase.auth.getUser()

     const path = request.nextUrl.pathname

     // Redirect unauthenticated users to /login (except when already on /login)
     if (!user && path !== '/login') {
       const url = request.nextUrl.clone()
       url.pathname = '/login'
       return NextResponse.redirect(url)
     }

     // Redirect authenticated users away from /login to inbox
     if (user && path === '/login') {
       const url = request.nextUrl.clone()
       url.pathname = '/'
       return NextResponse.redirect(url)
     }

     return supabaseResponse
   }
   ```
   This file contains the route protection logic. The thin middleware.ts wrapper in Plan 02-02 imports updateSession from here.

6. Commit the changes:
   ```bash
   git add package.json package-lock.json src/lib/supabase/
   git commit -m "feat(02-01): install supabase packages and create client utilities"
   ```
  </action>
  <verify>
Confirm all files exist and packages are installed:
```bash
ls src/lib/supabase/client.ts src/lib/supabase/server.ts src/lib/supabase/middleware.ts
grep '"@supabase/supabase-js"' package.json
grep '"@supabase/ssr"' package.json
grep 'await cookies()' src/lib/supabase/server.ts
grep 'getUser()' src/lib/supabase/middleware.ts
```
All commands must succeed.
  </verify>
  <done>
Three Supabase utility files exist in src/lib/supabase/ with correct patterns: browser client uses createBrowserClient, server client uses async cookies(), middleware uses getUser() for token validation. Both @supabase/supabase-js and @supabase/ssr appear in package.json dependencies.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Supabase project, run app_settings SQL, and set env vars in Vercel</action>
  <instructions>
Complete these steps in order:

**Step 1: Create Supabase project**
1. Go to https://supabase.com and sign in (or create account)
2. Click "New project"
3. Choose a name (e.g., "maissi-inbox")
4. Set a database password (save it somewhere secure)
5. Choose a region close to your users
6. Click "Create new project" and wait for it to provision

**Step 2: Get API credentials**
1. In the Supabase dashboard, go to **Project Settings** (gear icon) -> **API**
2. Copy the **Project URL** (looks like `https://xxxx.supabase.co`)
3. Copy the **anon/public** key (starts with `eyJ...` or `sb_publishable_...`)
4. Note: Email/password auth is enabled by default — no configuration needed

**Step 3: Create app_settings table**
1. In Supabase dashboard, go to **SQL Editor**
2. Click "New query" and paste this SQL:

```sql
CREATE TABLE app_settings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  key text UNIQUE NOT NULL,
  value text NOT NULL,
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE app_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can read settings"
  ON app_settings FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Authenticated users can update settings"
  ON app_settings FOR UPDATE
  TO authenticated
  USING (true);

CREATE POLICY "Authenticated users can insert settings"
  ON app_settings FOR INSERT
  TO authenticated
  WITH CHECK (true);
```

3. Click "Run" and confirm the table appears in the Table Editor

**Step 4: Set environment variables in Vercel**
1. Go to your Vercel project dashboard for maissiweb
2. Go to **Settings** -> **Environment Variables**
3. Add these two variables (select all environments: Production, Preview, Development):
   - `NEXT_PUBLIC_SUPABASE_URL` = your Project URL from Step 2
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY` = your anon/public key from Step 2

**Step 5: Create your first user account**
1. In Supabase dashboard, go to **Authentication** -> **Users**
2. Click "Add user" -> "Create new user"
3. Enter your email and a password
4. This will be the account you use to log in to the inbox
  </instructions>
  <resume-signal>Type "done" when all 5 steps are complete, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `npm ls @supabase/supabase-js @supabase/ssr` shows both packages installed
- `src/lib/supabase/client.ts` exports a `createClient` function using `createBrowserClient`
- `src/lib/supabase/server.ts` exports an async `createClient` function using `await cookies()`
- `src/lib/supabase/middleware.ts` exports `updateSession` using `getUser()` (not `getSession()`)
- User confirms Supabase project exists and env vars are set in Vercel
</verification>

<success_criteria>
Both Supabase packages are installed, three utility files exist with correct patterns (async cookies, getUser, createBrowserClient), and the user has created their Supabase project with env vars configured in Vercel.
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
