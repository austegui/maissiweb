---
phase: 02-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/login/page.tsx
  - src/app/login/actions.ts
  - src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "Visiting /login shows a sign-in form with email and password fields"
    - "Submitting valid credentials redirects to the inbox (/)"
    - "Submitting invalid credentials shows an error message on the login page"
    - "Visiting any page without being logged in redirects to /login"
    - "Visiting /login while already logged in redirects to /"
    - "Static assets (_next/static, images, favicon) load without triggering auth checks"
  artifacts:
    - path: "src/app/login/page.tsx"
      provides: "Login page with email/password form"
      min_lines: 20
    - path: "src/app/login/actions.ts"
      provides: "Server Actions for sign-in and sign-out"
      exports: ["login", "logout"]
    - path: "src/middleware.ts"
      provides: "Next.js middleware entry point with static asset matcher"
      exports: ["middleware", "config"]
  key_links:
    - from: "src/app/login/actions.ts"
      to: "src/lib/supabase/server.ts"
      via: "import createClient for server-side auth calls"
      pattern: "from '@/lib/supabase/server'"
    - from: "src/app/login/actions.ts"
      to: "supabase.auth.signInWithPassword"
      via: "Supabase Auth email/password sign-in"
      pattern: "signInWithPassword"
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "import updateSession for auth flow"
      pattern: "from '@/lib/supabase/middleware'"
    - from: "src/app/login/page.tsx"
      to: "src/app/login/actions.ts"
      via: "form action={login} Server Action binding"
      pattern: "action=\\{login\\}"
---

<objective>
Create the login page with email/password form, Server Actions for sign-in/sign-out, and the Next.js middleware entry point that protects all routes.

Purpose: This plan implements the application-level auth layer. After this plan, unauthenticated users are redirected to /login, and authenticated users can access the inbox. The Supabase utility files from 02-01 are consumed here.
Output: Working login page at /login, auth middleware protecting all routes, sign-out action available for logout.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@src/lib/supabase/server.ts
@src/lib/supabase/middleware.ts
@src/app/layout.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login page and auth Server Actions</name>
  <files>src/app/login/page.tsx, src/app/login/actions.ts</files>
  <action>
1. Create `src/app/login/actions.ts` — Server Actions for sign-in and sign-out:
   ```typescript
   'use server'

   import { redirect } from 'next/navigation'
   import { createClient } from '@/lib/supabase/server'

   export async function login(formData: FormData) {
     const supabase = await createClient()

     const { error } = await supabase.auth.signInWithPassword({
       email: String(formData.get('email')),
       password: String(formData.get('password')),
     })

     if (error) {
       // Redirect back to login with error in search params.
       // Using search params keeps login page as a Server Component (simpler).
       redirect('/login?error=' + encodeURIComponent(error.message))
     }

     redirect('/')
   }

   export async function logout() {
     const supabase = await createClient()
     await supabase.auth.signOut()
     redirect('/login')
   }
   ```
   IMPORTANT:
   - Use `await createClient()` — the server.ts factory is async.
   - Use `signInWithPassword` — this is the email/password method.
   - Return errors via search params, NOT by returning an object. The `redirect()` call throws internally in Next.js, so no code after it runs. If error, redirect to /login?error=... instead.
   - The `logout` action is used by the logout button (added later in Phase 5 branding or can be added to inbox page now).

2. Create `src/app/login/page.tsx` — login form as a Server Component:
   ```typescript
   import { login } from './actions'

   export default async function LoginPage({
     searchParams,
   }: {
     searchParams: Promise<{ error?: string }>
   }) {
     const { error } = await searchParams

     return (
       <div className="flex min-h-screen items-center justify-center bg-gray-50">
         <div className="w-full max-w-sm space-y-6 rounded-lg border bg-white p-8 shadow-sm">
           <div className="space-y-2 text-center">
             <h1 className="text-2xl font-bold">Sign in</h1>
             <p className="text-sm text-gray-500">
               Enter your credentials to access the inbox
             </p>
           </div>

           {error && (
             <div className="rounded-md bg-red-50 p-3 text-sm text-red-600">
               {error}
             </div>
           )}

           <form action={login} className="space-y-4">
             <div className="space-y-2">
               <label htmlFor="email" className="text-sm font-medium">
                 Email
               </label>
               <input
                 id="email"
                 name="email"
                 type="email"
                 required
                 className="w-full rounded-md border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="you@example.com"
               />
             </div>

             <div className="space-y-2">
               <label htmlFor="password" className="text-sm font-medium">
                 Password
               </label>
               <input
                 id="password"
                 name="password"
                 type="password"
                 required
                 className="w-full rounded-md border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
               />
             </div>

             <button
               type="submit"
               className="w-full rounded-md bg-blue-600 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
             >
               Sign in
             </button>
           </form>
         </div>
       </div>
     )
   }
   ```
   IMPORTANT:
   - This is a Server Component (no 'use client'). The form uses the `login` Server Action directly.
   - In Next.js 15, `searchParams` is a Promise. Use `await searchParams` to read error param.
   - Styling uses Tailwind CSS classes (already available in the project via globals.css and tailwind.config.ts).
   - The error display reads from `?error=` search param set by the login action on failure.
   - No 'use client' is needed — keeping this as a Server Component is simpler and avoids hydration issues.

3. Commit:
   ```bash
   git add src/app/login/
   git commit -m "feat(02-02): add login page and auth server actions"
   ```
  </action>
  <verify>
```bash
ls src/app/login/page.tsx src/app/login/actions.ts
grep "signInWithPassword" src/app/login/actions.ts
grep "signOut" src/app/login/actions.ts
grep "action={login}" src/app/login/page.tsx
grep "await searchParams" src/app/login/page.tsx
```
All commands must succeed.
  </verify>
  <done>
Login page exists at src/app/login/page.tsx with email/password form using Tailwind styling. Server Actions in actions.ts handle signInWithPassword and signOut. Error display reads from search params. Login page is a Server Component (no 'use client').
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Next.js middleware entry point</name>
  <files>src/middleware.ts</files>
  <action>
1. Verify no existing `src/middleware.ts` file exists (the audit confirmed none exists).

2. Create `src/middleware.ts` — thin wrapper that delegates to updateSession:
   ```typescript
   import { type NextRequest } from 'next/server'
   import { updateSession } from '@/lib/supabase/middleware'

   export async function middleware(request: NextRequest) {
     return updateSession(request)
   }

   export const config = {
     matcher: [
       /*
        * Match all request paths except:
        * - _next/static (static files)
        * - _next/image (image optimization files)
        * - favicon.ico (favicon)
        * - Common image/font file extensions
        */
       '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
     ],
   }
   ```
   IMPORTANT:
   - The `matcher` regex excludes Next.js internal assets and static files from middleware execution. Without this, every JS bundle, image, and font triggers a Supabase auth check — destroying performance (see Pitfall 4 in research).
   - The actual auth logic (getUser, redirect to /login) lives in `src/lib/supabase/middleware.ts` from Plan 02-01. This file is just the Next.js entry point.
   - No webhook endpoint exclusion needed — the app uses polling, not webhooks (confirmed in Phase 1 audit). AUTH-03 is auto-satisfied.

3. Commit:
   ```bash
   git add src/middleware.ts
   git commit -m "feat(02-02): add middleware for route protection"
   ```
  </action>
  <verify>
```bash
ls src/middleware.ts
grep "updateSession" src/middleware.ts
grep "matcher" src/middleware.ts
grep "_next/static" src/middleware.ts
```
All commands must succeed.
  </verify>
  <done>
src/middleware.ts exists with matcher config excluding static assets. It imports and delegates to updateSession from src/lib/supabase/middleware.ts. All routes are protected by default; /login is handled by the updateSession logic (redirect unauthenticated to /login, redirect authenticated away from /login to /).
  </done>
</task>

</tasks>

<verification>
- `src/app/login/page.tsx` renders a form with email and password inputs
- `src/app/login/actions.ts` exports `login` and `logout` Server Actions
- `login` action uses `signInWithPassword` and redirects to `/` on success or `/login?error=...` on failure
- `logout` action calls `signOut()` and redirects to `/login`
- `src/middleware.ts` imports `updateSession` and has a matcher that excludes static assets
- No 'use client' directive in login page (Server Component)
- `await searchParams` used for Next.js 15 async searchParams
</verification>

<success_criteria>
The login page exists at /login with email and password fields. Submitting the form calls the login Server Action which authenticates with Supabase. The middleware intercepts all non-static requests and redirects unauthenticated users to /login. The logout Server Action signs out and redirects to /login.
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>
