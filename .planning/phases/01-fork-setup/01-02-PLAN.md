---
phase: 01-fork-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Router type is confirmed as App Router with evidence"
    - "Every process.env read of PHONE_NUMBER_ID, KAPSO_API_KEY, WABA_ID, and WHATSAPP_API_URL is listed with exact file path and line number"
    - "The webhook endpoint situation is resolved — documented as 'no webhook, uses polling'"
    - "Every API route file is cataloged with its HTTP method and purpose"
  artifacts:
    - path: ".planning/phases/01-fork-setup/01-02-SUMMARY.md"
      provides: "Audit results with exact line numbers and confirmed architecture"
  key_links: []
---

<objective>
Audit the Kapso codebase to produce exact-line-number maps of all process.env reads, confirm the router type, catalog the API route structure, and document the webhook/polling architecture.

Purpose: This audit resolves every architectural unknown blocking Phase 2+ planning. After this plan, no architecture decisions are conditional.
Output: Audit data captured in the plan summary — exact file paths, line numbers, and architectural confirmations.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fork-setup/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit router type, API routes, and polling architecture</name>
  <files>(read-only audit — no files modified)</files>
  <action>
This is a READ-ONLY audit. No files are created or modified. All findings go into the plan SUMMARY.

**1. Confirm Router Type:**

Check for App Router evidence:
```bash
ls src/app/layout.tsx    # App Router indicator
ls src/pages/ 2>/dev/null  # Should NOT exist (Pages Router indicator)
```
Read `src/app/layout.tsx` and confirm it follows App Router conventions (exports `default function RootLayout`, has `children` prop, wraps in `<html>`/`<body>`).

**2. Catalog All API Routes:**

Find every `route.ts` file under `src/app/api/`:
```bash
find src/app/api -name "route.ts" -type f
```

For each route file, read it and record:
- Full file path
- HTTP methods exported (GET, POST, PUT, DELETE, PATCH)
- What it does (1-line description)
- Whether it imports from `@/lib/whatsapp-client`
- Whether it reads `process.env` directly

Expected routes (from research — verify against actual files):
- `src/app/api/conversations/route.ts` — GET conversations
- `src/app/api/messages/[conversationId]/route.ts` — GET messages
- `src/app/api/messages/send/route.ts` — POST send message
- `src/app/api/messages/interactive/route.ts` — POST send interactive message
- `src/app/api/templates/route.ts` — GET templates
- `src/app/api/templates/send/route.ts` — POST send template
- `src/app/api/media/[mediaId]/route.ts` — GET media

**3. Confirm No Webhook Endpoint:**

Search for any webhook-related code:
```bash
grep -r "webhook" src/ --include="*.ts" --include="*.tsx" -l
grep -r "POST.*webhook\|webhook.*POST" src/ --include="*.ts" --include="*.tsx" -l
```

Read `src/hooks/use-auto-polling.ts` and confirm the polling pattern (setInterval or setTimeout based fetching).

Document: "The app uses client-side auto-polling via `use-auto-polling.ts`. There is NO inbound webhook endpoint. The app does not receive push notifications from Meta/WhatsApp."

**4. Record All Findings:**

Collect all findings for the plan SUMMARY. The summary must include:
- Router type: App Router (CONFIRMED) with evidence
- Complete API route table (path, method, purpose, imports)
- Polling architecture description
- Webhook status: "No webhook endpoint exists"
  </action>
  <verify>
All verification is observational:
- `ls src/app/layout.tsx` confirms App Router
- `ls src/pages/ 2>/dev/null` returns nothing (no Pages Router)
- `find src/app/api -name "route.ts" | wc -l` returns 7 (or the actual count — verify)
- `grep -r "webhook" src/ --include="*.ts" --include="*.tsx" -l` returns 0 matches (or only false positives like comments)
  </verify>
  <done>
Router type confirmed as App Router. All API routes cataloged with methods and purposes. Webhook status confirmed as "no webhook — polling-based architecture." All findings documented in SUMMARY.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit all process.env reads with exact line numbers</name>
  <files>(read-only audit — no files modified)</files>
  <action>
Search the entire codebase for every `process.env` reference. This must be exhaustive — no env var read can be missed.

**1. Find ALL process.env reads:**

```bash
grep -rn "process\.env" src/ --include="*.ts" --include="*.tsx"
```

This will return every file + line number where `process.env` appears.

**2. For each match, record:**
- Exact file path
- Exact line number
- Variable name being read
- How it's used (exported constant, local variable, required check, optional with default)
- Whether it's a critical credential (PHONE_NUMBER_ID, KAPSO_API_KEY, WABA_ID) or infrastructure config (WHATSAPP_API_URL)

**3. Cross-reference with research expectations:**

Research predicts these reads:
| File | Variable |
|------|----------|
| `src/lib/whatsapp-client.ts` | `PHONE_NUMBER_ID` |
| `src/lib/whatsapp-client.ts` | `KAPSO_API_KEY` |
| `src/lib/whatsapp-client.ts` | `WHATSAPP_API_URL` |
| `src/app/api/templates/route.ts` | `WABA_ID` |

If grep finds ANY additional process.env reads not in this list, flag them as NEW FINDINGS. These would be important for Phase 4 (config migration).

**4. Map import chain for PHONE_NUMBER_ID:**

Identify every file that imports `PHONE_NUMBER_ID` from `@/lib/whatsapp-client`:
```bash
grep -rn "PHONE_NUMBER_ID" src/ --include="*.ts" --include="*.tsx"
```

Record which files use this constant. These files don't read process.env directly but are part of the dependency chain that Phase 4 must consider.

**5. Map import chain for whatsappClient:**

```bash
grep -rn "whatsappClient" src/ --include="*.ts" --include="*.tsx"
```

Record all consumers. These are the files that use the initialized SDK client.

**6. Produce the complete audit table:**

Format the findings as a table with columns:
- File path
- Line number
- Variable
- Read type (direct process.env | import from whatsapp-client)
- Usage (exported constant | required check | optional default | SDK init)

This table is the PRIMARY deliverable of this plan. It must be complete and exact.
  </action>
  <verify>
```bash
# Verify completeness: count total process.env reads
grep -rn "process\.env" src/ --include="*.ts" --include="*.tsx" | wc -l
# This count must match the number of rows in the audit table for direct reads

# Verify no stray reads outside src/
grep -rn "process\.env" . --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next | grep -v "src/"
# This should return 0 results (no process.env reads outside src/)
```
  </verify>
  <done>
Every `process.env` read in the codebase is documented with exact file path, line number, variable name, and usage pattern. The import chains for `PHONE_NUMBER_ID` and `whatsappClient` are fully mapped. Any unexpected env var reads are flagged.
  </done>
</task>

</tasks>

<verification>
- Router type documented as App Router with at least 2 pieces of evidence
- All API route files found and cataloged (expect ~7 routes)
- Webhook status confirmed (expect: no webhook)
- Polling mechanism identified and described
- Every `process.env` read has exact line number
- Import chains for PHONE_NUMBER_ID and whatsappClient are complete
- No unexpected process.env reads are silently missed
</verification>

<success_criteria>
The audit produces a complete, exact-line-number map of every process.env read and every file that consumes credentials through imports. The router type, API route structure, and webhook/polling architecture are confirmed with evidence. All findings are documented in the plan SUMMARY ready for use by Plan 01-03.
</success_criteria>

<output>
After completion, create `.planning/phases/01-fork-setup/01-02-SUMMARY.md`

The SUMMARY must include these sections:
1. **Router Type** — confirmed type with evidence
2. **API Route Catalog** — table of all routes with method, purpose, imports
3. **process.env Audit Table** — exact file, line, variable, usage for every direct read
4. **Import Chain Map** — every file importing PHONE_NUMBER_ID or whatsappClient
5. **Webhook/Polling Architecture** — confirmed status with evidence
6. **Unexpected Findings** — any deviations from research predictions (or "None")
</output>
