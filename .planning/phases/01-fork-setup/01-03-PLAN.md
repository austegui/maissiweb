---
phase: 01-fork-setup
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - .planning/phases/01-fork-setup/AUDIT.md
  - .planning/STATE.md
autonomous: true

must_haves:
  truths:
    - "gokapso/whatsapp-cloud-inbox is configured as the upstream git remote"
    - "A consolidated AUDIT.md exists with all Phase 1 findings"
    - "STATE.md is updated to reflect Phase 1 blockers are resolved"
    - "All five Phase 1 success criteria are satisfied and documented"
  artifacts:
    - path: ".planning/phases/01-fork-setup/AUDIT.md"
      provides: "Consolidated audit document for Phase 2+ reference"
      contains: "process.env"
    - path: ".planning/STATE.md"
      provides: "Updated project state reflecting Phase 1 completion"
      contains: "Phase 1"
  key_links:
    - from: ".planning/phases/01-fork-setup/AUDIT.md"
      to: ".planning/phases/01-fork-setup/01-02-SUMMARY.md"
      via: "Consolidates audit data from 01-02 summary"
      pattern: "process\\.env"
---

<objective>
Verify the upstream git remote is correctly configured, create a consolidated AUDIT.md with all Phase 1 findings, and update STATE.md to reflect that all Phase 1 blockers are resolved.

Purpose: This plan closes out Phase 1 by producing the reference document that all subsequent phases will use for architectural decisions and file targeting. It also clears the blockers that were gating Phase 2+ planning.
Output: AUDIT.md (consolidated reference), updated STATE.md, verified upstream remote.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fork-setup/01-RESEARCH.md
@.planning/phases/01-fork-setup/01-01-SUMMARY.md
@.planning/phases/01-fork-setup/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify upstream remote and fetch</name>
  <files>(git config only — no files modified)</files>
  <action>
Plan 01-01 already added the upstream remote as part of the merge strategy. Verify it is correctly configured and fetch the latest.

1. Check the remote exists and points to the correct URL:
   ```bash
   git remote -v
   ```
   Expected output must include:
   ```
   upstream  https://github.com/gokapso/whatsapp-cloud-inbox.git (fetch)
   upstream  https://github.com/gokapso/whatsapp-cloud-inbox.git (push)
   ```

2. Fetch upstream to ensure it's reachable:
   ```bash
   git fetch upstream
   ```

3. Verify upstream/main exists:
   ```bash
   git branch -r | grep upstream/main
   ```

If the upstream remote is NOT configured (e.g., 01-01 used a different approach), add it now:
```bash
git remote add upstream https://github.com/gokapso/whatsapp-cloud-inbox.git
git fetch upstream
```

This satisfies requirement FORK-03: "Set gokapso/whatsapp-cloud-inbox as upstream git remote for future merge capability."
  </action>
  <verify>
```bash
git remote get-url upstream  # Must return https://github.com/gokapso/whatsapp-cloud-inbox.git
git branch -r | grep upstream/main  # Must show upstream/main
```
  </verify>
  <done>
The upstream remote is configured, reachable, and upstream/main is tracked. Future upstream merges can be done with `git fetch upstream && git merge upstream/main`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create consolidated AUDIT.md</name>
  <files>.planning/phases/01-fork-setup/AUDIT.md</files>
  <action>
Read the 01-02-SUMMARY.md to extract all audit findings. Consolidate into a single AUDIT.md reference document that later phases can @-reference.

Create `.planning/phases/01-fork-setup/AUDIT.md` with this structure:

```markdown
# Phase 1 Audit: Kapso WhatsApp Cloud Inbox

**Audited:** [date]
**Source:** gokapso/whatsapp-cloud-inbox (merged into kapsoweb)
**Confidence:** HIGH (verified from local source)

## Router Type

**App Router** (Next.js 15)

Evidence:
- `src/app/layout.tsx` exists — App Router root layout
- `src/pages/` does NOT exist — no Pages Router
- API routes use `src/app/api/*/route.ts` pattern

Implication: All new routes in Phase 2+ use App Router conventions (route.ts files, Server Components, `use client` directives).

## API Route Structure

| Route | Method | Purpose | Imports from whatsapp-client |
|-------|--------|---------|------------------------------|
[populate from 01-02 SUMMARY data]

## process.env Reads (Direct)

| File | Line | Variable | Usage |
|------|------|----------|-------|
[populate from 01-02 SUMMARY — exact line numbers]

## process.env Reads (Via Import)

| File | Imports | From |
|------|---------|------|
[populate from 01-02 SUMMARY — import chain]

## Webhook / Real-time Architecture

**No webhook endpoint.** The app uses client-side polling via `src/hooks/use-auto-polling.ts`.

[describe the polling mechanism from 01-02 SUMMARY]

Implication for Phase 2: AUTH-03 says "WhatsApp webhook endpoint remains publicly accessible." Since there IS no webhook endpoint, this requirement is automatically satisfied — no middleware whitelist needed for webhooks.

## Phase 2+ Impact Summary

### Files to modify in Phase 4 (Config Migration)
- `src/lib/whatsapp-client.ts` — primary target (PHONE_NUMBER_ID, KAPSO_API_KEY, WHATSAPP_API_URL)
- `src/app/api/templates/route.ts` — secondary target (WABA_ID)

### Middleware placement for Phase 2 (Authentication)
- Middleware goes in `src/middleware.ts` (App Router convention)
- Must protect: `/` and all `/api/*` routes
- Must exclude: `/login` (new page in Phase 2)
- No webhook to exclude (polling architecture)

### New files for Phase 3 (Admin Settings)
- `src/app/admin/settings/page.tsx` — new admin page
- `src/app/api/settings/route.ts` — new API route
- `src/lib/get-config.ts` — new utility (replaces process.env reads)
```

Populate ALL data from 01-02-SUMMARY.md. Do not invent data — use only what the audit found. If the audit found unexpected findings, include them in an "Unexpected Findings" section.
  </action>
  <verify>
```bash
ls .planning/phases/01-fork-setup/AUDIT.md  # Must exist
grep -c "process.env" .planning/phases/01-fork-setup/AUDIT.md  # Should be > 0
grep "App Router" .planning/phases/01-fork-setup/AUDIT.md  # Must confirm router type
grep "WABA_ID" .planning/phases/01-fork-setup/AUDIT.md  # Must include all env vars
grep "PHONE_NUMBER_ID" .planning/phases/01-fork-setup/AUDIT.md
grep "KAPSO_API_KEY" .planning/phases/01-fork-setup/AUDIT.md
```
  </verify>
  <done>
AUDIT.md exists with complete, accurate data from the 01-02 audit. All process.env reads are listed with line numbers. Router type, API routes, and webhook status are documented. Phase 2+ impact summary provides clear guidance for future plans.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update STATE.md to close Phase 1 blockers</name>
  <files>.planning/STATE.md</files>
  <action>
Read the current `.planning/STATE.md` and update it to reflect Phase 1 progress.

Changes:
1. **Blockers/Concerns section** — resolve the two blockers:
   - "[Phase 1]: Kapso router type unknown" → RESOLVED: App Router confirmed
   - "[Phase 1]: Webhook path unknown" → RESOLVED: No webhook — polling architecture

2. **Decisions section** — add the confirmed decisions:
   - "[Phase 1 Audit]: Router type is App Router — all Phase 2+ work uses App Router conventions"
   - "[Phase 1 Audit]: No webhook endpoint exists — app uses polling via use-auto-polling.ts — AUTH-03 webhook exclusion is N/A"
   - "[Phase 1 Audit]: process.env reads concentrated in 2 files — src/lib/whatsapp-client.ts and src/app/api/templates/route.ts"

3. **Current Position** — update to reflect plans completed:
   - Plan: "3 of 3 in current phase"
   - Status: "Phase 1 complete"

4. **Session Continuity** — update stopped-at:
   - "Phase 1 complete — AUDIT.md created — ready to plan Phase 2"
  </action>
  <verify>
```bash
grep "RESOLVED" .planning/STATE.md  # Should show resolved blockers
grep "App Router" .planning/STATE.md  # Should confirm router decision
grep "Phase 1 complete" .planning/STATE.md || grep "3 of 3" .planning/STATE.md  # Should show phase completion
```
  </verify>
  <done>
STATE.md reflects Phase 1 completion. Both blockers are resolved. Decisions are logged. The project state is ready for Phase 2 planning.
  </done>
</task>

</tasks>

<verification>
Phase 1 Success Criteria (from ROADMAP.md):
1. "The app runs locally and the WhatsApp inbox UI loads in the browser" — Confirmed in 01-01 checkpoint
2. "The router type is documented" — Confirmed in AUDIT.md (App Router)
3. "Every file that reads PHONE_NUMBER_ID, KAPSO_API_KEY, or WABA_ID from process.env is listed with line numbers" — Confirmed in AUDIT.md
4. "The webhook endpoint path is confirmed and documented" — Confirmed in AUDIT.md (no webhook — polling)
5. "gokapso/whatsapp-cloud-inbox is set as upstream git remote" — Confirmed via `git remote -v`
</verification>

<success_criteria>
The upstream remote is verified. AUDIT.md consolidates all Phase 1 findings into a single reference document. STATE.md reflects that Phase 1 is complete with both blockers resolved. All five Phase 1 success criteria from the roadmap are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/01-fork-setup/01-03-SUMMARY.md`
</output>
