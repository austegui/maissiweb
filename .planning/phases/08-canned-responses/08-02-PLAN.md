---
phase: 08-canned-responses
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/admin/canned-responses/page.tsx
  - src/app/admin/canned-responses/CannedResponsesManager.tsx
  - src/app/admin/canned-responses/actions.ts
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "An admin can create a new canned response with title, shortcut, and body from /admin/canned-responses"
    - "An admin can edit any existing canned response"
    - "An admin can delete any existing canned response"
    - "An agent cannot access /admin/canned-responses (redirected by existing admin layout guard)"
    - "A 'Canned Responses' link is visible in the inbox header for navigation"
  artifacts:
    - path: "src/app/admin/canned-responses/actions.ts"
      provides: "Server Actions for create, update, delete"
      exports: ["createCannedResponse", "updateCannedResponse", "deleteCannedResponse"]
    - path: "src/app/admin/canned-responses/page.tsx"
      provides: "Server Component that fetches and displays canned responses"
      contains: "CannedResponsesManager"
    - path: "src/app/admin/canned-responses/CannedResponsesManager.tsx"
      provides: "Client Component for CRUD UI with forms and list"
      contains: "use client"
    - path: "src/app/page.tsx"
      provides: "Navigation link to /admin/canned-responses"
      contains: "canned-responses"
  key_links:
    - from: "src/app/admin/canned-responses/CannedResponsesManager.tsx"
      to: "src/app/admin/canned-responses/actions.ts"
      via: "useActionState + form action"
      pattern: "useActionState.*createCannedResponse"
    - from: "src/app/admin/canned-responses/page.tsx"
      to: "supabase.from('canned_responses')"
      via: "server-side Supabase query"
      pattern: "from.*canned_responses"
    - from: "src/app/page.tsx"
      to: "/admin/canned-responses"
      via: "anchor tag href"
      pattern: "admin/canned-responses"
---

<objective>
Build the admin CRUD page for managing canned responses at /admin/canned-responses.

Purpose: Admins need to create, edit, and delete canned responses that agents will use in conversations. This satisfies CANNED-01, CANNED-05, and contributes to CANNED-04 (team-shared via Supabase).
Output: A working admin page with full CRUD and a navigation link from the inbox header.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-canned-responses/08-RESEARCH.md
@src/app/admin/settings/actions.ts
@src/app/admin/settings/page.tsx
@src/app/admin/settings/SettingsForm.tsx
@src/app/admin/layout.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Actions and admin page for canned responses CRUD</name>
  <files>
    src/app/admin/canned-responses/actions.ts
    src/app/admin/canned-responses/page.tsx
    src/app/admin/canned-responses/CannedResponsesManager.tsx
  </files>
  <action>
Create three files following the exact pattern from /admin/settings/:

**actions.ts** -- Server Actions with 'use server' directive:
- `createCannedResponse(_prevState: ActionResult, formData: FormData): Promise<ActionResult>` -- validates title, shortcut, body are non-empty strings, inserts into canned_responses, calls revalidatePath('/admin/canned-responses'). If Supabase returns error with "duplicate key" or "unique" in message, return user-friendly "A canned response with this shortcut already exists".
- `updateCannedResponse(id: string, _prevState: ActionResult, formData: FormData): Promise<ActionResult>` -- validates same fields, updates row by id, sets updated_at to new Date().toISOString(), calls revalidatePath.
- `deleteCannedResponse(id: string): Promise<ActionResult>` -- deletes row by id, calls revalidatePath. NOT a form action -- called directly via startTransition.
- Export type `ActionResult = { success: boolean; message: string }`.
- All three check auth via `supabase.auth.getUser()` and return Unauthorized if no user. RLS handles the admin enforcement at DB level, but the auth check prevents anonymous access.

**page.tsx** -- Server Component:
- Fetches all canned_responses sorted by shortcut ascending from Supabase.
- Renders heading "Canned Responses", a "Back to inbox" Link to "/", and passes rows to CannedResponsesManager.
- Follow the exact layout pattern from admin/settings/page.tsx (max-w-2xl instead of max-w-lg since the table needs more width).

**CannedResponsesManager.tsx** -- Client Component ('use client'):
- Props: `initialResponses: Array<{ id: string; title: string; shortcut: string; body: string }>`.
- Two modes: list view (default) and form view (create/edit).
- List view: Renders each canned response as a card/row showing shortcut (with `/` prefix, styled green mono), title, and a preview of body (truncated to ~80 chars). Each row has Edit and Delete buttons (use lucide-react Pencil and Trash2 icons).
- "Add New" button at the top triggers form view in create mode.
- Form view: Three fields -- Title (input), Shortcut (input, no `/` prefix -- stored without it), Body (textarea, 4 rows). Submit and Cancel buttons. Uses useActionState for create/update.
- For create: `useActionState(createCannedResponse, initialState)`.
- For edit: `useActionState(updateCannedResponse.bind(null, editingId), initialState)`. Pre-fill form fields with existing values using defaultValue on a keyed form (key={editingId} to reset form state).
- For delete: `useTransition()` + `startTransition(() => deleteCannedResponse(item.id))`. Add a `window.confirm('Delete this canned response?')` guard before calling.
- On successful create/update (state.success === true), switch back to list view. Use a useEffect watching state.success to trigger this.
- Display state.message below the form (green for success, red for error), same pattern as SettingsForm.
- Use Tailwind classes consistent with existing admin pages. No Radix Dialog needed -- inline form view is simpler and sufficient.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Check that all three files exist and follow the established patterns.
  </verify>
  <done>
The /admin/canned-responses page renders a list of canned responses with create, edit, and delete functionality using Server Actions. The page is protected by the existing admin/layout.tsx guard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Canned Responses navigation link to inbox header</name>
  <files>src/app/page.tsx</files>
  <action>
In src/app/page.tsx, add a "Canned Responses" link alongside the existing "Settings" link in the header navigation.

In the `<div className="flex items-center gap-3">` section, add before the Settings link:
```tsx
<a href="/admin/canned-responses" className="text-xs text-gray-500 hover:text-gray-700">
  Canned Responses
</a>
```

This link will only work for admins (agents get redirected by admin/layout.tsx). The link is visible to all users but only admins can access the destination -- this is the same pattern as the existing Settings link.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Visually confirm the link appears in the header alongside Settings.
  </verify>
  <done>
The inbox header shows a "Canned Responses" link that navigates to /admin/canned-responses.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- /admin/canned-responses page loads and shows empty state or list
- Create form appears when clicking "Add New"
- Navigation link visible in inbox header
- Existing admin/layout.tsx guard protects the new page (no extra auth code needed)
</verification>

<success_criteria>
An admin can navigate to /admin/canned-responses, create a new canned response with title/shortcut/body, see it in the list, edit it, and delete it. All Server Actions use revalidatePath to refresh data. The admin layout guard prevents agent access.
</success_criteria>

<output>
After completion, create `.planning/phases/08-canned-responses/08-02-SUMMARY.md`
</output>
