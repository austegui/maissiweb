---
phase: 08-canned-responses
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/canned-responses-picker.tsx
  - src/app/api/canned-responses/route.ts
  - src/components/message-view.tsx
autonomous: true

must_haves:
  truths:
    - "An agent typing '/' as the first character in the message input sees a filterable dropdown of canned responses"
    - "The dropdown filters as the agent types after the '/' character"
    - "Selecting a canned response inserts its body text into the message input, replacing the slash command"
    - "The dropdown does NOT appear when '/' is typed mid-sentence"
    - "Pressing Escape closes the dropdown"
    - "All agents see the same shared library of canned responses"
  artifacts:
    - path: "src/app/api/canned-responses/route.ts"
      provides: "GET endpoint returning all canned responses for authenticated users"
      exports: ["GET"]
    - path: "src/components/canned-responses-picker.tsx"
      provides: "Slash-command picker UI using cmdk"
      exports: ["CannedResponsesPicker"]
    - path: "src/components/message-view.tsx"
      provides: "Modified message view with slash-command picker integration"
      contains: "CannedResponsesPicker"
  key_links:
    - from: "src/components/canned-responses-picker.tsx"
      to: "/api/canned-responses"
      via: "fetch in useEffect"
      pattern: "fetch.*api/canned-responses"
    - from: "src/components/message-view.tsx"
      to: "src/components/canned-responses-picker.tsx"
      via: "import and conditional render"
      pattern: "showCannedPicker.*CannedResponsesPicker"
    - from: "src/app/api/canned-responses/route.ts"
      to: "supabase.from('canned_responses')"
      via: "Supabase query"
      pattern: "from.*canned_responses"
---

<objective>
Build the agent-facing slash-command picker that lets agents type `/` to search and insert canned responses into the message input.

Purpose: This is the core productivity feature -- agents can instantly insert pre-written replies without typing them out. Satisfies CANNED-02, CANNED-03, and CANNED-04 (shared library via Supabase).
Output: A working slash-command picker integrated into the message-view, powered by cmdk and a GET API route.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-canned-responses/08-RESEARCH.md
@src/components/message-view.tsx
@src/app/api/settings/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cmdk and create API route + picker component</name>
  <files>
    src/app/api/canned-responses/route.ts
    src/components/canned-responses-picker.tsx
  </files>
  <action>
**Step 1: Install cmdk**
Run `npm install cmdk` to add the command palette library. Verify it appears in package.json.

**Step 2: Create GET /api/canned-responses route**
Create `src/app/api/canned-responses/route.ts` following the exact pattern from `src/app/api/settings/route.ts`:
- Export async function GET().
- Create Supabase client, check auth via getUser(), return 401 if no user.
- Query `supabase.from('canned_responses').select('id, title, shortcut, body').order('shortcut', { ascending: true })`.
- Return `NextResponse.json({ data })` on success, `NextResponse.json({ error: error.message }, { status: 500 })` on error.

**Step 3: Create CannedResponsesPicker component**
Create `src/components/canned-responses-picker.tsx` as a 'use client' component:

Props: `{ query: string; onSelect: (body: string) => void; onClose: () => void }`

Type: `CannedResponse = { id: string; title: string; shortcut: string; body: string }`

Behavior:
- On mount, fetch `/api/canned-responses` once and store in state. Filter client-side (dataset is small).
- Filter responses where `shortcut` or `title` contains the query (case-insensitive).
- If filtered list is empty and not loading, return null (no empty dropdown).
- Render using cmdk: `<Command><Command.List>` with `<Command.Item>` for each filtered response.
- Each item shows `/{shortcut}` (green mono text) and title (truncated).
- On item select (cmdk's onSelect): call `onSelect(response.body)` then `onClose()`.
- Position: absolute, bottom: 100%, left: 0, right: 0. This makes it appear ABOVE the message input.
- Style: white background, border, rounded-lg, shadow-lg, max-h-64 with overflow-hidden.
- Use Tailwind class `[&[aria-selected=true]]:bg-[#f0f2f5]` on Command.Item for keyboard highlight.
- Loading state: show "Loading..." text via Command.Loading.

IMPORTANT: Do NOT use Radix Popover. The picker uses absolute CSS positioning to avoid focus theft from the input.
IMPORTANT: `Command.List` MUST be a child of `Command` (cmdk 1.x requirement).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Check that cmdk is in package.json dependencies. Verify both files exist.
  </verify>
  <done>
The API route returns canned responses for authenticated users, and the picker component renders a filterable cmdk list positioned above the input.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate slash-command picker into message-view.tsx</name>
  <files>src/components/message-view.tsx</files>
  <action>
Modify `src/components/message-view.tsx` to integrate the CannedResponsesPicker. Changes are minimal and surgical:

**1. Add import at the top:**
```typescript
import { CannedResponsesPicker } from '@/components/canned-responses-picker'
```

**2. Add state variables** (after existing useState declarations around line 129-136):
```typescript
const [showCannedPicker, setShowCannedPicker] = useState(false)
const [cannedQuery, setCannedQuery] = useState('')
```

**3. Create handler functions** (after handleRemoveFile, around line 272):
```typescript
const handleMessageInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const value = e.target.value
  setMessageInput(value)
  if (value[0] === '/') {
    setShowCannedPicker(true)
    setCannedQuery(value.slice(1))
  } else {
    setShowCannedPicker(false)
    setCannedQuery('')
  }
}

const handleCannedSelect = (body: string) => {
  setMessageInput(body)
  setShowCannedPicker(false)
  setCannedQuery('')
}
```

**4. Modify the Input element** (around line 622-629):
Replace the existing `onChange={(e) => setMessageInput(e.target.value)}` with `onChange={handleMessageInputChange}`.
Add onKeyDown handler to dismiss picker on Escape:
```typescript
onKeyDown={(e) => {
  if (e.key === 'Escape' && showCannedPicker) {
    e.preventDefault()
    setShowCannedPicker(false)
    setCannedQuery('')
  }
}}
```

**5. Wrap the form area with position: relative and add picker:**
Find the `<form onSubmit={handleSendMessage}` element (around line 592). Wrap the form in a `<div className="relative">` and place the CannedResponsesPicker BEFORE the form inside this div:
```tsx
<div className="relative">
  {showCannedPicker && (
    <CannedResponsesPicker
      query={cannedQuery}
      onSelect={handleCannedSelect}
      onClose={() => { setShowCannedPicker(false); setCannedQuery('') }}
    />
  )}
  <form onSubmit={handleSendMessage} className="p-3 max-w-[900px] mx-auto w-full flex gap-2 items-center">
    {/* ... existing form contents ... */}
  </form>
</div>
```

**6. Also dismiss picker on form submit** -- in handleSendMessage (around line 274), add at the beginning after the early return:
```typescript
setShowCannedPicker(false)
setCannedQuery('')
```

IMPORTANT: Only trigger the picker when '/' is the FIRST character (`value[0] === '/'`), NOT when '/' appears anywhere in the text. This prevents false triggers on URLs, dates, etc.
IMPORTANT: `handleCannedSelect` replaces the entire input with the response body -- it does NOT append. This ensures no leftover `/shortcut` text.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Review the diff to confirm:
1. The picker only shows when input starts with '/'
2. Selecting an item replaces the full input with the response body
3. Escape dismisses the picker
4. The form submit clears the picker state
5. The relative/absolute positioning is correct (picker above input)
  </verify>
  <done>
Typing '/' in the message input shows the canned responses picker above the input. The dropdown filters as the agent types. Selecting a response inserts its body text into the input, replacing the slash command. Escape closes the dropdown. The picker does not appear for '/' characters mid-sentence.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm ls cmdk` shows cmdk installed
- GET /api/canned-responses returns JSON with canned responses for authenticated users
- Typing '/' in message input shows the picker dropdown above the input
- Typing '/ho' filters the list to matching shortcuts/titles
- Selecting an item replaces the input text with the canned response body
- Typing '/' mid-sentence (e.g., "call 9am/5pm") does NOT trigger the picker
- Pressing Escape closes the picker
</verification>

<success_criteria>
An agent can type '/' in the message input to see all available canned responses, filter by typing more characters, select one to insert its text, and send it as a normal message. The feature works for all authenticated users since canned_responses has SELECT access for all authenticated roles.
</success_criteria>

<output>
After completion, create `.planning/phases/08-canned-responses/08-03-SUMMARY.md`
</output>
